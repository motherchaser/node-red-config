[{"id":"eee3c0c3.7c7bd","type":"tab","label":"Lighting","disabled":false,"info":""},{"id":"38894af.7ca61b6","type":"tab","label":"Safety/Security","disabled":false,"info":""},{"id":"cb6f2b8f.2124b8","type":"tab","label":"Presence","disabled":false,"info":""},{"id":"3e9522c6.d11e1e","type":"tab","label":"Cameras","disabled":false,"info":""},{"id":"30c7e5fd.18228a","type":"tab","label":"Comfort","disabled":false,"info":""},{"id":"b55ab74c.698a88","type":"tab","label":"Kids","disabled":false,"info":""},{"id":"90be6c3f.6407","type":"tab","label":"Notifications","disabled":false,"info":""},{"id":"51c810f0.59ce1","type":"tab","label":"iOS Push Actions","disabled":false,"info":""},{"id":"47267ef8.fca6f","type":"tab","label":"Media","disabled":false,"info":""},{"id":"2061740e.e5207c","type":"tab","label":"Playground","disabled":false,"info":""},{"id":"76250bd8.6dba94","type":"tab","label":"Alexa Flows","disabled":false,"info":""},{"id":"97047d3e.e8278","type":"tab","label":"Moccupancy","disabled":false,"info":""},{"id":"8d45d5f6.f088e8","type":"tab","label":"Christmas Lights","disabled":true,"info":""},{"id":"144427d5.6c9f18","type":"server","z":"","name":"Home Assistant","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open"},{"id":"1f84a57d.10775b","type":"mqtt-broker","z":"","name":"","broker":"10.7.7.100","port":"1883","clientid":"NodeRed","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"9dba4206.297ed","type":"light-scheduler-settings","z":"","name":"Scheduler Settings","latitude":"35.6946918","longitude":"-88.8753785"},{"id":"210f3ca0.f0ec14","type":"schedex","z":"eee3c0c3.7c7bd","name":"Porch Light Trigger","suspended":false,"lat":"35.6145","lon":"-88.8139","ontime":"dusk","ontopic":"","onpayload":"turn_on","onoffset":"-30","onrandomoffset":false,"offtime":"22:30","offtopic":"","offpayload":"turn_off","offoffset":"-15","offrandomoffset":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"sun":true,"x":410,"y":120,"wires":[["8d49cec5.ef4d9"]]},{"id":"b2259c64.157f7","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Porch Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"","data":"{\"entity_id\": \"switch.front_porch_light, switch.side_entry_porch_light, switch.garage_outside_light\"}","mergecontext":"","x":830,"y":120,"wires":[[]]},{"id":"9a045e11.88105","type":"inject","z":"eee3c0c3.7c7bd","name":"All Porch Lights Off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":140,"wires":[["210f3ca0.f0ec14"]]},{"id":"d03c0d74.35482","type":"inject","z":"eee3c0c3.7c7bd","name":"All Porch Lights On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":100,"wires":[["210f3ca0.f0ec14"]]},{"id":"c7977616.dfcab8","type":"comment","z":"eee3c0c3.7c7bd","name":"Porch Lights @ Dusk","info":"","x":170,"y":60,"wires":[]},{"id":"8d49cec5.ef4d9","type":"function","z":"eee3c0c3.7c7bd","name":"Select Service","func":"// Trigger doesn't support objects on \n// payload so we move the value provided \n// on msg.payload into msg.service property\n// to be used by the porch light service\n\nmsg.payload = {\n    service: msg.payload\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":120,"wires":[["b2259c64.157f7"]]},{"id":"79f23994.f55e88","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Motion","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.kitchen_motion","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":160,"y":300,"wires":[["fd97ed5c.f14d3"]]},{"id":"a7d89183.b3723","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Off","server":"144427d5.6c9f18","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.kitchen_can_lights\"}","mergecontext":"","x":1130,"y":380,"wires":[[]]},{"id":"8417a2fb.440b1","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Switch Flipped On","server":"144427d5.6c9f18","entityidfilter":"light.kitchen_can_lights","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":190,"y":360,"wires":[["637cd091.0fbe3"],[]]},{"id":"2f7566a7.1942ba","type":"comment","z":"eee3c0c3.7c7bd","name":"Kitchen Can Lights","info":"","x":170,"y":240,"wires":[]},{"id":"6007cb34.ee1bb4","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Switch Flipped On","server":"144427d5.6c9f18","entityidfilter":"light.pantry_led","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":170,"y":540,"wires":[["5615982.498e668"],[]]},{"id":"7cc803f5.dd82fc","type":"comment","z":"eee3c0c3.7c7bd","name":"Pantry Shelf LED","info":"","x":160,"y":480,"wires":[]},{"id":"5615982.498e668","type":"stoptimer","z":"eee3c0c3.7c7bd","duration":"5","units":"Minute","payloadtype":"bool","payloadval":"true","name":"5 Minutes","x":420,"y":540,"wires":[[],["48b1fc0f.620214"]]},{"id":"48b1fc0f.620214","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Turn Off Pantry Light","server":"144427d5.6c9f18","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.pantry_led\"}","mergecontext":"","x":680,"y":600,"wires":[[]]},{"id":"ff4c2084.d29e4","type":"server-state-changed","z":"38894af.7ca61b6","name":"Smoke Detected (HASS)","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.smoke_detectors","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"1","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":170,"y":120,"wires":[["4cdd2835.d7e4e8"],[]]},{"id":"7fb24f45.2a33d","type":"function","z":"38894af.7ca61b6","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"SMOKE DETECTED!\",\n            message: \"Call the Fire Department.\",\n            data: {\n                url: 'tel://555-555-5555',\n                push: {\n                    badge: 911,\n                    sound: \"US-EN-Alexa-Smoke-Detected-Generic.wav\"\n                }\n            }\n        }\n    }\n};","outputs":1,"noerr":0,"x":630,"y":180,"wires":[["5e9d1b86.e677f4"]]},{"id":"a76898ba.169aa8","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":180,"wires":[["4cdd2835.d7e4e8"]]},{"id":"8cccfa11.2a8788","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Pantry Door Opened","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.pantry_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":170,"y":660,"wires":[["461ee655.9b46c8"],[]]},{"id":"da6bf586.7c3cf8","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Turn On Pantry Light","server":"144427d5.6c9f18","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.pantry_led\", \"white_value\": 255, \"rgb_color\": [255,255,255], \"transition\": 10}","mergecontext":"","x":680,"y":660,"wires":[[]]},{"id":"a906d294.95b98","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Pantry Door Closed","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.pantry_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":170,"y":600,"wires":[["48b1fc0f.620214"],[]]},{"id":"461ee655.9b46c8","type":"delay","z":"eee3c0c3.7c7bd","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":420,"y":660,"wires":[["da6bf586.7c3cf8"]]},{"id":"decad0fb.3b576","type":"inject","z":"cb6f2b8f.2124b8","name":"Guest Check Every 15 Minutes","topic":"","payload":"","payloadType":"date","repeat":"900","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":140,"wires":[["d5e90594.b099b8"]]},{"id":"e62ce7c1.471048","type":"comment","z":"cb6f2b8f.2124b8","name":"Guest Presence Detection","info":"","x":150,"y":100,"wires":[]},{"id":"a96c033f.d25b3","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Guest Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\": \"input_boolean.guest_mode\"}","mergecontext":"","x":900,"y":140,"wires":[[]]},{"id":"21e8b9b3.0eada6","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Guest Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\": \"input_boolean.guest_mode\"}","mergecontext":"","x":1000,"y":180,"wires":[[]]},{"id":"28d7951a.afb56a","type":"switch","z":"cb6f2b8f.2124b8","name":"hasGuest","property":"payload[0].health[0].num_guest","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":680,"y":160,"wires":[["a96c033f.d25b3"],["368fe191.19c0be"]]},{"id":"b24a295d.c02f98","type":"comment","z":"38894af.7ca61b6","name":"Smoke Detection","info":"","x":140,"y":80,"wires":[]},{"id":"a8664bea.540808","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Away Mode","info":"","x":120,"y":320,"wires":[]},{"id":"bca95b60.f579d8","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"All Devices","server":"144427d5.6c9f18","entityidfilter":"group.all_devices","entityidfiltertype":"exact","outputinitially":true,"haltifstate":"","outputs":1,"x":100,"y":360,"wires":[["fe0b26e5.e10088"]]},{"id":"d0d1c9a1.de7e88","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Away Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\":\"input_boolean.away_mode\"}","mergecontext":"","x":590,"y":340,"wires":[[]]},{"id":"c3993b0a.7bb2a8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Away Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\":\"input_boolean.away_mode\"}","mergecontext":"","x":600,"y":400,"wires":[[]]},{"id":"fe0b26e5.e10088","type":"switch","z":"cb6f2b8f.2124b8","name":"home/not_home","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"not_home","vt":"str"},{"t":"eq","v":"home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":360,"wires":[["d0d1c9a1.de7e88"],["c3993b0a.7bb2a8"]]},{"id":"ce766641.c85848","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","outputs":1,"x":130,"y":360,"wires":[["235f5706.9f8788"]]},{"id":"d0151dc8.e8bb","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"DOOR OPENED WHILE AWAY!\",\n            message: msg.doorName + ' is ' + msg.payload + '.',\n            data: {\n                'thread-id': 'away-door-activity'\n            }\n        }\n    }\n};","outputs":1,"noerr":0,"x":610,"y":360,"wires":[["ce926406.6f9738"]]},{"id":"6887db2b.5d43f4","type":"comment","z":"38894af.7ca61b6","name":"Door/Gate Opened While Away","info":"","x":190,"y":320,"wires":[]},{"id":"235f5706.9f8788","type":"switch","z":"38894af.7ca61b6","name":"Halt If Home","property":"away_mode","propertyType":"global","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":350,"y":360,"wires":[["e18b65fc.e57fd8"]]},{"id":"8bbef984.6ef738","type":"server-events","z":"2061740e.e5207c","name":"All Events","server":"144427d5.6c9f18","x":100,"y":180,"wires":[["362d50fe.dbbed","d669aebc.62cfc"]]},{"id":"362d50fe.dbbed","type":"switch","z":"2061740e.e5207c","name":"Doorbird Motion Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_motion","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":160,"wires":[["be835949.460b78"]]},{"id":"ed45b12d.e4937","type":"comment","z":"2061740e.e5207c","name":"Doorbird Automations","info":"","x":140,"y":100,"wires":[]},{"id":"be835949.460b78","type":"time-range-switch","z":"2061740e.e5207c","name":"isNight","lat":"35.67","lon":"-88.82","startTime":"sunset","endTime":"nightEnd","startOffset":0,"endOffset":0,"x":550,"y":180,"wires":[["9922dd52.4b8be"],[]]},{"id":"37b11c64.75dec4","type":"api-call-service","z":"2061740e.e5207c","name":"Turn On Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_on","data":"{\"entity_id\": \"switch.back_porch_light\"}","mergecontext":"","x":820,"y":180,"wires":[[]]},{"id":"209ca413.76181c","type":"function","z":"2061740e.e5207c","name":"Light Mapper","func":"var map = {\n    doorbird_back_door_motion: \"switch.back_porch_light\",\n    doorbird_back_door_doorbell: \"switch.back_porch_light\",\n    // doorbird_front_door_motion: \"switch.front_porch_light\",\n    doorbird_front_door_doorbell: \"switch.front_porch_light\",\n    // doorbird_side_entry_motion: \"switch.side_entry_porch_light\",\n    doorbird_side_entry_doorbell: \"switch.side_entry_porch_light\",\n}\n\nmsg.data = {\n    entity_id: map[msg.event_type]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":120,"wires":[[]]},{"id":"1e484dd6.47e5e2","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode on Start","info":"","x":150,"y":680,"wires":[]},{"id":"36691f72.d39a6","type":"inject","z":"cb6f2b8f.2124b8","name":"Startup Trigger","topic":"on","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"5","x":120,"y":720,"wires":[["6170f9fa.a46ca8"]]},{"id":"6170f9fa.a46ca8","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Get Bed Status","server":"144427d5.6c9f18","halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"override_payload":true,"override_data":true,"entity_id":"sensor.bed_either","state_type":"str","outputs":1,"x":460,"y":620,"wires":[["de244c23.ff033"]]},{"id":"5999ad4.be98354","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Bed Occupancy","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_either","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":120,"y":820,"wires":[["de244c23.ff033"]]},{"id":"de244c23.ff033","type":"switch","z":"cb6f2b8f.2124b8","name":"isOccupied?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Occupied","vt":"str"},{"t":"eq","v":"Unoccupied","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":430,"y":820,"wires":[["f2a167c9.c302d8"],["f9aadbef.28b4b8"]]},{"id":"49b9a993.3c8bc8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Sleep Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\":\"input_boolean.sleep_mode\"}","mergecontext":"","x":830,"y":780,"wires":[[]]},{"id":"f9aadbef.28b4b8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Sleep Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\":\"input_boolean.sleep_mode\"}","mergecontext":"","x":640,"y":860,"wires":[[]]},{"id":"f2a167c9.c302d8","type":"time-range-switch","z":"cb6f2b8f.2124b8","name":"isBedtime?","lat":"","lon":"","startTime":"22:00","endTime":"7:00","startOffset":0,"endOffset":0,"x":610,"y":780,"wires":[["49b9a993.3c8bc8"],[]]},{"id":"9cbc497d.174bc8","type":"schedex","z":"cb6f2b8f.2124b8","name":"Bedtime Trigger","suspended":false,"lat":"","lon":"","ontime":"22:00","ontopic":"","onpayload":"","onoffset":0,"onrandomoffset":0,"offtime":"goldenHour","offtopic":"","offpayload":"","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"sun":true,"x":120,"y":620,"wires":[["6170f9fa.a46ca8"]]},{"id":"cb69900c.75a75","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode at Bedtime","info":"","x":160,"y":580,"wires":[]},{"id":"ef6b11b5.09a0c","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode on Occupancy","info":"","x":170,"y":780,"wires":[]},{"id":"1ffc80e8.bd10cf","type":"comment","z":"eee3c0c3.7c7bd","name":"Inside Lights @ Bedtime","info":"","x":180,"y":760,"wires":[]},{"id":"bfd530b2.f283a","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Sleep Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"off","outputs":1,"x":170,"y":800,"wires":[["cf3a9398.0b726"]]},{"id":"604733f.ffb9ecc","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Group - Night Lights Off","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_off","data":"{\"entity_id\": \"group.lights_night_off\"}","mergecontext":"","x":710,"y":800,"wires":[[]]},{"id":"a5c6da26.a437e8","type":"server-state-changed","z":"38894af.7ca61b6","name":"Sleep Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"off","outputs":1,"x":150,"y":1020,"wires":[["49b04550.611bec"]]},{"id":"46fe19a8.293148","type":"comment","z":"38894af.7ca61b6","name":"Lock All Doors on Sleep Mode Enable","info":"","x":210,"y":980,"wires":[]},{"id":"e9cddfe6.fa704","type":"comment","z":"38894af.7ca61b6","name":"Lock All Doors on Away Mode Enable","info":"","x":210,"y":1360,"wires":[]},{"id":"35ddcdcd.f3e962","type":"server-state-changed","z":"38894af.7ca61b6","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"exact","outputinitially":false,"haltifstate":"off","outputs":1,"x":150,"y":1400,"wires":[["9dada5c9.04f6f8"]]},{"id":"36ec47a.7ed4bb8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"substring","haltifstate":"off","outputs":1,"x":170,"y":140,"wires":[["25b30fb4.e5f2b"]]},{"id":"25b30fb4.e5f2b","type":"stoptimer","z":"30c7e5fd.18228a","duration":"2","units":"Hour","payloadtype":"num","payloadval":"0","name":"Delay 2h","x":600,"y":140,"wires":[["d15821ae.44ebd","ea54b02e.6a60a"],[]]},{"id":"879bca82.99f6f8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Away Mode Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"substring","haltifstate":"on","outputs":1,"x":180,"y":200,"wires":[["3194a548.bd2f1a","e70c9ec7.f71ee"]]},{"id":"3194a548.bd2f1a","type":"change","z":"30c7e5fd.18228a","name":"Stop Timer","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":180,"wires":[["25b30fb4.e5f2b"]]},{"id":"d15821ae.44ebd","type":"api-call-service","z":"30c7e5fd.18228a","name":"Set Ecobee Away","server":"144427d5.6c9f18","service_domain":"climate","service":"set_away_mode","data":"{\"entity_id\": \"climate.laundry, climate.master\", \"away_mode\": true}","mergecontext":"","x":810,"y":100,"wires":[[]]},{"id":"ea54b02e.6a60a","type":"function","z":"30c7e5fd.18228a","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"Ecobee Away Mode Enabled\",\n            message: \"Save that $$$!\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":790,"y":160,"wires":[["7e577921.85b078"]]},{"id":"3b2f81e8.6beb3e","type":"comment","z":"30c7e5fd.18228a","name":"Enable Ecobee Away Mode","info":"","x":200,"y":80,"wires":[]},{"id":"e70c9ec7.f71ee","type":"api-call-service","z":"30c7e5fd.18228a","name":"Set Ecobee Home","server":"144427d5.6c9f18","service_domain":"climate","service":"set_away_mode","data":"{\"entity_id\": \"climate.laundry, climate.master, climate.upstairs\", \"away_mode\": false}","mergecontext":"","x":470,"y":260,"wires":[[]]},{"id":"9922dd52.4b8be","type":"api-current-state","z":"2061740e.e5207c","name":"Sleep Mode Active","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"entity_id":"input_boolean.sleep_mode","outputs":1,"x":610,"y":120,"wires":[["209ca413.76181c"]]},{"id":"d26e85b.c424b78","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Stair Light On","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_on","data":"{\"entity_id\": \"switch.stair_light\"}","mergecontext":"","x":680,"y":840,"wires":[[]]},{"id":"ab9721bc.57dc","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Stair Light Off","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_off","data":"{\"entity_id\": \"switch.stair_light\"}","mergecontext":"","x":440,"y":880,"wires":[[]]},{"id":"7390a90b.295908","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Sleep Mode Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"on","outputs":1,"x":180,"y":880,"wires":[["ab9721bc.57dc"]]},{"id":"4c43add1.d859b4","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":540,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"2a8e78a8.3a6a48","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"var notificationMessage = 'The ' + msg.doorName + ' has been left open.';\n\nif(msg.payload === 'Closed') {\n    notificationMessage = 'The ' + msg.doorName + ' has been closed.';\n}\n\nreturn {\n    payload: {\n        data: {\n            title: \"Door Activity Notification\",\n            message: notificationMessage,\n            data: {\n                push: {\n                    category: 'clear_door_timer',\n                    \"thread-id\": 'ha-door-notification-' + msg.doorName \n                }\n            }\n        }\n    }\n};","outputs":1,"noerr":0,"x":1070,"y":600,"wires":[["f2b70656.597f28"]]},{"id":"5e4eb376.2ae7dc","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Closed","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Open","outputs":1,"x":130,"y":640,"wires":[["ba818cf8.be274"]]},{"id":"fea89e0d.500b8","type":"comment","z":"38894af.7ca61b6","name":"Notify If Door/Gate Open > 1m","info":"","x":190,"y":520,"wires":[]},{"id":"ba818cf8.be274","type":"change","z":"38894af.7ca61b6","name":"Stop Timer","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":680,"wires":[["27fb2179.a7237e"]]},{"id":"27fb2179.a7237e","type":"switch","z":"38894af.7ca61b6","name":"Door Router","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"sensor.front_door_state","vt":"str"},{"t":"eq","v":"sensor.back_door_state","vt":"str"},{"t":"eq","v":"sensor.side_door_state","vt":"str"},{"t":"eq","v":"sensor.north_gate_state","vt":"str"},{"t":"eq","v":"sensor.south_gate_state","vt":"str"}],"checkall":"false","repair":false,"outputs":5,"x":570,"y":620,"wires":[["4c43add1.d859b4"],["e6f4f6d4.3f84b8"],["6a93c010.4eedd"],["481e307a.623bc"],["3f6afe29.11be52"]]},{"id":"e6f4f6d4.3f84b8","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":580,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"6a93c010.4eedd","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":620,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"3cac9dc5.f192f2","type":"link out","z":"38894af.7ca61b6","name":"Utility - Repeat Door Timer","links":["ef97a7a2.bd3d68"],"x":975,"y":660,"wires":[]},{"id":"ef97a7a2.bd3d68","type":"link in","z":"38894af.7ca61b6","name":"Utility - Repeat Door Timer","links":["3cac9dc5.f192f2"],"x":395,"y":720,"wires":[["27fb2179.a7237e"]]},{"id":"53322bd0.9ade94","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":560,"wires":[["2a8e78a8.3a6a48"]]},{"id":"98de7b37.97b938","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"exact","haltifstate":"off","outputs":1,"x":130,"y":940,"wires":[["38ab4a04.31f836"]]},{"id":"cf3e3ab9.88a658","type":"comment","z":"cb6f2b8f.2124b8","name":"Notify on Away Mode Enable","info":"","x":160,"y":900,"wires":[]},{"id":"38ab4a04.31f836","type":"function","z":"cb6f2b8f.2124b8","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Away Mode Active\",\n            message: \"You will be notified of any unusual activity.\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":630,"y":940,"wires":[["51f9861c.fb07a8"]]},{"id":"b38d6099.4e13d","type":"inject","z":"cb6f2b8f.2124b8","name":"Test Notification","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":400,"y":900,"wires":[["38ab4a04.31f836"]]},{"id":"259dc6d8.29a85a","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Matt","links":["33e0d52f.80feea","51f9861c.fb07a8","5e9d1b86.e677f4","ce926406.6f9738","f087f08a.0264e","f2b70656.597f28","7e577921.85b078","495277d1.51d858","fb45bc1d.a0ecb","6e52addf.14d7e4","5ff8b930.afc738","d62da390.c14cc","553988c1.e16418","fd535219.99971"],"x":175,"y":260,"wires":[["5a78366b.a02858"]]},{"id":"3ba4aeb7.ee1e12","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Alydia","links":["5e9d1b86.e677f4","5ff8b930.afc738","ce926406.6f9738","f087f08a.0264e","553988c1.e16418","fd535219.99971"],"x":175,"y":300,"wires":[["c781ecd5.f4ab4"]]},{"id":"51f9861c.fb07a8","type":"link out","z":"cb6f2b8f.2124b8","name":"Away Mode Enabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":775,"y":940,"wires":[]},{"id":"ce926406.6f9738","type":"link out","z":"38894af.7ca61b6","name":"Door Opened While Away","links":["259dc6d8.29a85a","3ba4aeb7.ee1e12","58dfbc1f.ec9674"],"x":755,"y":360,"wires":[]},{"id":"33e0d52f.80feea","type":"link out","z":"cb6f2b8f.2124b8","name":"Guest Mode Disabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1075,"y":240,"wires":[]},{"id":"c03ce9cb.bd9d28","type":"function","z":"cb6f2b8f.2124b8","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"Guest Mode Disabled\",\n            message: \"All guest devices have disconnected from network.\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":950,"y":240,"wires":[["33e0d52f.80feea"]]},{"id":"f2b70656.597f28","type":"link out","z":"38894af.7ca61b6","name":"Door Left Open","links":["259dc6d8.29a85a","58dfbc1f.ec9674","66e43dcb.363604","d7669edc.b8c1"],"x":1215,"y":600,"wires":[]},{"id":"5a78366b.a02858","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Matt","server":"144427d5.6c9f18","service_domain":"notify","service":"ios_matt_iphone","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":570,"y":260,"wires":[[]]},{"id":"c781ecd5.f4ab4","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Alydia","server":"144427d5.6c9f18","service_domain":"notify","service":"ios_alydias_iphone","data":"{\"title\":\"Matt says...\", \"message\":\"I love you!\"}","mergecontext":"","x":570,"y":300,"wires":[[]]},{"id":"d88ae7ad.72c5b8","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Master Bedroom","links":["9a22ad6f.2b621","9fc4d89a.e1ae38","64f06d3a.c9e534","5e9d1b86.e677f4","fd535219.99971","f087f08a.0264e","495277d1.51d858","5ff8b930.afc738","562a6302.2c4fac"],"x":175,"y":420,"wires":[["4f090e7a.4c278"]]},{"id":"5e9d1b86.e677f4","type":"link out","z":"38894af.7ca61b6","name":"Smoke Detected","links":["259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","5c44608f.94f4c","66e43dcb.363604","b5c2d8b0.9a59d8","d7669edc.b8c1","d88ae7ad.72c5b8"],"x":775,"y":180,"wires":[]},{"id":"9dada5c9.04f6f8","type":"api-call-service","z":"38894af.7ca61b6","name":"Lock All Doors","server":"144427d5.6c9f18","service_domain":"lock","service":"lock","data":"{\"entity_id\": \"lock.front_door, lock.back_door, lock.garage_entry, lock.side_entry\"}","mergecontext":"","x":420,"y":1400,"wires":[[]]},{"id":"3c513bc.a5aa8c4","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Matt's Office","links":["495277d1.51d858","5e9d1b86.e677f4","f087f08a.0264e","fd535219.99971","5ff8b930.afc738"],"x":175,"y":500,"wires":[["b313b5b1.8d5fb8"]]},{"id":"da1c8d91.ec08b","type":"comment","z":"38894af.7ca61b6","name":"Doorbell Notifications","info":"","x":160,"y":1480,"wires":[]},{"id":"f69a6ad1.9ab428","type":"server-events","z":"38894af.7ca61b6","name":"All Events","server":"144427d5.6c9f18","x":120,"y":1560,"wires":[["fad883e.4f9208"]]},{"id":"fad883e.4f9208","type":"switch","z":"38894af.7ca61b6","name":"Doorbird Doorbell Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_button","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":350,"y":1560,"wires":[["1ef8149b.76ac7b","c5826772.8ebcb8"]]},{"id":"1ef8149b.76ac7b","type":"function","z":"38894af.7ca61b6","name":"Doorbell Identifier","func":"var map = {\n    doorbird_back_door_button: \"back door\",\n    doorbird_front_door_button: \"front door\",\n    doorbird_side_entry_button: \"side door\",\n}\n\nmsg.data = {\n    door_name: map[msg.event_type]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":1560,"wires":[["55feffde.8c42f"]]},{"id":"55feffde.8c42f","type":"function","z":"38894af.7ca61b6","name":"Set Message","func":"doorbellMessages = [\n    'The ' + msg.data.door_name + ' bell has rung.',\n    'Somebody is at the ' + msg.data.door_name,\n    'Somebody requires attention at the ' + msg.data.door_name,\n    'The doorbell has been pressed at the ' + msg.data.door_name\n]\n\nreturn {\n    payload: {\n        data: {\n            message: doorbellMessages[Math.floor(Math.random()*doorbellMessages.length)],\n        }\n    }\n};","outputs":1,"noerr":0,"x":810,"y":1560,"wires":[["fd535219.99971"]]},{"id":"fd535219.99971","type":"link out","z":"38894af.7ca61b6","name":"Doorbell Button Notifications","links":["259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d7669edc.b8c1","d88ae7ad.72c5b8"],"x":935,"y":1560,"wires":[]},{"id":"26219430.1853ec","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Playroom","links":["5e9d1b86.e677f4","fd535219.99971","f087f08a.0264e","f90cc501.a4f7b8","5ff8b930.afc738"],"x":175,"y":580,"wires":[["ad78a0ea.51329"]]},{"id":"704a126f.c1e7bc","type":"inject","z":"90be6c3f.6407","name":"Send Test Message","topic":"","payload":"{\"data\":{\"title\":\"Title Here\",\"message\":\"This is a test.\"}}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":250,"y":80,"wires":[["58ba3d6e.452774","708d64a1.c4ee8c"]]},{"id":"18ef1a18.f12fe6","type":"function","z":"38894af.7ca61b6","name":"Set Sleep Routine Fired","func":"global.set('sleep_routine_fired', true);\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":1100,"wires":[[]]},{"id":"d354f7f.00c8d08","type":"server-state-changed","z":"38894af.7ca61b6","name":"Exterior Door Unlocked","server":"144427d5.6c9f18","entityidfilter":"group.exterior_locks","entityidfiltertype":"exact","haltifstate":"locked","outputs":1,"x":880,"y":1340,"wires":[["326c2add.6e3806"]]},{"id":"326c2add.6e3806","type":"function","z":"38894af.7ca61b6","name":"Reset Sleep Routine","func":"global.set('sleep_routine_fired', false);\nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":1300,"wires":[[]]},{"id":"928ecd6a.39312","type":"switch","z":"38894af.7ca61b6","name":"Halt If Routine Already Executed","property":"sleep_routine_fired","propertyType":"global","rules":[{"t":"false"}],"checkall":"false","repair":false,"outputs":1,"x":550,"y":1060,"wires":[["6049fc74.846f74","18ef1a18.f12fe6"]]},{"id":"7957925.104696c","type":"inject","z":"38894af.7ca61b6","name":"Reset Sleep Routine","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":890,"y":1300,"wires":[["326c2add.6e3806"]]},{"id":"b3ed595e.befc58","type":"comment","z":"38894af.7ca61b6","name":"Reset Sleep Routine","info":"Daily reset allows sleep routine to fire \nagain each night.\n\nResetting on exterior door unlock means \nthe sleep routine will fire again when \ngetting back in bed if a door is unlocked\nafter bedtime.  This should ensure that \ndoors are secured while sleeping.\n\n","x":890,"y":1260,"wires":[]},{"id":"40650875.ee89e8","type":"server-state-changed","z":"38894af.7ca61b6","name":"Both Get Out of Bed","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_either","entityidfiltertype":"exact","haltifstate":"Occupied","outputs":1,"x":890,"y":1380,"wires":[["326c2add.6e3806"]]},{"id":"3ce6d3cd.af215c","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","outputs":1,"x":350,"y":580,"wires":[["27fb2179.a7237e"]]},{"id":"8bfc1912.cc2258","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","outputs":1,"x":130,"y":880,"wires":[["fd815c5c.72ed2"]]},{"id":"6c5d3ea3.f4f51","type":"comment","z":"38894af.7ca61b6","name":"Door Opened While Sleeping","info":"","x":180,"y":820,"wires":[]},{"id":"8d8206b1.6ffa18","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.topic = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":860,"wires":[["fcaa231a.8b616"]]},{"id":"fcaa231a.8b616","type":"template","z":"38894af.7ca61b6","name":"Set Message","field":"message","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Wake up. The {{topic}} has been opened.","output":"str","x":690,"y":900,"wires":[["e09ea359.04e5f"]]},{"id":"e09ea359.04e5f","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"DOOR STILL OPEN!\",\n            message: msg.message,\n        }\n    }\n};","outputs":1,"noerr":0,"x":990,"y":880,"wires":[["9fc4d89a.e1ae38","1751f37c.107a7d"]]},{"id":"9fc4d89a.e1ae38","type":"link out","z":"38894af.7ca61b6","name":"Door Opened While Sleeping","links":["d88ae7ad.72c5b8"],"x":1435,"y":880,"wires":[]},{"id":"12e1ad7d.3633e3","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":800,"wires":[["c672fc66.53c1c"]]},{"id":"c672fc66.53c1c","type":"function","z":"38894af.7ca61b6","name":"Setup Test Notification","func":"return {\n    \"payload\": \"open\",\n    \"topic\": \"sensor.front_door_state\"\n}","outputs":1,"noerr":0,"x":720,"y":800,"wires":[["8d8206b1.6ffa18"]]},{"id":"8dbee0f6.087c","type":"delay","z":"38894af.7ca61b6","name":"Delay 4s","pauseType":"delay","timeout":"4","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1240,"y":840,"wires":[["9fc4d89a.e1ae38","1751f37c.107a7d"]]},{"id":"b5c2d8b0.9a59d8","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Kitchen","links":["8644bb39.a50948","5e9d1b86.e677f4","fd535219.99971","f087f08a.0264e","495277d1.51d858","f90cc501.a4f7b8","5ff8b930.afc738"],"x":175,"y":660,"wires":[["8b4ac964.cefe48"]]},{"id":"c8f1ecf8.47595","type":"server-state-changed","z":"38894af.7ca61b6","name":"Water Leak Sensor","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.*leak*","entityidfiltertype":"regex","haltifstate":"","outputs":1,"x":150,"y":2040,"wires":[["744bfc94.bf9cb4"]]},{"id":"744bfc94.bf9cb4","type":"switch","z":"38894af.7ca61b6","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":2040,"wires":[["fb2e3c5e.c248"],["5fda46a6.5fbcc8"]]},{"id":"5fda46a6.5fbcc8","type":"change","z":"38894af.7ca61b6","name":"Reset Delay","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":2100,"wires":[["b90ef3c2.e2a1"]]},{"id":"fb2e3c5e.c248","type":"function","z":"38894af.7ca61b6","name":"Leak Sensor Locator","func":"var map = {\n    \"binary_sensor.kitchen_leak_sensor\": \"Kitchen\",\n    \"binary_sensor.master_bath_leak_sensor\": \"Master Bathroom\"\n}\n\nmsg.data = {\n    sensor_location: map[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":2000,"wires":[["e99dbcd0.6a0e9"]]},{"id":"b90ef3c2.e2a1","type":"delay","z":"38894af.7ca61b6","name":"Delay 60s","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":740,"y":2100,"wires":[["f087f08a.0264e","b2055264.6e15c"]]},{"id":"e99dbcd0.6a0e9","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: 'LEAK DETECTED!',\n            message: \"A leak has been detected in the \" + msg.data.sensor_location,\n        }\n    }\n};","outputs":1,"noerr":0,"x":750,"y":2000,"wires":[["f087f08a.0264e","b2055264.6e15c"]]},{"id":"f087f08a.0264e","type":"link out","z":"38894af.7ca61b6","name":"Leak Detected","links":["259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d7669edc.b8c1","d88ae7ad.72c5b8"],"x":975,"y":2000,"wires":[]},{"id":"b14d8b5.771eb78","type":"comment","z":"38894af.7ca61b6","name":"Water Leak Notifications","info":"","x":170,"y":1900,"wires":[]},{"id":"4254c077.173be","type":"function","z":"b55ab74c.698a88","name":"Set Warning Message","func":"var bedtimeMessages = [\n    'Bedtime is in ' + msg.payload,\n    msg.payload + ' until bedtime.',\n    'Twinkle twinkle little star, bedtime is not that far.',\n    'Bedtime quickly approaches. T-minus ' + msg.payload + ' and counting.',\n    'Time to go potty and get ready for bed. ' + msg.payload + ' until bedtime',\n    'Start getting ready for bed.'\n    ]\n\nreturn {\n    payload: {\n        data: {\n            message: bedtimeMessages[Math.floor(Math.random()*bedtimeMessages.length)]\n        }\n    }\n};","outputs":1,"noerr":0,"x":1180,"y":280,"wires":[["a17d9cdd.46c2d"]]},{"id":"5ff8b930.afc738","type":"link out","z":"b55ab74c.698a88","name":"Bedtime Notifications","links":["259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","5c44608f.94f4c","b5c2d8b0.9a59d8","d7669edc.b8c1","d88ae7ad.72c5b8"],"x":1335,"y":320,"wires":[]},{"id":"a20fcb6f.79b368","type":"function","z":"b55ab74c.698a88","name":"Set Bedtime Message","func":"var bedtimeMessages = [\n    'It is now bedtime.',\n    'Guess what time it is. Bedtime.',\n    'Time to get in the bed.',\n    'Bedtime.',\n    'The time has come. It is time to sleep.',\n    'Good night, sleep tight.',\n    'Good night, sweet children.'\n    ]\n\nreturn {\n    payload: {\n        data: {\n            message: bedtimeMessages[Math.floor(Math.random()*bedtimeMessages.length)]\n        }\n    }\n};","outputs":1,"noerr":0,"x":1180,"y":360,"wires":[["a17d9cdd.46c2d"]]},{"id":"48b0def5.daad6","type":"comment","z":"b55ab74c.698a88","name":"Bedtime Alerts","info":"","x":120,"y":120,"wires":[]},{"id":"34b777c3.70f908","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":1520,"wires":[["b30ba49.231ce58"]]},{"id":"b30ba49.231ce58","type":"function","z":"38894af.7ca61b6","name":"Test Doorbell","func":"msg.event_type = 'doorbird_front_door_button'\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1520,"wires":[["1ef8149b.76ac7b"]]},{"id":"5c44608f.94f4c","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Girl's Room","links":["5e9d1b86.e677f4","5ff8b930.afc738"],"x":175,"y":720,"wires":[["85f60cd0.daf11"]]},{"id":"f65133f3.e5e14","type":"inject","z":"38894af.7ca61b6","name":"Send Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1940,"wires":[["108b40b8.6c91ef"]]},{"id":"108b40b8.6c91ef","type":"function","z":"38894af.7ca61b6","name":"Setup Test Notification","func":"return {\n    \"payload\": \"on\",\n    \"topic\": \"binary_sensor.master_bath_leak_sensor\"\n}","outputs":1,"noerr":0,"x":400,"y":1940,"wires":[["fb2e3c5e.c248"]]},{"id":"821ebb4c.7ccd38","type":"inject","z":"38894af.7ca61b6","name":"Stop Notification Loop","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":2100,"wires":[["5fda46a6.5fbcc8"]]},{"id":"5e48cb98.0d30f4","type":"api-call-service","z":"90be6c3f.6407","name":"WebOS - Playroom TV","server":"144427d5.6c9f18","service_domain":"notify","service":"playroom_tv","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":560,"y":180,"wires":[[]]},{"id":"66e43dcb.363604","type":"link in","z":"90be6c3f.6407","name":"WebOS - Playroom TV","links":["5e9d1b86.e677f4","f087f08a.0264e","f2b70656.597f28","fd535219.99971","495277d1.51d858"],"x":175,"y":180,"wires":[["5e48cb98.0d30f4"]]},{"id":"c5826772.8ebcb8","type":"debug","z":"38894af.7ca61b6","name":"Doorbird Button Events","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":650,"y":1620,"wires":[]},{"id":"b10cd235.4e338","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Matt Browser","server":"144427d5.6c9f18","service_domain":"notify","service":"browser_push","data":"","mergecontext":"","x":600,"y":220,"wires":[[]]},{"id":"eb4a90c8.9c286","type":"mqtt in","z":"2061740e.e5207c","name":"All MQTT","topic":"#","qos":"2","broker":"1f84a57d.10775b","x":120,"y":860,"wires":[["24d70e68.65b4d2"]]},{"id":"24d70e68.65b4d2","type":"debug","z":"2061740e.e5207c","name":"MQTT Messages","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":310,"y":860,"wires":[]},{"id":"80420cd7.0f748","type":"server-state-changed","z":"47267ef8.fca6f","name":"Bed Unoccupied","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_both","entityidfiltertype":"exact","haltifstate":"Occupied","outputs":1,"x":180,"y":380,"wires":[["3269d216.98a64e"]]},{"id":"c7e9e280.455c2","type":"comment","z":"47267ef8.fca6f","name":"Pause Media On Bed Unoccupied","info":"","x":240,"y":320,"wires":[]},{"id":"3269d216.98a64e","type":"api-call-service","z":"47267ef8.fca6f","name":"Pause Playback","server":"144427d5.6c9f18","service_domain":"media_player","service":"media_pause","data":"{\"entity_id\": \"media_player.master_bedroom_tv_chromecast\"}","mergecontext":"","x":480,"y":380,"wires":[[]]},{"id":"88f43e4a.06933","type":"change","z":"90be6c3f.6407","name":"Select Media Player","rules":[{"t":"set","p":"data","pt":"msg","to":"{\"entity_id\":\"media_player.playroom_tv\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":560,"wires":[["68119da7.eca3f4"]]},{"id":"b159a61.0c29c58","type":"change","z":"90be6c3f.6407","name":"Select Media Player","rules":[{"t":"set","p":"data","pt":"msg","to":"{\"entity_id\":\"media_player.master_bedroom_tv_chromecast\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":400,"wires":[["708d64a1.c4ee8c"]]},{"id":"58dfbc1f.ec9674","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Matt Browser","links":["33e0d52f.80feea","495277d1.51d858","51f9861c.fb07a8","562a6302.2c4fac","5e9d1b86.e677f4","5ff8b930.afc738","7e577921.85b078","ce926406.6f9738","f087f08a.0264e","f2b70656.597f28","fb45bc1d.a0ecb","fd535219.99971","d62da390.c14cc","553988c1.e16418"],"x":175,"y":220,"wires":[["b10cd235.4e338"]]},{"id":"7e577921.85b078","type":"link out","z":"30c7e5fd.18228a","name":"Ecobee Away Mode Enabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":955,"y":160,"wires":[]},{"id":"a3ac2d3b.2c0f9","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Opened","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","haltifstate":"Closed","outputs":1,"x":130,"y":400,"wires":[["235f5706.9f8788","f70858b5.5dbb38"]]},{"id":"1af46f8.fc92591","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Opened","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"Closed","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":350,"y":620,"wires":[["27fb2179.a7237e"],[]]},{"id":"7559f0fd.8e122","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Closed","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","haltifstate":"Open","outputs":1,"x":130,"y":680,"wires":[["ba818cf8.be274"]]},{"id":"481e307a.623bc","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":660,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"3f6afe29.11be52","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":700,"wires":[["53322bd0.9ade94","3cac9dc5.f192f2"],[]]},{"id":"a19da4bf.c32108","type":"switch","z":"38894af.7ca61b6","name":"Unlocked Doors Found","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"All doors are locked.  Good night.","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":870,"y":1100,"wires":[["2d0655d0.300cda","326c2add.6e3806"]]},{"id":"6049fc74.846f74","type":"api-render-template","z":"38894af.7ca61b6","name":"Door Lock Status Message","server":"144427d5.6c9f18","template":"{% if is_state(\"lock.front_door\", \"locked\") and\n      is_state(\"lock.back_door\", \"locked\") and\n      is_state(\"lock.side_entry\", \"locked\") and\n      is_state(\"lock.garage_entry\", \"locked\") -%}\nAll doors are locked.  Good night.\n  \n{%- else -%} \n    {% set unlockedCount = 0 %}\n  \n  {%- if not is_state(\"lock.front_door\", \"locked\") -%}\nThe front door reports a status of {{ state_attr(\"lock.front_door\", 'lock_status')}}.\n    {% set unlockedCount = unlockedCount + 1 %}\n  {%- endif %}\n\n  {%- if not is_state(\"lock.back_door\", \"locked\") -%}\nThe back door reports a status of {{ state_attr(\"lock.back_door\", 'lock_status')}}.    \n{% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n\n  {%- if not is_state(\"lock.garage_entry\", \"locked\") -%}\nThe garage door reports a status of {{ state_attr(\"lock.garage_entry\", 'lock_status')}}.\n  {% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n\n  {%- if not is_state(\"lock.side_entry\", \"locked\") -%}\nThe side door reports a status of {{state_attr(\"lock.side_entry\", 'lock_status')}}.    \n{% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n  \n  {% if unlockedCount > 1 -%}\nAttempting to secure all doors now.\n  {%- else -%}\nAttempting to secure it now.\n  {%- endif %}\n  \n{%- endif %}","x":840,"y":1040,"wires":[["a19da4bf.c32108","2d8a718d.93454e","c090c7f6.db91d8"]]},{"id":"88fe746f.c586b8","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"// switch (msg.topic) {\n//     case ''\n// }\n\nreturn {\n    payload: {\n        data: {\n            message: msg.payload,\n        }\n    }\n};","outputs":1,"noerr":0,"x":1170,"y":1140,"wires":[["562a6302.2c4fac"]]},{"id":"2d0655d0.300cda","type":"api-call-service","z":"38894af.7ca61b6","name":"Lock All Doors","server":"144427d5.6c9f18","service_domain":"lock","service":"lock","data":"{\"entity_id\": \"lock.front_door, lock.back_door, lock.garage_entry, lock.side_entry\"}","mergecontext":"","x":880,"y":1140,"wires":[["12647560.d49ceb"]]},{"id":"12647560.d49ceb","type":"delay","z":"38894af.7ca61b6","name":"Delay","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":910,"y":1180,"wires":[["f3f50736.7dd2a8"]]},{"id":"eacd1413.2dac18","type":"api-render-template","z":"38894af.7ca61b6","name":"Door Lock Status Message","server":"144427d5.6c9f18","template":"{% if is_state(\"lock.front_door\", \"locked\") and\n      is_state(\"lock.back_door\", \"locked\") and\n      is_state(\"lock.side_entry\", \"locked\") and\n      is_state(\"lock.garage_entry\", \"locked\") -%}\n  I was able to secure all doors. Good night.\n{%- else -%} \n\n  {%- if is_state(\"lock.front_door\", \"unlocked\") -%}\n    I was unable to lock the front door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.back_door\", \"unlocked\") -%}\n    I was unable to lock the back door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.garage_entry\", \"unlocked\") -%}\n    I was unable to lock the garage door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.side_entry\", \"unlocked\") -%}\n    I was unable to lock the side entry door.\n  {%- endif %}\n  \n  Please double check the door to make sure it is secure.\n  \n{%- endif %}","x":1200,"y":1060,"wires":[["2d8a718d.93454e"]]},{"id":"562a6302.2c4fac","type":"link out","z":"38894af.7ca61b6","name":"Door Lock Status @ Sleep Mode Enabled","links":["58dfbc1f.ec9674","d88ae7ad.72c5b8"],"x":1375,"y":1140,"wires":[]},{"id":"f3f50736.7dd2a8","type":"function","z":"38894af.7ca61b6","name":"Clear Template","func":"\nreturn {};","outputs":1,"noerr":0,"x":1160,"y":1020,"wires":[["eacd1413.2dac18"]]},{"id":"8458fde1.e55c2","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"sensor.north_gate_state","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":740,"y":500,"wires":[["53322bd0.9ade94"]]},{"id":"1934d9bb.5fe796","type":"server-state-changed","z":"76250bd8.6dba94","name":"Reset Alexa Handler Input","server":"144427d5.6c9f18","entityidfilter":"input_boolean.alexa_.*","entityidfiltertype":"regex","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":190,"y":140,"wires":[["bfab3a97.d8afc8"],[]]},{"id":"1acdb776.78bf49","type":"api-call-service","z":"76250bd8.6dba94","name":"Reset Alexa Input","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":770,"y":140,"wires":[[]]},{"id":"660b5707.cac9f8","type":"comment","z":"76250bd8.6dba94","name":"Reset Trigger for All Flows","info":"Immediately turns off the boolean input from\nHome Assistant when triggered since action is\nonly taken when switched on.","x":190,"y":100,"wires":[]},{"id":"495277d1.51d858","type":"link out","z":"38894af.7ca61b6","name":"Gate Notifications","links":["259dc6d8.29a85a","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8","d7669edc.b8c1"],"x":755,"y":440,"wires":[]},{"id":"63e6c9e.2c38738","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Gate Opened\",\n            message: msg.doorName + ' has been opened.',\n            data: {\n                \"thread-id\": 'gate-activity'\n            }\n        }\n    }\n};","outputs":1,"noerr":0,"x":610,"y":440,"wires":[["495277d1.51d858"]]},{"id":"e18b65fc.e57fd8","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":320,"wires":[["d0151dc8.e8bb"]]},{"id":"f70858b5.5dbb38","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":400,"wires":[["63e6c9e.2c38738"]]},{"id":"457a29d1.b52a48","type":"function","z":"90be6c3f.6407","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Alexa Requires Attention\",\n            message: \"There was an error listing Alexa devices.  TTS notifications may not work.\",\n        }\n    }\n};","outputs":1,"noerr":0,"x":870,"y":940,"wires":[["d62da390.c14cc"]]},{"id":"d62da390.c14cc","type":"link out","z":"90be6c3f.6407","name":"Alexa Auth Notifications","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1055,"y":940,"wires":[]},{"id":"490c4db9.f33e64","type":"comment","z":"90be6c3f.6407","name":"Verify Alexa TTS Is Working","info":"","x":280,"y":880,"wires":[]},{"id":"e6e01a43.bfc978","type":"debug","z":"2061740e.e5207c","name":"All Events","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":380,"y":220,"wires":[]},{"id":"d669aebc.62cfc","type":"switch","z":"2061740e.e5207c","name":"","property":"event_type","propertyType":"msg","rules":[{"t":"eq","v":"test_event","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":240,"y":220,"wires":[["e6e01a43.bfc978"]]},{"id":"c9f72f6.4fa52d","type":"api-call-service","z":"97047d3e.e8278","name":"Light Service","server":"144427d5.6c9f18","service_domain":"","service":"","data":"","mergecontext":"","x":1730,"y":300,"wires":[[]]},{"id":"9bb5757.d056d88","type":"function","z":"97047d3e.e8278","name":"Build Service Payload","func":"if(msg.payload == 'ON') {\n    var service = 'turn_on';\n} else {\n    var service = 'turn_off';\n}\n\nvar domain = msg.topic.split('.')[0];\n\nreturn { \n        payload:{\n            domain: domain,\n            service: service,\n            data: {\n                entity_id: msg.topic\n            }\n        }\n    };","outputs":1,"noerr":0,"x":800,"y":260,"wires":[["e4410f0c.79f2f"]]},{"id":"88870d79.b0355","type":"inject","z":"97047d3e.e8278","name":"On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":200,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"ffbdb800.cbb2b8","type":"inject","z":"97047d3e.e8278","name":"Off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":240,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"b3976b49.6c3848","type":"inject","z":"97047d3e.e8278","name":"Auto","topic":"","payload":"auto","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":280,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"5943794e.0d5bf8","type":"inject","z":"97047d3e.e8278","name":"Stop","topic":"","payload":"stop","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"0.5","x":190,"y":320,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"b78e0fc9.3e897","type":"api-current-state","z":"97047d3e.e8278","name":"Halt If Not Extended Away","server":"144427d5.6c9f18","halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.extended_away_mode","state_type":"str","outputs":2,"x":1280,"y":300,"wires":[["5623456b.fc134c","f6fe513a.1dd42"],[]],"icon":"node-red/alert.png"},{"id":"c7403459.3e5a18","type":"comment","z":"cb6f2b8f.2124b8","name":"Extended Away Mode","info":"","x":140,"y":1060,"wires":[]},{"id":"96c5b3f6.7f2d9","type":"mqtt in","z":"cb6f2b8f.2124b8","name":"Owntracks Location Update","topic":"owntracks/+/iphone","qos":"2","broker":"1f84a57d.10775b","x":160,"y":1120,"wires":[["6b7cfac6.419554"]]},{"id":"4335ef50.9a556","type":"json","z":"cb6f2b8f.2124b8","name":"","property":"payload","action":"","pretty":false,"x":210,"y":1160,"wires":[["348d34cd.5a22cc"]]},{"id":"fb45bc1d.a0ecb","type":"link out","z":"cb6f2b8f.2124b8","name":"Extended Away Mode Enabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1395,"y":1160,"wires":[]},{"id":"7a4afce1.eceb54","type":"function","z":"cb6f2b8f.2124b8","name":"Build Notification","func":"if (msg.topic == 'enable_extended_away') {\n    msg = {\n        payload: {\n            data: {\n                title: \"Extended Away Mode Active\",\n                message: \"Enjoy your trip!\"\n            }\n        }\n    }\n}\n\nif (msg.topic == 'disable_extended_away') {\n        msg = {\n        payload: {\n            data: {\n                title: \"Extended Away Mode Disabled\",\n                message: \"Welcome Back!\"\n            }\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":1160,"wires":[["fb45bc1d.a0ecb"]]},{"id":"6b7cfac6.419554","type":"delay","z":"cb6f2b8f.2124b8","name":"Startup Delay","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":400,"y":1120,"wires":[["4335ef50.9a556"]]},{"id":"ad4b446b.4c9a48","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Extended Away","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\": \"input_boolean.extended_away_mode\"}","mergecontext":"","x":1270,"y":1200,"wires":[[]]},{"id":"b70c233a.4f3e1","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Extended Away Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.extended_away_mode","entityidfiltertype":"exact","haltifstate":"on","outputs":1,"x":190,"y":260,"wires":[["e70c9ec7.f71ee"]]},{"id":"7f050cdc.10b3d4","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Extended Away","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\": \"input_boolean.extended_away_mode\"}","mergecontext":"","x":1270,"y":1120,"wires":[[]]},{"id":"f6fe513a.1dd42","type":"debug","z":"97047d3e.e8278","name":"Light Service Debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1560,"y":360,"wires":[]},{"id":"e4410f0c.79f2f","type":"delay","z":"97047d3e.e8278","name":"Startup Delay","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":300,"wires":[["3c1e70cc.56031"]]},{"id":"749067ba.5fbb88","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Extended Away Current State","server":"144427d5.6c9f18","halt_if":"on","override_topic":true,"override_payload":true,"entity_id":"input_boolean.extended_away_mode","outputs":1,"x":710,"y":1060,"wires":[["ece3614.ea4e0a"]]},{"id":"50eb3ecc.3739","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Extended Away Current State","server":"144427d5.6c9f18","halt_if":"off","override_topic":true,"override_payload":true,"entity_id":"input_boolean.extended_away_mode","outputs":1,"x":710,"y":1260,"wires":[["75ab2411.56dd7c"]]},{"id":"3c1e70cc.56031","type":"delay","z":"97047d3e.e8278","name":"Randomize","pauseType":"random","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"300","randomUnits":"seconds","drop":false,"x":1030,"y":300,"wires":[["b78e0fc9.3e897"]]},{"id":"5623456b.fc134c","type":"switch","z":"97047d3e.e8278","name":"Discard Strings","property":"payload","propertyType":"msg","rules":[{"t":"istype","v":"object","vt":"object"}],"checkall":"true","repair":false,"outputs":1,"x":1540,"y":300,"wires":[["c9f72f6.4fa52d"]]},{"id":"a8bd851.da78978","type":"inject","z":"30c7e5fd.18228a","name":"Set Ecobee Home","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":320,"wires":[["e70c9ec7.f71ee"]]},{"id":"73975859.0d2928","type":"inject","z":"30c7e5fd.18228a","name":"Set Ecobee Away","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":540,"y":100,"wires":[["d15821ae.44ebd"]]},{"id":"74d488ef.7de0a8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Sleep Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":170,"y":460,"wires":[["ee646eaf.5288","9b071567.e41698","8fee7b97.e85098","885ed3b9.3f301"],[]]},{"id":"ee646eaf.5288","type":"api-current-state","z":"30c7e5fd.18228a","name":"Get Chromecast Status","server":"144427d5.6c9f18","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"media_player.master_bedroom_tv_chromecast","outputs":1,"x":430,"y":600,"wires":[["7f72aca7.f8cdb4","1c2e40a4.e1f39f"]]},{"id":"58bf0310.2851bc","type":"delay","z":"30c7e5fd.18228a","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":780,"y":660,"wires":[["cad83f8a.f039c"]]},{"id":"66621586.db903c","type":"api-call-service","z":"30c7e5fd.18228a","name":"Turn TV Off","server":"144427d5.6c9f18","service_domain":"script","service":"master_tv_off","data":"","mergecontext":"","x":1070,"y":660,"wires":[[]]},{"id":"f652f9be.4778e8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Sleep Mode Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":1060,"y":460,"wires":[["3ba27f68.c873b"],[]]},{"id":"3ba27f68.c873b","type":"api-call-service","z":"30c7e5fd.18228a","name":"Sound Machine Off","server":"144427d5.6c9f18","service_domain":"media_player","service":"media_pause","data":"{\"entity_id\":\"media_player.master_bedroom_sonos\"}","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":1290,"y":460,"wires":[[]]},{"id":"30a44dd0.162a22","type":"inject","z":"38894af.7ca61b6","name":"Reset Timers","topic":"","payload":"STOP","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":500,"wires":[["48e55600.7e731c"]]},{"id":"5895b4f4.b78d0c","type":"comment","z":"30c7e5fd.18228a","name":"Fan On When Bed Occupied","info":"","x":200,"y":900,"wires":[]},{"id":"60d5968.d518768","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Bed Occupied","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_either","entityidfiltertype":"exact","haltifstate":"","outputs":1,"x":150,"y":1000,"wires":[["df004893.d42108"]]},{"id":"d14e27bc.f3c458","type":"api-call-service","z":"30c7e5fd.18228a","name":"Fan On","server":"144427d5.6c9f18","service_domain":"fan","service":"set_speed","data":"","mergecontext":"","x":1200,"y":760,"wires":[[]]},{"id":"df004893.d42108","type":"switch","z":"30c7e5fd.18228a","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Occupied","vt":"str"},{"t":"eq","v":"Unoccupied","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":980,"wires":[["7e3eb6e2.67bc48"],["4553441c.310eac"]]},{"id":"4553441c.310eac","type":"api-call-service","z":"30c7e5fd.18228a","name":"Fan Off","server":"144427d5.6c9f18","service_domain":"fan","service":"turn_off","data":"{\"entity_id\": \"fan.master_bedroom_fan_level\"}","mergecontext":"","x":500,"y":1080,"wires":[[]]},{"id":"e91c738b.34686","type":"time-range-switch","z":"30c7e5fd.18228a","name":"Is Bedtime?","lat":"","lon":"","startTime":"22:00","endTime":"7:00","startOffset":0,"endOffset":0,"x":530,"y":1020,"wires":[[],["e9325a4e.aa71a8"]]},{"id":"40a0cc5d.c330d4","type":"function","z":"30c7e5fd.18228a","name":"Bedtime Settings","func":"msg.payload = {\n    data: {\n        entity_id: \"fan.master_bedroom_fan_level\", \n        speed: msg.payload\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":760,"wires":[["d14e27bc.f3c458"]]},{"id":"e9325a4e.aa71a8","type":"function","z":"30c7e5fd.18228a","name":"Other Settings","func":"msg.payload = {\n    data: {\n        entity_id: \"fan.master_bedroom_fan_level\", \n        speed:\"medium\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1000,"wires":[["20b94728.74eb88"]]},{"id":"5c2ae9a4.780d58","type":"inject","z":"30c7e5fd.18228a","name":"","topic":"","payload":"Occupied","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":960,"wires":[["df004893.d42108"]]},{"id":"26d30629.9b476a","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Light Turned On","server":"144427d5.6c9f18","entityidfilter":"light.","entityidfiltertype":"substring","haltifstate":"off","outputs":1,"x":160,"y":1320,"wires":[["da1ed74d.32b058"]]},{"id":"d8e83fcc.412d9","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"On","server":"144427d5.6c9f18","service_domain":"light","service":"turn_on","data":"","mergecontext":"","x":1010,"y":1320,"wires":[["c5863dd6.8bd9f"]]},{"id":"63cca837.6b1d58","type":"function","z":"eee3c0c3.7c7bd","name":"Adjust Level Payload","func":"var lightLevel = flow.get(\"light_level_pct\");\n\n// set special level if provided\n// caller is responsible for resetting levels\nif(msg.special_level) {\n    flow.set(\"light_level_custom_\" + msg.topic, msg.special_level)\n} else {    \n    flow.set(\"light_level_custom_\" + msg.topic, undefined)\n}\n\nvar specialLevel = flow.get(\"light_level_custom_\" + msg.topic)\n\nif (specialLevel) {\n    lightLevel = specialLevel;\n}\n\nmsg = {\n    payload: {\n        entity_id: msg.topic,\n        data: {\n            brightness_pct: lightLevel,\n            entity_id: msg.topic,\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":1320,"wires":[["36a017f0.bede88","d8e83fcc.412d9"]]},{"id":"da1ed74d.32b058","type":"switch","z":"eee3c0c3.7c7bd","name":"Filter for Off to On State Change","property":"data.new_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.old_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":1320,"wires":[["63cca837.6b1d58"]]},{"id":"20c451c1.48de3e","type":"function","z":"eee3c0c3.7c7bd","name":"Set Light Level","func":"flow.set(\"light_level_pct\", msg.payload);","outputs":1,"noerr":0,"x":460,"y":1400,"wires":[[]]},{"id":"25e1a545.413dea","type":"comment","z":"eee3c0c3.7c7bd","name":"Time Based Light Dimming","info":"","x":190,"y":1280,"wires":[]},{"id":"5adca2d9.cd9d7c","type":"split","z":"eee3c0c3.7c7bd","name":"Split","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":550,"y":1540,"wires":[["31d0ed0a.d06a62"]]},{"id":"31d0ed0a.d06a62","type":"change","z":"eee3c0c3.7c7bd","name":"Set Topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":1580,"wires":[["56eee06.99a9b2"]]},{"id":"49f64c2c.a64644","type":"inject","z":"eee3c0c3.7c7bd","name":"","topic":"","payload":"30","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":1380,"wires":[["20c451c1.48de3e"]]},{"id":"4324fda6.94b894","type":"mqtt out","z":"8d45d5f6.f088e8","name":"Tree Pattern Adjust","topic":"led/tree/patternAdjust","qos":"0","retain":"","broker":"1f84a57d.10775b","x":792,"y":180,"wires":[]},{"id":"c1699215.193ce","type":"inject","z":"8d45d5f6.f088e8","name":"Adjust Tree Pattern","topic":"","payload":"1","payloadType":"str","repeat":"60","crontab":"","once":true,"onceDelay":"1","x":240,"y":180,"wires":[["8de38213.0e005"]]},{"id":"9f204fef.d5081","type":"inject","z":"eee3c0c3.7c7bd","name":"","topic":"","payload":"100","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":1420,"wires":[["20c451c1.48de3e"]]},{"id":"20829d14.a77f42","type":"api-call-service","z":"76250bd8.6dba94","name":"Turn On TV","server":"144427d5.6c9f18","service_domain":"media_player","service":"turn_on","data":"{\"entity_id\": \"media_player.playroom_tv\"}","mergecontext":"","x":450,"y":300,"wires":[[]]},{"id":"1dd1e412.a1570c","type":"api-call-service","z":"76250bd8.6dba94","name":"Set TV to 11-2","server":"144427d5.6c9f18","service_domain":"media_player","service":"play_media","data":"{\"entity_id\": \"media_player.playroom_tv\", \"media_content_id\": \"11-2\", \"media_content_type\": \"channel\"}","mergecontext":"","x":700,"y":340,"wires":[[]]},{"id":"1a2a73d0.b6f47c","type":"delay","z":"76250bd8.6dba94","name":"Delay 5s","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":340,"wires":[["1dd1e412.a1570c"]]},{"id":"18d627a7.c24208","type":"inject","z":"38894af.7ca61b6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":280,"y":1140,"wires":[["928ecd6a.39312"]]},{"id":"6cecb33a.c2a5dc","type":"api-current-state","z":"30c7e5fd.18228a","name":"Bed Is Occupied","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"entity_id":"sensor.bed_either","outputs":1,"x":710,"y":740,"wires":[["95020313.f0aff"]]},{"id":"7e3eb6e2.67bc48","type":"api-current-state","z":"30c7e5fd.18228a","name":"Flag Check","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"entity_id":"input_boolean.flag_fan_on_when_bed_occupied","outputs":1,"x":510,"y":980,"wires":[["e91c738b.34686"]]},{"id":"885ed3b9.3f301","type":"api-current-state","z":"30c7e5fd.18228a","name":"Flag Check","server":"144427d5.6c9f18","halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"override_payload":false,"override_data":true,"entity_id":"input_boolean.flag_fan_on_at_bedtime","state_type":"str","outputs":2,"x":390,"y":740,"wires":[["6cecb33a.c2a5dc"],[]]},{"id":"95020313.f0aff","type":"api-current-state","z":"30c7e5fd.18228a","name":"Get Fan Speed","server":"144427d5.6c9f18","halt_if":"","override_topic":false,"override_payload":true,"entity_id":"input_select.option_fan_speed_at_bedtime","outputs":1,"x":700,"y":780,"wires":[["40a0cc5d.c330d4"]]},{"id":"ab9ab807.c3ad58","type":"delay","z":"b55ab74c.698a88","name":"5m Delay","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":700,"y":280,"wires":[["30eb3225.e29e7e"]]},{"id":"fe960e6c.e95d8","type":"delay","z":"b55ab74c.698a88","name":"10m Delay","pauseType":"delay","timeout":"10","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":710,"y":320,"wires":[["f75716cd.511c08"]]},{"id":"7cb1a4dc.28bdcc","type":"delay","z":"b55ab74c.698a88","name":"15m Delay","pauseType":"delay","timeout":"15","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":710,"y":360,"wires":[["a20fcb6f.79b368"]]},{"id":"30eb3225.e29e7e","type":"change","z":"b55ab74c.698a88","name":"10 Minute Message","rules":[{"t":"set","p":"payload","pt":"msg","to":"10 minutes","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":280,"wires":[["4254c077.173be"]]},{"id":"3bc02f96.228c4","type":"change","z":"b55ab74c.698a88","name":"15 Minute Message","rules":[{"t":"set","p":"payload","pt":"msg","to":"15 minutes","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":240,"wires":[["4254c077.173be"]]},{"id":"f75716cd.511c08","type":"change","z":"b55ab74c.698a88","name":"5 Minute Message","rules":[{"t":"set","p":"payload","pt":"msg","to":"5 minutes","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":320,"wires":[["4254c077.173be"]]},{"id":"71ef9f7.ac8386","type":"function","z":"b55ab74c.698a88","name":"Set Global","func":"flow.set('bedtime_event_fired', true);\n","outputs":1,"noerr":0,"x":710,"y":160,"wires":[[]]},{"id":"c69c9e5a.02ca1","type":"switch","z":"b55ab74c.698a88","name":"Halt If Already Fired","property":"bedtime_event_fired","propertyType":"flow","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":220,"wires":[["3bc02f96.228c4","71ef9f7.ac8386","ab9ab807.c3ad58","fe960e6c.e95d8","7cb1a4dc.28bdcc"]]},{"id":"de2ed938.15b478","type":"inject","z":"b55ab74c.698a88","name":"Reset Bedtime Event","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 09 * * *","once":false,"onceDelay":0.1,"x":400,"y":120,"wires":[["ac156b22.69f258"]]},{"id":"ac156b22.69f258","type":"function","z":"b55ab74c.698a88","name":"Set Global","func":"flow.set('bedtime_event_fired', false);\n","outputs":1,"noerr":0,"x":710,"y":120,"wires":[[]]},{"id":"2d1abd58.41aef2","type":"comment","z":"47267ef8.fca6f","name":"Master Bedroom Lights Off On Media Start","info":"","x":260,"y":140,"wires":[]},{"id":"5dd403a2.c90a5c","type":"server-state-changed","z":"47267ef8.fca6f","name":"Master Bedroom Media State","server":"144427d5.6c9f18","entityidfilter":"media_player.master_bedroom_tv_chromecast","entityidfiltertype":"exact","haltifstate":"","outputs":1,"x":220,"y":200,"wires":[["716735dc.665acc"]]},{"id":"716735dc.665acc","type":"switch","z":"47267ef8.fca6f","name":"State Router","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":500,"y":200,"wires":[["9a965b9f.858768"]]},{"id":"8002ffa.6b70b","type":"api-call-service","z":"47267ef8.fca6f","name":"Turn Off Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_off","data":"{\"entity_id\": \"switch.master_bedroom_light\"}","mergecontext":"","x":960,"y":200,"wires":[[]]},{"id":"9a965b9f.858768","type":"api-current-state","z":"47267ef8.fca6f","name":"Halt If Lights Off","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"entity_id":"switch.master_bedroom_light","outputs":1,"x":720,"y":200,"wires":[["8002ffa.6b70b"]]},{"id":"2c205a59.383456","type":"server-state-changed","z":"47267ef8.fca6f","name":"Living Room TV Media State","server":"144427d5.6c9f18","entityidfilter":"media_player.living_room_tv","entityidfiltertype":"exact","outputinitially":false,"haltifstate":"off","outputs":1,"x":200,"y":600,"wires":[["99c8323a.d9ff5"]]},{"id":"99c8323a.d9ff5","type":"switch","z":"47267ef8.fca6f","name":"isPlaying","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":440,"y":560,"wires":[["96968b6c.c92238","49144431.23101c"],["bdb8c7a9.ead018"]]},{"id":"270fc0f.47a3d4","type":"comment","z":"47267ef8.fca6f","name":"Living Room Lights Off On Media Start","info":"","x":230,"y":460,"wires":[]},{"id":"64957100.edc8d","type":"api-call-service","z":"8d45d5f6.f088e8","name":"Inside Lights Off","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_off","data":"{\"entity_id\": \"group.christmas_lights_inside\"}","mergecontext":"","x":680,"y":340,"wires":[[]]},{"id":"82641421.0af868","type":"server-state-changed","z":"8d45d5f6.f088e8","name":"Bed Occupied","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"exact","outputinitially":false,"haltifstate":"Off","outputs":1,"x":190,"y":340,"wires":[["64957100.edc8d"]]},{"id":"769d043d.7bd40c","type":"comment","z":"8d45d5f6.f088e8","name":"Inside Lights Off @ Bedtime","info":"","x":240,"y":300,"wires":[]},{"id":"153fa906.7b84f7","type":"api-call-service","z":"8d45d5f6.f088e8","name":"Inside Lights On","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_on","data":"{\"entity_id\": \"group.christmas_lights_inside\"}","mergecontext":"","x":680,"y":540,"wires":[[]]},{"id":"105c4f83.2110f","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Block If Sleep Mode Active","server":"144427d5.6c9f18","halt_if":"On","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.sleep_mode","outputs":1,"x":720,"y":460,"wires":[["b4813311.239c"]]},{"id":"b4813311.239c","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Block If Already On","server":"144427d5.6c9f18","halt_if":"On","override_topic":false,"override_payload":false,"entity_id":"group.christmas_lights_inside","outputs":1,"x":690,"y":500,"wires":[["153fa906.7b84f7"]]},{"id":"d7669edc.b8c1","type":"link in","z":"90be6c3f.6407","name":"WebOS - Living Room TV","links":["495277d1.51d858","5e9d1b86.e677f4","5ff8b930.afc738","f087f08a.0264e","f2b70656.597f28","fd535219.99971"],"x":175,"y":140,"wires":[["c6ac8d87.65e44"]]},{"id":"c6ac8d87.65e44","type":"api-call-service","z":"90be6c3f.6407","name":"WebOS - Living Room TV","server":"144427d5.6c9f18","service_domain":"notify","service":"living_room_tv","data":"","mergecontext":"","x":570,"y":140,"wires":[[]]},{"id":"a406c663.ab0a6","type":"switch","z":"8d45d5f6.f088e8","name":"On/Off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"OFF","vt":"str"},{"t":"eq","v":"ON","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":420,"wires":[["64957100.edc8d"],["36fcddbc.c37e82","f4316c4e.01975"]]},{"id":"1ff179d8.17ba36","type":"comment","z":"8d45d5f6.f088e8","name":"Inside Lights Schedule","info":"","x":220,"y":420,"wires":[]},{"id":"dbbd116e.e5a03","type":"link in","z":"eee3c0c3.7c7bd","name":"Adjust Light Level","links":["2e6b817.ba2c47e","5e7b562d.80c438"],"x":615,"y":1260,"wires":[["63cca837.6b1d58"]]},{"id":"2e6b817.ba2c47e","type":"link out","z":"47267ef8.fca6f","name":"Media Lighting - Living Room","links":["dbbd116e.e5a03"],"x":1415,"y":620,"wires":[]},{"id":"d218f7cf.2f4b58","type":"change","z":"47267ef8.fca6f","name":"Playing Level","rules":[{"t":"set","p":"special_level","pt":"msg","to":"10","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":560,"wires":[["a8a5edff.97d4","55d2946b.89e2fc"]]},{"id":"5e762d2e.e2a404","type":"inject","z":"47267ef8.fca6f","name":"","topic":"","payload":"playing","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":270,"y":520,"wires":[["99c8323a.d9ff5"]]},{"id":"2a4edf13.498f1","type":"api-call-service","z":"47267ef8.fca6f","name":"Kitchen Pendants Off","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_off","data":"{\"entity_id\":\"switch.kitchen_pendant_lights\"}","mergecontext":"","x":1000,"y":480,"wires":[[]]},{"id":"5e7b562d.80c438","type":"link out","z":"eee3c0c3.7c7bd","name":"Kitchen Motion Light Adjustment","links":["dbbd116e.e5a03"],"x":1035,"y":296,"wires":[]},{"id":"637cd091.0fbe3","type":"switch","z":"eee3c0c3.7c7bd","name":"Filter for Off to On State Change","property":"data.new_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.old_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":360,"wires":[["2901960a.c8dc3a"]]},{"id":"fd97ed5c.f14d3","type":"api-current-state","z":"eee3c0c3.7c7bd","name":"Halt If Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":410,"y":300,"wires":[["ec156ffc.6dcf4"]]},{"id":"2901960a.c8dc3a","type":"switch","z":"eee3c0c3.7c7bd","name":"On/Off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":300,"wires":[["5e7b562d.80c438"],["c174ca76.fe5338"]]},{"id":"40d1d2bf.0f110c","type":"delay","z":"eee3c0c3.7c7bd","name":"Deploy Delay","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":210,"y":1540,"wires":[["b2330fbe.bec08"]]},{"id":"b2330fbe.bec08","type":"api-render-template","z":"eee3c0c3.7c7bd","name":"List On Lights","server":"144427d5.6c9f18","template":"{% for state in states.light -%}\n{% if state.state == 'on' %}\n{{ state.entity_id }}{% endif -%}\n{% endfor %}\n\n","x":520,"y":1500,"wires":[["5adca2d9.cd9d7c"]]},{"id":"b171b1d3.a7c75","type":"inject","z":"eee3c0c3.7c7bd","name":"Off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":390,"y":240,"wires":[["fd97ed5c.f14d3"]]},{"id":"49700d5f.faa384","type":"inject","z":"eee3c0c3.7c7bd","name":"On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":570,"y":240,"wires":[["fd97ed5c.f14d3"]]},{"id":"ec156ffc.6dcf4","type":"change","z":"eee3c0c3.7c7bd","name":"Set Topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"light.kitchen_can_lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":300,"wires":[["2901960a.c8dc3a"]]},{"id":"4f090e7a.4c278","type":"api-current-state","z":"90be6c3f.6407","name":"Halt if Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":310,"y":420,"wires":[["b159a61.0c29c58"]]},{"id":"b313b5b1.8d5fb8","type":"api-current-state","z":"90be6c3f.6407","name":"Halt if Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":310,"y":500,"wires":[["b23a6a41.003758"]]},{"id":"ad78a0ea.51329","type":"api-current-state","z":"90be6c3f.6407","name":"Halt if Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":310,"y":580,"wires":[["88f43e4a.06933"]]},{"id":"8b4ac964.cefe48","type":"api-current-state","z":"90be6c3f.6407","name":"Halt if Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":310,"y":660,"wires":[["58ba3d6e.452774"]]},{"id":"85f60cd0.daf11","type":"api-current-state","z":"90be6c3f.6407","name":"Halt if Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":310,"y":720,"wires":[["c3f1a0c9.06055"]]},{"id":"cf3a9398.0b726","type":"api-current-state","z":"eee3c0c3.7c7bd","name":"Halt If Guests","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.guest_mode","outputs":1,"x":440,"y":800,"wires":[["604733f.ffb9ecc","d26e85b.c424b78"]]},{"id":"fd815c5c.72ed2","type":"api-current-state","z":"38894af.7ca61b6","name":"Halt If Sleep Mode Disabled","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.sleep_mode","outputs":1,"x":400,"y":880,"wires":[["2316f4eb.9cb06c"]]},{"id":"2316f4eb.9cb06c","type":"api-current-state","z":"38894af.7ca61b6","name":"Halt If Guest Mode Enabled","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.guest_mode","outputs":1,"x":400,"y":920,"wires":[["8d8206b1.6ffa18"]]},{"id":"368fe191.19c0be","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Halt If Guest Mode Disabled","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.guest_mode","outputs":1,"x":700,"y":240,"wires":[["21e8b9b3.0eada6","c03ce9cb.bd9d28"]]},{"id":"88d42a21.79c948","type":"comment","z":"76250bd8.6dba94","name":"Play Cartoons in Playroom","info":"","x":190,"y":260,"wires":[]},{"id":"51f0abaa.218044","type":"server-state-changed","z":"76250bd8.6dba94","name":"Alexa Handler - Goodnight","server":"144427d5.6c9f18","entityidfilter":"input_boolean.alexa_goodnight","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":190,"y":420,"wires":[["152433ab.784a5c"],[]]},{"id":"a8a5edff.97d4","type":"time-range-switch","z":"47267ef8.fca6f","name":"isNight","lat":"","lon":"","startTime":"sunrise","endTime":"sunset","startOffset":0,"endOffset":0,"x":1140,"y":560,"wires":[[],["6d21a918.9090e8"]]},{"id":"3663f012.7284c","type":"mqtt out","z":"8d45d5f6.f088e8","name":"Tree Power","topic":"led/tree/power","qos":"0","retain":"","broker":"1f84a57d.10775b","x":470,"y":120,"wires":[]},{"id":"56eee06.99a9b2","type":"switch","z":"eee3c0c3.7c7bd","name":"Exclude Specific Lights","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"light.backyard_tree_led","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":570,"y":1620,"wires":[[],["c6f4ae6e.c4fe2"]]},{"id":"9155bc22.589b4","type":"api-current-state","z":"eee3c0c3.7c7bd","name":"Block If Motion Active","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"binary_sensor.kitchen_motion","outputs":1,"x":920,"y":380,"wires":[["a7d89183.b3723"]]},{"id":"36fcddbc.c37e82","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Home","server":"144427d5.6c9f18","halt_if":"not_home","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"group.all_devices","outputs":1,"x":650,"y":400,"wires":[["105c4f83.2110f"]]},{"id":"f4316c4e.01975","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Away","server":"144427d5.6c9f18","halt_if":"home","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"group.all_devices","outputs":1,"x":650,"y":300,"wires":[["64957100.edc8d"]]},{"id":"993501d3.37c6e","type":"delay","z":"8d45d5f6.f088e8","name":"Startup Delay","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":500,"wires":[["a406c663.ab0a6"]]},{"id":"8de38213.0e005","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Halt If Tree Off","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"light.backyard_tree_led","outputs":1,"x":480,"y":180,"wires":[["808ba40a.43e208"]]},{"id":"808ba40a.43e208","type":"api-current-state","z":"8d45d5f6.f088e8","name":"Pattern Rotation Check","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.option_backyard_tree_rotate_pattern","outputs":1,"x":510,"y":240,"wires":[["4324fda6.94b894"]]},{"id":"e343ce46.fb13c","type":"inject","z":"b55ab74c.698a88","name":"Weekday Bedtime Event","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 20 * * 1,2,3,4,0","once":false,"onceDelay":0.1,"x":170,"y":220,"wires":[["c69c9e5a.02ca1"]]},{"id":"a17d9cdd.46c2d","type":"api-current-state","z":"b55ab74c.698a88","name":"Halt If Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.away_mode","outputs":1,"x":1170,"y":320,"wires":[["5ff8b930.afc738"]]},{"id":"388fbd9a.f51ce2","type":"inject","z":"8d45d5f6.f088e8","name":"Tree Off Schedule","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"00 23 * * *","once":false,"onceDelay":"1","x":250,"y":80,"wires":[["3663f012.7284c","bb3c5c4f.6ed76"]]},{"id":"e911146a.5c48d8","type":"server-state-changed","z":"8d45d5f6.f088e8","name":"Single Pixel Specified","server":"144427d5.6c9f18","entityidfilter":"input_number.option_backyard_tree_single_pixel","entityidfiltertype":"exact","outputinitially":false,"haltifstate":"","outputs":1,"x":220,"y":640,"wires":[["f27c3b0.1a281c8","e9f97268.304f9"]]},{"id":"f27c3b0.1a281c8","type":"debug","z":"8d45d5f6.f088e8","name":"Single Pixel Value","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":590,"y":640,"wires":[]},{"id":"e9f97268.304f9","type":"mqtt out","z":"8d45d5f6.f088e8","name":"Tree Pattern Adjust","topic":"led/tree/single","qos":"0","retain":"","broker":"1f84a57d.10775b","x":590,"y":700,"wires":[]},{"id":"bb3c5c4f.6ed76","type":"api-call-service","z":"8d45d5f6.f088e8","name":"Enable Pattern Rotation Daily","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\":\"input_boolean.option_backyard_tree_rotate_pattern\"}","mergecontext":"","x":710,"y":80,"wires":[[]]},{"id":"c174ca76.fe5338","type":"trigger","z":"eee3c0c3.7c7bd","op1":"","op2":"off","op1type":"pay","op2type":"str","duration":"15","extend":true,"units":"min","reset":"","bytopic":"topic","name":"Delay","x":870,"y":340,"wires":[["9155bc22.589b4"]]},{"id":"152433ab.784a5c","type":"api-current-state","z":"76250bd8.6dba94","name":"Halt If Sleep Mode Enabled","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"input_boolean.sleep_mode","outputs":1,"x":520,"y":420,"wires":[["44c5ed07.104934"]]},{"id":"44c5ed07.104934","type":"api-call-service","z":"76250bd8.6dba94","name":"Enable Sleep Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\": \"input_boolean.sleep_mode\"}","mergecontext":"","x":930,"y":420,"wires":[[]]},{"id":"bdb8c7a9.ead018","type":"change","z":"47267ef8.fca6f","name":"Reset Level","rules":[{"t":"delete","p":"special_level","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":620,"wires":[["6d21a918.9090e8"]]},{"id":"f37615fe.5a8188","type":"inject","z":"47267ef8.fca6f","name":"","topic":"","payload":"paused","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":270,"y":560,"wires":[["99c8323a.d9ff5"]]},{"id":"6d21a918.9090e8","type":"change","z":"47267ef8.fca6f","name":"Set Topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"light.kitchen_can_lights","tot":"str"},{"t":"set","p":"payload.entity_id","pt":"msg","to":"light.kitchen_can_lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1140,"y":620,"wires":[["18b03173.700dcf"]]},{"id":"36a017f0.bede88","type":"debug","z":"eee3c0c3.7c7bd","name":"Light Level Payload","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1050,"y":1440,"wires":[]},{"id":"18b03173.700dcf","type":"api-current-state","z":"47267ef8.fca6f","name":"Halt if Off","server":"144427d5.6c9f18","halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"override_payload":false,"override_data":false,"entity_id":"light.kitchen_can_lights","state_type":"str","outputs":2,"x":1300,"y":620,"wires":[["2e6b817.ba2c47e"],[]]},{"id":"96968b6c.c92238","type":"time-range-switch","z":"47267ef8.fca6f","name":"isNight","lat":"","lon":"","startTime":"sunrise","endTime":"sunset","startOffset":0,"endOffset":0,"x":680,"y":500,"wires":[[],["2a4edf13.498f1"]]},{"id":"fc268fde.02b75","type":"server-state-changed","z":"3e9522c6.d11e1e","name":"Alexa Handler - Show Cameras on TVs","server":"144427d5.6c9f18","entityidfilter":"input_boolean.alexa_show_.*_tv","entityidfiltertype":"regex","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"x":190,"y":380,"wires":[["76b58aa2.4c5024"],[]]},{"id":"8d11fcf7.518b1","type":"api-call-service","z":"3e9522c6.d11e1e","name":"Show Camera on Requested Display","server":"144427d5.6c9f18","service_domain":"media_player","service":"play_media","data":"{\"media_content_id\":\"https://{{base_url}}/api/camera_proxy_stream/{{data.entity_id}}?token={{data.attributes.access_token}}\",\"media_content_type\":\"image/jpg\"}","render_data":true,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":1410,"y":300,"wires":[["aa990c2c.22912"]]},{"id":"8fb080c0.696a2","type":"inject","z":"3e9522c6.d11e1e","name":"Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":220,"wires":[["1f9e987c.47f058"]]},{"id":"1f9e987c.47f058","type":"function","z":"3e9522c6.d11e1e","name":"Test Doorbell","func":"msg.event_type = 'doorbird_front_door_button'\n// msg.event_type = 'doorbird_side_entry_button'\n// msg.event_type = 'doorbird_back_door_button'\n\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":390,"y":220,"wires":[["9bf1aa85.7499c8"]]},{"id":"e0f73ce1.d1e12","type":"server-events","z":"3e9522c6.d11e1e","name":"All Events","server":"144427d5.6c9f18","x":120,"y":260,"wires":[["ded49243.9bbe1"]]},{"id":"ded49243.9bbe1","type":"switch","z":"3e9522c6.d11e1e","name":"Doorbird Doorbell Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_button","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":350,"y":260,"wires":[["9bf1aa85.7499c8"]]},{"id":"9bf1aa85.7499c8","type":"function","z":"3e9522c6.d11e1e","name":"Doorbell to Camera Mapper","func":"var map = {\n    doorbird_back_door_button: \"camera.back_door_live\",\n    doorbird_front_door_button: \"camera.front_door_live\",\n    doorbird_side_entry_button: \"camera.side_entry_live\",\n}\n\nmsg.payload = {\n    entity_id: map[msg.event_type],\n}\n\nmsg.display = 'all';\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":220,"wires":[["78310c2b.3a5c44"]]},{"id":"78310c2b.3a5c44","type":"api-current-state","z":"3e9522c6.d11e1e","name":"Get Camera URL","server":"144427d5.6c9f18","halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"override_payload":false,"override_data":true,"entity_id":"","state_type":"str","outputs":1,"x":1010,"y":380,"wires":[["cb9584e6.66a8b8"]]},{"id":"76b58aa2.4c5024","type":"function","z":"3e9522c6.d11e1e","name":"Alexa Action to Camera/Display Mapper","func":"var map = {\n    \"input_boolean.alexa_show_back_door_office_tv\": {camera: \"camera.back_door_live\", display: \"media_player.office_chromecast\"},\n    \"input_boolean.alexa_show_front_door_office_tv\": {camera: \"camera.front_door_live\", display: \"media_player.office_chromecast\"},\n    \"input_boolean.alexa_show_side_entry_office_tv\": {camera: \"camera.side_entry_live\", display: \"media_player.office_chromecast\"},\n    \"input_boolean.alexa_show_girls_room_office_tv\": {camera: \"camera.girl_s_room\", display: \"media_player.office_chromecast\"},\n    \n    \"input_boolean.alexa_show_back_door_playroom_tv\": {camera: \"camera.back_door_live\", display: \"media_player.playroom_tv_chromecast\"},\n    \"input_boolean.alexa_show_front_door_playroom_tv\": {camera: \"camera.front_door_live\", display: \"media_player.playroom_tv_chromecast\"},\n    \"input_boolean.alexa_show_side_entry_playroom_tv\": {camera: \"camera.side_entry_live\", display: \"media_player.playroom_tv_chromecast\"},\n    \"input_boolean.alexa_show_girls_room_play_room_tv\": {camera: \"camera.girl_s_room\", display: \"media_player.playroom_tv_chromecast\"},\n    \n    \"input_boolean.alexa_show_back_door_living_room_tv\": {camera: \"camera.back_door_live\", display: \"media_player.living_room_chromecast\"},\n    \"input_boolean.alexa_show_front_door_living_room_tv\": {camera: \"camera.front_door_live\", display: \"media_player.living_room_chromecast\"},\n    \"input_boolean.alexa_show_side_entry_living_room_tv\": {camera: \"camera.side_entry_live\", display: \"media_player.living_room_chromecast\"},\n    \"input_boolean.alexa_show_girls_room_living_room_tv\": {camera: \"camera.girl_s_room\", display: \"media_player.living_room_chromecast\"},\n    \n    \n}\n\nmsg.payload = {\n    entity_id: map[msg.topic].camera,\n}\n\nmsg.display = map[msg.topic].display;\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":380,"wires":[["78310c2b.3a5c44"]]},{"id":"a67f2028.5f2d7","type":"switch","z":"3e9522c6.d11e1e","name":"Display Selector","property":"display","propertyType":"msg","rules":[{"t":"neq","v":"all","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":1040,"y":260,"wires":[["c7579c9b.d4f56"],["e1d3a8a0.2ce0f8"]]},{"id":"e1d3a8a0.2ce0f8","type":"api-call-service","z":"3e9522c6.d11e1e","name":"Show Camera on All Displays","server":"144427d5.6c9f18","service_domain":"media_player","service":"play_media","data":"{\"entity_id\":\"media_player.living_room_chromecast, media_player.office_chromecast, media_player.playroom_tv_chromecast, media_player.master_bedroom_tv\",\"media_content_id\":\"https://{{base_url}}/api/camera_proxy_stream/{{data.entity_id}}?token={{data.attributes.access_token}}\",\"media_content_type\":\"image/jpg\"}","render_data":true,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":1390,"y":380,"wires":[["98f435bd.39b668"]]},{"id":"1164957c.f13cdb","type":"comment","z":"3e9522c6.d11e1e","name":"Alexa Requests To Display Cameras","info":"","x":180,"y":340,"wires":[]},{"id":"1d8b2bfb.0655a4","type":"comment","z":"3e9522c6.d11e1e","name":"Display Cameras on Doorbell Ring","info":"","x":180,"y":160,"wires":[]},{"id":"aa990c2c.22912","type":"delay","z":"3e9522c6.d11e1e","name":"Delay","pauseType":"delay","timeout":"300","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1650,"y":300,"wires":[["80d538c4.f9f818"]]},{"id":"98f435bd.39b668","type":"delay","z":"3e9522c6.d11e1e","name":"Delay","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1650,"y":380,"wires":[["80d538c4.f9f818"]]},{"id":"49144431.23101c","type":"switch","z":"47267ef8.fca6f","name":"Filter For State Change","property":"data.new_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.old_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":730,"y":560,"wires":[["d218f7cf.2f4b58"]]},{"id":"48d2989b.427f78","type":"api-call-service","z":"3e9522c6.d11e1e","name":"Stop Camera Stream on Display","server":"144427d5.6c9f18","service_domain":"media_player","service":"turn_off","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":1930,"y":340,"wires":[[]]},{"id":"80d538c4.f9f818","type":"change","z":"3e9522c6.d11e1e","name":"Clean Payload","rules":[{"t":"delete","p":"payload.service","pt":"msg"},{"t":"delete","p":"payload.data.media_content_id","pt":"msg"},{"t":"delete","p":"payload.data.media_content_type","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":300,"wires":[["48d2989b.427f78"]]},{"id":"c7579c9b.d4f56","type":"change","z":"3e9522c6.d11e1e","name":"Set Display Payload","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"display","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":260,"wires":[["8d11fcf7.518b1"]]},{"id":"d3e9619e.931aa","type":"debug","z":"76250bd8.6dba94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":630,"y":80,"wires":[]},{"id":"bfab3a97.d8afc8","type":"function","z":"76250bd8.6dba94","name":"Set Entity ID","func":"msg.payload = {\n    data: {\n        entity_id: msg.topic\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":140,"wires":[["b67a988d.20f518"]]},{"id":"b67a988d.20f518","type":"delay","z":"76250bd8.6dba94","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":580,"y":140,"wires":[["1acdb776.78bf49"]]},{"id":"c7689285.1768f","type":"server-events","z":"51c810f0.59ce1","name":"All Events","server":"144427d5.6c9f18","event_type":"ios.notification_action_fired","x":180,"y":160,"wires":[["62564f22.7c2c4","700b0af3.8487b4"]]},{"id":"62564f22.7c2c4","type":"switch","z":"51c810f0.59ce1","name":"Event Router","property":"payload.event.actionName","propertyType":"msg","rules":[{"t":"eq","v":"CLEAR_TIMER","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":370,"y":160,"wires":[["34401846.8e5518"]]},{"id":"700b0af3.8487b4","type":"debug","z":"51c810f0.59ce1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":350,"y":100,"wires":[]},{"id":"34401846.8e5518","type":"link out","z":"51c810f0.59ce1","name":"iOS Action - Clear Timer","links":["e58f35a3.bd7d48"],"x":535,"y":160,"wires":[]},{"id":"e58f35a3.bd7d48","type":"link in","z":"38894af.7ca61b6","name":"Handler - Reset Door Timer","links":["34401846.8e5518"],"x":375,"y":540,"wires":[["48e55600.7e731c"]]},{"id":"48e55600.7e731c","type":"change","z":"38894af.7ca61b6","name":"Stop Timer Payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":540,"wires":[["4c43add1.d859b4","e6f4f6d4.3f84b8","6a93c010.4eedd","481e307a.623bc","3f6afe29.11be52"]]},{"id":"4cdd2835.d7e4e8","type":"throttle","z":"38894af.7ca61b6","name":"Rate Limit","throttleType":"time","timeLimit":"10","timeLimitType":"seconds","countLimit":"1","blockSize":0,"locked":false,"x":440,"y":180,"wires":[["7fb24f45.2a33d"]]},{"id":"29515c43.e6c2e4","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Both Outside Boundary","rules":[{"t":"false","propertyType":"msg","property":"location.inarea","topic":"owntracks/alydia/iphone"},{"t":"false","propertyType":"msg","property":"location.inarea","topic":"owntracks/matt/iphone"}],"outputTopic":"enable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":690,"y":1120,"wires":[["ece3614.ea4e0a","749067ba.5fbb88","ece3614.ea4e0a"]]},{"id":"1e105fe6.a2415","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Both Inside Boundary","rules":[{"t":"true","propertyType":"msg","property":"location.inarea","topic":"owntracks/alydia/iphone"},{"t":"true","propertyType":"msg","property":"location.inarea","topic":"owntracks/matt/iphone"}],"outputTopic":"disable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":680,"y":1200,"wires":[["75ab2411.56dd7c","50eb3ecc.3739","75ab2411.56dd7c"]]},{"id":"75ab2411.56dd7c","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Extended Away Enabled","rules":[{"t":"eq","v":"on","vt":"str","propertyType":"msg","property":"payload","topic":"input_boolean.extended_away_mode"}],"outputTopic":"disable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":990,"y":1200,"wires":[["ad4b446b.4c9a48","7a4afce1.eceb54"]]},{"id":"ece3614.ea4e0a","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Extended Away Disabled","rules":[{"t":"eq","v":"off","vt":"str","propertyType":"msg","property":"payload","topic":"input_boolean.extended_away_mode"}],"outputTopic":"enable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":990,"y":1120,"wires":[["7a4afce1.eceb54","7f050cdc.10b3d4"]]},{"id":"7f72aca7.f8cdb4","type":"and-gate","z":"30c7e5fd.18228a","name":"TV Idle","rules":[{"t":"eq","v":"idle","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"},{"t":"eq","v":"off","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"}],"outputTopic":"","gateType":"nand","emitOnlyIfTrue":true,"x":630,"y":660,"wires":[["58bf0310.2851bc"]]},{"id":"cad83f8a.f039c","type":"and-gate","z":"30c7e5fd.18228a","name":"TV Is On","rules":[{"t":"neq","v":"unavailable","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"},{"t":"neq","v":"entity could not be found in cache for entity_id: media_player.master_bedroom_tv_chromecast, sending empty payload","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"}],"outputTopic":"","gateType":"and","emitOnlyIfTrue":true,"x":920,"y":660,"wires":[["66621586.db903c"]]},{"id":"1c2e40a4.e1f39f","type":"and-gate","z":"30c7e5fd.18228a","name":"Not Watching TV","rules":[{"t":"eq","v":"playing","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"},{"t":"eq","v":"paused","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"},{"t":"eq","v":"entity could not be found in cache for entity_id: media_player.master_bedroom_tv_chromecast, sending empty payload","vt":"str","propertyType":"msg","property":"payload","topic":"media_player.master_bedroom_tv_chromecast"}],"outputTopic":"","gateType":"nand","emitOnlyIfTrue":true,"x":690,"y":600,"wires":[[]]},{"id":"1751f37c.107a7d","type":"repeat","z":"38894af.7ca61b6","name":"Repeat Notification","repetitions":"4","elseOutput":false,"outputs":1,"x":1210,"y":780,"wires":[["8dbee0f6.087c"]]},{"id":"b2055264.6e15c","type":"repeat","z":"38894af.7ca61b6","name":"Repeat Until Stopped","repetitions":"100000","elseOutput":false,"outputs":1,"x":740,"y":2040,"wires":[["b90ef3c2.e2a1"]]},{"id":"d7724a3.a1d30b8","type":"alexa-local","z":"76250bd8.6dba94","devicename":"Cartoons Playroom","inputtrigger":false,"x":170,"y":300,"wires":[["20829d14.a77f42","1a2a73d0.b6f47c"]]},{"id":"3d25b766.82cee8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1080},\"end\":{\"dow\":1,\"mod\":1095}},{\"start\":{\"dow\":1,\"mod\":1275},\"end\":{\"dow\":1,\"mod\":1290}},{\"start\":{\"dow\":2,\"mod\":1095},\"end\":{\"dow\":2,\"mod\":1110}},{\"start\":{\"dow\":4,\"mod\":1080},\"end\":{\"dow\":4,\"mod\":1095}},{\"start\":{\"dow\":3,\"mod\":1215},\"end\":{\"dow\":3,\"mod\":1230}},{\"start\":{\"dow\":4,\"mod\":1110},\"end\":{\"dow\":4,\"mod\":1125}},{\"start\":{\"dow\":3,\"mod\":1125},\"end\":{\"dow\":3,\"mod\":1155}},{\"start\":{\"dow\":1,\"mod\":1125},\"end\":{\"dow\":1,\"mod\":1170}},{\"start\":{\"dow\":1,\"mod\":1230},\"end\":{\"dow\":1,\"mod\":1245}},{\"start\":{\"dow\":1,\"mod\":1335},\"end\":{\"dow\":1,\"mod\":1365}},{\"start\":{\"dow\":2,\"mod\":1170},\"end\":{\"dow\":2,\"mod\":1200}},{\"start\":{\"dow\":4,\"mod\":1260},\"end\":{\"dow\":4,\"mod\":1275}},{\"start\":{\"dow\":4,\"mod\":1335},\"end\":{\"dow\":4,\"mod\":1350}},{\"start\":{\"dow\":5,\"mod\":1170},\"end\":{\"dow\":5,\"mod\":1200}},{\"start\":{\"dow\":5,\"mod\":1260},\"end\":{\"dow\":5,\"mod\":1275}},{\"start\":{\"dow\":5,\"mod\":1305},\"end\":{\"dow\":5,\"mod\":1320}},{\"start\":{\"dow\":6,\"mod\":1200},\"end\":{\"dow\":6,\"mod\":1215}},{\"start\":{\"dow\":2,\"mod\":1290},\"end\":{\"dow\":2,\"mod\":1305}},{\"start\":{\"dow\":0,\"mod\":1275},\"end\":{\"dow\":0,\"mod\":1290}},{\"start\":{\"dow\":0,\"mod\":1215},\"end\":{\"dow\":0,\"mod\":1230}},{\"start\":{\"dow\":0,\"mod\":1155},\"end\":{\"dow\":0,\"mod\":1185}},{\"start\":{\"dow\":6,\"mod\":1365},\"end\":{\"dow\":6,\"mod\":1380}},{\"start\":{\"dow\":0,\"mod\":1335},\"end\":{\"dow\":0,\"mod\":1350}}]","topic":"light.kitchen_can_lights","name":"Kitchen Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":470,"y":140,"wires":[["9bb5757.d056d88"]]},{"id":"458a451b.4b1efc","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":2,\"mod\":1350},\"end\":{\"dow\":2,\"mod\":1365}},{\"start\":{\"dow\":2,\"mod\":1380},\"end\":{\"dow\":3,\"mod\":0}},{\"start\":{\"dow\":1,\"mod\":1335},\"end\":{\"dow\":2,\"mod\":0}},{\"start\":{\"dow\":3,\"mod\":1365},\"end\":{\"dow\":4,\"mod\":0}},{\"start\":{\"dow\":4,\"mod\":1335},\"end\":{\"dow\":5,\"mod\":0}},{\"start\":{\"dow\":6,\"mod\":1335},\"end\":{\"dow\":0,\"mod\":0}},{\"start\":{\"dow\":0,\"mod\":1320},\"end\":{\"dow\":1,\"mod\":0}},{\"start\":{\"dow\":5,\"mod\":1320},\"end\":{\"dow\":5,\"mod\":1335}},{\"start\":{\"dow\":5,\"mod\":1350},\"end\":{\"dow\":6,\"mod\":0}},{\"start\":{\"dow\":1,\"mod\":0},\"end\":{\"dow\":1,\"mod\":405}},{\"start\":{\"dow\":2,\"mod\":0},\"end\":{\"dow\":2,\"mod\":405}},{\"start\":{\"dow\":3,\"mod\":0},\"end\":{\"dow\":3,\"mod\":390}},{\"start\":{\"dow\":4,\"mod\":0},\"end\":{\"dow\":4,\"mod\":405}},{\"start\":{\"dow\":5,\"mod\":0},\"end\":{\"dow\":5,\"mod\":420}},{\"start\":{\"dow\":6,\"mod\":0},\"end\":{\"dow\":6,\"mod\":420}},{\"start\":{\"dow\":0,\"mod\":0},\"end\":{\"dow\":0,\"mod\":405}}]","topic":"switch.stair_light","name":"Stair Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":480,"y":200,"wires":[["9bb5757.d056d88"]]},{"id":"e37dd587.8c1ba8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1230},\"end\":{\"dow\":1,\"mod\":1290}},{\"start\":{\"dow\":1,\"mod\":1305},\"end\":{\"dow\":1,\"mod\":1335}},{\"start\":{\"dow\":2,\"mod\":1245},\"end\":{\"dow\":2,\"mod\":1320}},{\"start\":{\"dow\":3,\"mod\":1245},\"end\":{\"dow\":3,\"mod\":1305}},{\"start\":{\"dow\":3,\"mod\":1320},\"end\":{\"dow\":3,\"mod\":1335}},{\"start\":{\"dow\":4,\"mod\":1260},\"end\":{\"dow\":4,\"mod\":1290}},{\"start\":{\"dow\":4,\"mod\":1320},\"end\":{\"dow\":4,\"mod\":1350}},{\"start\":{\"dow\":5,\"mod\":1215},\"end\":{\"dow\":5,\"mod\":1335}},{\"start\":{\"dow\":6,\"mod\":1245},\"end\":{\"dow\":6,\"mod\":1305}},{\"start\":{\"dow\":0,\"mod\":1290},\"end\":{\"dow\":0,\"mod\":1335}},{\"start\":{\"dow\":1,\"mod\":1140},\"end\":{\"dow\":1,\"mod\":1155}},{\"start\":{\"dow\":2,\"mod\":1170},\"end\":{\"dow\":2,\"mod\":1185}},{\"start\":{\"dow\":4,\"mod\":1140},\"end\":{\"dow\":4,\"mod\":1155}},{\"start\":{\"dow\":5,\"mod\":1185},\"end\":{\"dow\":5,\"mod\":1200}},{\"start\":{\"dow\":6,\"mod\":1110},\"end\":{\"dow\":6,\"mod\":1125}},{\"start\":{\"dow\":0,\"mod\":1155},\"end\":{\"dow\":0,\"mod\":1170}},{\"start\":{\"dow\":3,\"mod\":1110},\"end\":{\"dow\":3,\"mod\":1125}},{\"start\":{\"dow\":3,\"mod\":1155},\"end\":{\"dow\":3,\"mod\":1170}},{\"start\":{\"dow\":6,\"mod\":1215},\"end\":{\"dow\":6,\"mod\":1230}},{\"start\":{\"dow\":3,\"mod\":1215},\"end\":{\"dow\":3,\"mod\":1230}},{\"start\":{\"dow\":0,\"mod\":1245},\"end\":{\"dow\":0,\"mod\":1260}}]","topic":"switch.master_bedroom_light","name":"Master Bedroom Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":510,"y":260,"wires":[["9bb5757.d056d88"]]},{"id":"dbefdafa.3f9cf8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1095},\"end\":{\"dow\":1,\"mod\":1215}},{\"start\":{\"dow\":2,\"mod\":1125},\"end\":{\"dow\":2,\"mod\":1230}},{\"start\":{\"dow\":3,\"mod\":1095},\"end\":{\"dow\":3,\"mod\":1215}},{\"start\":{\"dow\":4,\"mod\":1080},\"end\":{\"dow\":4,\"mod\":1230}},{\"start\":{\"dow\":6,\"mod\":1095},\"end\":{\"dow\":6,\"mod\":1260}},{\"start\":{\"dow\":0,\"mod\":1155},\"end\":{\"dow\":0,\"mod\":1230}},{\"start\":{\"dow\":5,\"mod\":1110},\"end\":{\"dow\":5,\"mod\":1245}}]","topic":"switch.playroom_can_lights","name":"Playroom Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":490,"y":320,"wires":[["9bb5757.d056d88"]]},{"id":"38d09349.53b57c","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1140},\"end\":{\"dow\":1,\"mod\":1155}},{\"start\":{\"dow\":3,\"mod\":1170},\"end\":{\"dow\":3,\"mod\":1200}},{\"start\":{\"dow\":4,\"mod\":1125},\"end\":{\"dow\":4,\"mod\":1140}},{\"start\":{\"dow\":6,\"mod\":1215},\"end\":{\"dow\":6,\"mod\":1245}}]","topic":"light.living_room_chandelier","name":"Living Room Can Lights","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":490,"y":380,"wires":[["9bb5757.d056d88"]]},{"id":"f8a0cfa9.74bae","type":"light-scheduler","z":"eee3c0c3.7c7bd","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":0},\"end\":{\"dow\":2,\"mod\":0}},{\"start\":{\"dow\":2,\"mod\":0},\"end\":{\"dow\":3,\"mod\":0}},{\"start\":{\"dow\":3,\"mod\":0},\"end\":{\"dow\":4,\"mod\":0}},{\"start\":{\"dow\":4,\"mod\":0},\"end\":{\"dow\":5,\"mod\":0}},{\"start\":{\"dow\":5,\"mod\":0},\"end\":{\"dow\":6,\"mod\":0}},{\"start\":{\"dow\":6,\"mod\":0},\"end\":{\"dow\":0,\"mod\":0}},{\"start\":{\"dow\":0,\"mod\":0},\"end\":{\"dow\":1,\"mod\":0}}]","topic":"","name":"","onPayload":"30","onPayloadType":"str","offPayload":"100","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":"0","sunShowElevationInStatus":true,"outputfreq":"output.statechange.startup","x":200,"y":1480,"wires":[["20c451c1.48de3e","40d1d2bf.0f110c"]]},{"id":"4a1938d5.78ef08","type":"light-scheduler","z":"8d45d5f6.f088e8","settings":"9dba4206.297ed","events":"[]","topic":"","name":"Inside Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":false,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.minutely","x":220,"y":460,"wires":[["993501d3.37c6e"]]},{"id":"385b851a.08fd9a","type":"light-scheduler","z":"8d45d5f6.f088e8","settings":"9dba4206.297ed","events":"[]","topic":"","name":"Outside Light Schedule","onPayload":"1","onPayloadType":"str","offPayload":"0","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":"6","sunShowElevationInStatus":true,"outputfreq":"output.statechange.startup","x":230,"y":120,"wires":[["3663f012.7284c"]]},{"id":"2d8a718d.93454e","type":"string","z":"38894af.7ca61b6","name":"Strip Newlines","methods":[{"name":"strip","params":[{"type":"str","value":"\\n"}]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":1160,"y":1100,"wires":[["88fe746f.c586b8"]]},{"id":"cb9584e6.66a8b8","type":"credentials","z":"3e9522c6.d11e1e","name":"Get Base URL","props":[{"value":"base_url","type":"msg"}],"x":1020,"y":320,"wires":[["a67f2028.5f2d7"]]},{"id":"d5e90594.b099b8","type":"Unifi","z":"cb6f2b8f.2124b8","name":"Get Unifi Site Stats","ip":"192.168.1.9","port":8443,"site":"default","command":"1","x":450,"y":140,"wires":[["28d7951a.afb56a"]]},{"id":"d5fbda02.222b68","type":"server-events","z":"3e9522c6.d11e1e","name":"Front Door Motion Event","server":"144427d5.6c9f18","event_type":"doorbird_front_door_motion","x":170,"y":580,"wires":[["11c940a4.9a3b9f","db5306.0cfc5cf8"]]},{"id":"6babb24d.927d7c","type":"server-events","z":"3e9522c6.d11e1e","name":"Side Entry Motion Event","server":"144427d5.6c9f18","event_type":"doorbird_side_entry_motion","x":160,"y":620,"wires":[["325861e0.b3de7e","db5306.0cfc5cf8"]]},{"id":"6b4236bb.3b6b28","type":"server-events","z":"3e9522c6.d11e1e","name":"Back Door Motion Event","server":"144427d5.6c9f18","event_type":"doorbird_back_door_motion","x":170,"y":660,"wires":[["f7835ff1.b50e7","db5306.0cfc5cf8"]]},{"id":"11c940a4.9a3b9f","type":"http request","z":"3e9522c6.d11e1e","name":"Trigger Event Recording - Front Door","method":"GET","ret":"txt","url":"http://10.7.7.100:8080/qvrpro/apis/logical_input.cgi?token=726ABF0C01AA435EB2B77571A29FE743&name=record_front_door","tls":"","x":670,"y":580,"wires":[[]]},{"id":"f7835ff1.b50e7","type":"http request","z":"3e9522c6.d11e1e","name":"Trigger Event Recording - Back Door","method":"GET","ret":"txt","url":"http://10.7.7.100:8080/qvrpro/apis/logical_input.cgi?token=113851F974364ED08BBF4FEF8C191057&name=record_back_door","tls":"","x":670,"y":660,"wires":[[]]},{"id":"325861e0.b3de7e","type":"http request","z":"3e9522c6.d11e1e","name":"Trigger Event Recording - Side Entry","method":"GET","ret":"txt","url":"http://10.7.7.100:8080/qvrpro/apis/logical_input.cgi?token=2E86BBEA1D7145469B1A84FA6192818E&name=record_side_entry","tls":"","x":670,"y":620,"wires":[[]]},{"id":"473b1925.bec058","type":"inject","z":"3e9522c6.d11e1e","name":"Test Event Triggers","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":540,"wires":[["325861e0.b3de7e","11c940a4.9a3b9f","f7835ff1.b50e7"]]},{"id":"c5863dd6.8bd9f","type":"debug","z":"eee3c0c3.7c7bd","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1271.5,"y":1316,"wires":[]},{"id":"c6f4ae6e.c4fe2","type":"switch","z":"eee3c0c3.7c7bd","name":"Filter Blank Responses","property":"topic","propertyType":"msg","rules":[{"t":"istype","v":"object","vt":"object"},{"t":"eq","v":"OK","vt":"str"},{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":824.5,"y":1621,"wires":[[],[],[],["63cca837.6b1d58"]]},{"id":"58ba3d6e.452774","type":"change","z":"90be6c3f.6407","name":"Alexa Device - Kitchen","rules":[{"t":"set","p":"device","pt":"msg","to":"Kitchen","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":660,"wires":[["f7d31362.4c12a"]]},{"id":"17a5f4ab.a80c8b","type":"mqtt out","z":"90be6c3f.6407","name":"Publish Alexa TTS Notification","topic":"","qos":"0","retain":"false","broker":"1f84a57d.10775b","x":990,"y":580,"wires":[]},{"id":"3fda1b00.a1fa56","type":"inject","z":"b55ab74c.698a88","name":"Reset Timers","topic":"","payload":"STOP","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":349,"y":362,"wires":[["9696479c.1845c8"]]},{"id":"9696479c.1845c8","type":"change","z":"b55ab74c.698a88","name":"Stop Timer Payload","rules":[{"t":"set","p":"reset","pt":"msg","to":"True","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":469,"y":402,"wires":[["ab9ab807.c3ad58","fe960e6c.e95d8","7cb1a4dc.28bdcc"]]},{"id":"68119da7.eca3f4","type":"change","z":"90be6c3f.6407","name":"Alexa Device - Playroom","rules":[{"t":"set","p":"device","pt":"msg","to":"Playroom","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":600,"wires":[["f7d31362.4c12a"]]},{"id":"f7d31362.4c12a","type":"function","z":"90be6c3f.6407","name":"Notification Translator","func":"msg = {\n    topic: 'alexa/tts/' + msg.device,\n    payload: msg.payload.data.message\n}\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":540,"wires":[["17a5f4ab.a80c8b"]]},{"id":"b23a6a41.003758","type":"change","z":"90be6c3f.6407","name":"Alexa Device - Matt's Office","rules":[{"t":"set","p":"device","pt":"msg","to":"Matt's Office","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":500,"wires":[["f7d31362.4c12a"]]},{"id":"708d64a1.c4ee8c","type":"change","z":"90be6c3f.6407","name":"Alexa Device - Master Bedroom","rules":[{"t":"set","p":"device","pt":"msg","to":"Master Bedroom","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":590,"y":440,"wires":[["f7d31362.4c12a"]]},{"id":"c3f1a0c9.06055","type":"change","z":"90be6c3f.6407","name":"Alexa Device - Girls's Room","rules":[{"t":"set","p":"device","pt":"msg","to":"Girl's Room","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":720,"wires":[["f7d31362.4c12a"]]},{"id":"db5306.0cfc5cf8","type":"debug","z":"3e9522c6.d11e1e","name":"Camera Events","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","x":510,"y":700,"wires":[]},{"id":"d3a1039a.3636","type":"comment","z":"3e9522c6.d11e1e","name":"Door Motion Event Recording","info":"","x":180,"y":500,"wires":[]},{"id":"43d0fd7c.0a1544","type":"comment","z":"30c7e5fd.18228a","name":"Sound Machine Off When Bed Vacated","info":"","x":1110,"y":420,"wires":[]},{"id":"8fee7b97.e85098","type":"api-call-service","z":"30c7e5fd.18228a","name":"Master Bedroom Light Off","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_off","data":"{\"entity_id\":\"switch.master_bedroom_light\"}","mergecontext":"","x":430,"y":540,"wires":[[]]},{"id":"9b071567.e41698","type":"api-call-service","z":"30c7e5fd.18228a","name":"Sound Machine On","server":"144427d5.6c9f18","service_domain":"media_player","service":"media_play","data":"{\"entity_id\":\"media_player.master_bedroom_sonos\"}","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":410,"y":460,"wires":[[]]},{"id":"ec212f.1956ded","type":"comment","z":"30c7e5fd.18228a","name":"Master Bedroom Sleep Comfort Settings","info":"","x":240,"y":420,"wires":[]},{"id":"c090c7f6.db91d8","type":"debug","z":"38894af.7ca61b6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":590,"y":1180,"wires":[]},{"id":"20b94728.74eb88","type":"api-call-service","z":"30c7e5fd.18228a","name":"Fan On","server":"144427d5.6c9f18","service_domain":"fan","service":"set_speed","data":"","mergecontext":"","x":940,"y":1000,"wires":[[]]},{"id":"49b04550.611bec","type":"delay","z":"38894af.7ca61b6","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":1020,"wires":[["928ecd6a.39312"]]},{"id":"6f9e1335.37b0ac","type":"mqtt in","z":"90be6c3f.6407","name":"Alexa Status","topic":"alexa/status","qos":"2","broker":"1f84a57d.10775b","x":230,"y":940,"wires":[["70d660f8.728c4"]]},{"id":"70d660f8.728c4","type":"json","z":"90be6c3f.6407","name":"Parse JSON","property":"payload","action":"obj","pretty":false,"x":450,"y":940,"wires":[["8dbd2a70.f94058","d9336747.fb8238"]]},{"id":"8dbd2a70.f94058","type":"switch","z":"90be6c3f.6407","name":"isOffline","property":"payload.status","propertyType":"msg","rules":[{"t":"eq","v":"offline","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":940,"wires":[["457a29d1.b52a48"]]},{"id":"d9336747.fb8238","type":"debug","z":"90be6c3f.6407","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":660,"y":900,"wires":[]},{"id":"55d2946b.89e2fc","type":"debug","z":"47267ef8.fca6f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1250,"y":460,"wires":[]},{"id":"48222eb.b6240d","type":"mqtt in","z":"2061740e.e5207c","name":"Location Updates","topic":"owntracks/alydia/#","qos":"2","broker":"1f84a57d.10775b","x":140,"y":540,"wires":[["cbfc48a9.61e7f8"]]},{"id":"22b385be.4d637a","type":"debug","z":"2061740e.e5207c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":540,"wires":[]},{"id":"cbfc48a9.61e7f8","type":"json","z":"2061740e.e5207c","name":"","property":"payload","action":"","pretty":false,"x":390,"y":540,"wires":[[]]},{"id":"3ed9b5e8.45d60a","type":"comment","z":"38894af.7ca61b6","name":"Doorbird Relay Events","info":"","x":140,"y":1680,"wires":[]},{"id":"4efe0afc.9b3124","type":"server-events","z":"38894af.7ca61b6","name":"All Events","server":"144427d5.6c9f18","event_type":"","x":120,"y":1720,"wires":[["948dcc7d.04e2"]]},{"id":"948dcc7d.04e2","type":"switch","z":"38894af.7ca61b6","name":"Doorbird Relay Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_relay","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":340,"y":1720,"wires":[["b063fa53.89a488","e535ce0d.e1eac"]]},{"id":"b063fa53.89a488","type":"switch","z":"38894af.7ca61b6","name":"Doorbell Selector","property":"event_type","propertyType":"msg","rules":[{"t":"eq","v":"doorbird_front_door_relay","vt":"str"},{"t":"eq","v":"doorbird_back_door_relay","vt":"str"},{"t":"eq","v":"doorbird_side_entry_relay","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":610,"y":1720,"wires":[["56c45731.cc29a8"],["e44d7fc5.c8fa7"],["675e086e.aa44a8"]]},{"id":"56c45731.cc29a8","type":"api-call-service","z":"38894af.7ca61b6","name":"Unlock Front Door","server":"144427d5.6c9f18","service_domain":"lock","service":"unlock","data":"{\"entity_id\":\"lock.front_door\"}","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":890,"y":1680,"wires":[["152743ce.45ad9c"]]},{"id":"e44d7fc5.c8fa7","type":"api-call-service","z":"38894af.7ca61b6","name":"Unlock Back Door","server":"144427d5.6c9f18","service_domain":"lock","service":"unlock","data":"{\"entity_id\":\"lock.back_door\"}","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":890,"y":1720,"wires":[["152743ce.45ad9c"]]},{"id":"675e086e.aa44a8","type":"api-call-service","z":"38894af.7ca61b6","name":"Unlock Side Entry","server":"144427d5.6c9f18","service_domain":"lock","service":"unlock","data":"{\"entity_id\":\"lock.side_entry\"}","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":890,"y":1760,"wires":[["152743ce.45ad9c"]]},{"id":"553988c1.e16418","type":"link out","z":"38894af.7ca61b6","name":"Doorbell Relay Notifications","links":["259dc6d8.29a85a","3ba4aeb7.ee1e12","58dfbc1f.ec9674"],"x":1175,"y":1720,"wires":[]},{"id":"152743ce.45ad9c","type":"function","z":"38894af.7ca61b6","name":"Doorbell Identifier","func":"var map = {\n    doorbird_back_door_relay: \"back door\",\n    doorbird_front_door_relay: \"front door\",\n    doorbird_side_entry_relay: \"side door\",\n}\n\nmsg.data = {\n    door_name: map[msg.event_type]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":1640,"wires":[["7f154ef.c9375b"]]},{"id":"7f154ef.c9375b","type":"function","z":"38894af.7ca61b6","name":"Set Message","func":"doorbellMessages = [\n    'The ' + msg.data.door_name + ' was unlocked via Doorbird app.'\n]\n\nreturn {\n    payload: {\n        data: {\n            message: doorbellMessages[Math.floor(Math.random()*doorbellMessages.length)],\n        }\n    }\n};","outputs":1,"noerr":0,"x":1150,"y":1680,"wires":[["553988c1.e16418"]]},{"id":"e535ce0d.e1eac","type":"debug","z":"38894af.7ca61b6","name":"Doorbell Relay Events","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":640,"y":1800,"wires":[]},{"id":"35565c5c.97fa94","type":"inject","z":"b55ab74c.698a88","name":"Weekend Bedtime Event","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"30 20 * * 5,6","once":false,"onceDelay":0.1,"x":170,"y":260,"wires":[["c69c9e5a.02ca1"]]},{"id":"f285691a.b4da08","type":"mqtt in","z":"2061740e.e5207c","name":"","topic":"gpio/#","qos":"2","broker":"1f84a57d.10775b","x":140,"y":360,"wires":[["5f1059b6.227438"]]},{"id":"5f1059b6.227438","type":"debug","z":"2061740e.e5207c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":330,"y":360,"wires":[]},{"id":"98f079c4.373d6","type":"inject","z":"76250bd8.6dba94","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":360,"wires":[["20829d14.a77f42","1a2a73d0.b6f47c"]]},{"id":"348d34cd.5a22cc","type":"geofence","z":"cb6f2b8f.2124b8","name":"Extended Away Boundary","mode":"circle","inside":"both","rad":254979.93116431482,"points":[],"centre":{"latitude":35.871246850027966,"longitude":-88.76953125},"x":410,"y":1160,"wires":[["29515c43.e6c2e4","1e105fe6.a2415"]]}]