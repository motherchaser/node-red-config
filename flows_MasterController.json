[{"id":"eee3c0c3.7c7bd","type":"tab","label":"Lighting","disabled":false,"info":""},{"id":"38894af.7ca61b6","type":"tab","label":"Safety/Security","disabled":false,"info":""},{"id":"cb6f2b8f.2124b8","type":"tab","label":"Presence","disabled":false,"info":""},{"id":"30c7e5fd.18228a","type":"tab","label":"Climate","disabled":false,"info":""},{"id":"b55ab74c.698a88","type":"tab","label":"Kids","disabled":false,"info":""},{"id":"90be6c3f.6407","type":"tab","label":"Notifications","disabled":false,"info":""},{"id":"47267ef8.fca6f","type":"tab","label":"Media","disabled":false,"info":""},{"id":"2061740e.e5207c","type":"tab","label":"Playground","disabled":false,"info":""},{"id":"76250bd8.6dba94","type":"tab","label":"Alexa Flows","disabled":false,"info":""},{"id":"97047d3e.e8278","type":"tab","label":"Moccupancy","disabled":false,"info":""},{"id":"8a8037b6.4cd318","type":"subflow","name":"Duck Media Player Volume","info":"Requires data.entity_id to be specified.","in":[{"x":80,"y":280,"wires":[{"id":"733ca8f5.3d5bb8"}]}],"out":[{"x":260,"y":280,"wires":[{"id":"8a8037b6.4cd318","port":0}]}]},{"id":"144427d5.6c9f18","type":"server","z":"","name":"Home Assistant (Primary)","url":"http://10.7.7.180:8123","pass":"autom@t10n"},{"id":"d63c16d9.2702d8","type":"server","z":"","name":"Home Assistant (Downstairs)","url":"http://10.7.7.181:8123","pass":"autom@t10n"},{"id":"1f84a57d.10775b","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"NodeRed","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"c5701dd5.a9cea","type":"SSH_Credentials","z":"","host":"10.7.7.15","port":"22","userlabel":"matt@10.7.7.15"},{"id":"c7a2b80.eefc248","type":"google-api-config","z":""},{"id":"bbf0dd11.686ad","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"hass","name":"HASS Data","usetls":false,"tls":""},{"id":"9dba4206.297ed","type":"light-scheduler-settings","z":"","name":"Scheduler Settings","latitude":"35.6946919","longitude":"-88.8753785"},{"id":"210f3ca0.f0ec14","type":"schedex","z":"eee3c0c3.7c7bd","name":"Porch Light Trigger","suspended":false,"lat":"35.67","lon":"-88.82","ontime":"dusk","ontopic":"","onpayload":"turn_on","onoffset":"-30","onrandomoffset":false,"offtime":"22:30","offtopic":"","offpayload":"turn_off","offoffset":"-15","offrandomoffset":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"sun":true,"x":410,"y":120,"wires":[["8d49cec5.ef4d9"]]},{"id":"b2259c64.157f7","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Porch Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"","data":"{\"entity_id\": \"switch.front_porch_light, switch.side_entry_porch_light, switch.garage_outside_light\"}","mergecontext":"","x":830,"y":120,"wires":[[]]},{"id":"9a045e11.88105","type":"inject","z":"eee3c0c3.7c7bd","name":"All Porch Lights Off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":140,"wires":[["210f3ca0.f0ec14"]]},{"id":"d03c0d74.35482","type":"inject","z":"eee3c0c3.7c7bd","name":"All Porch Lights On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":100,"wires":[["210f3ca0.f0ec14"]]},{"id":"c7977616.dfcab8","type":"comment","z":"eee3c0c3.7c7bd","name":"Porch Lights @ Dusk","info":"","x":170,"y":60,"wires":[]},{"id":"8d49cec5.ef4d9","type":"function","z":"eee3c0c3.7c7bd","name":"Select Service","func":"// Trigger doesn't support objects on \n// payload so we move the value provided \n// on msg.payload into msg.service property\n// to be used by the porch light service\n\nmsg.payload = {\n    service: msg.payload\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":120,"wires":[["b2259c64.157f7"]]},{"id":"79f23994.f55e88","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Motion","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.kitchen_motion","entityidfiltertype":"exact","haltifstate":"","x":160,"y":300,"wires":[["eaa62203.5eb83","5ca008f9.ed8408"]]},{"id":"fde46ed4.d372f","type":"api-current-state","z":"eee3c0c3.7c7bd","name":"Light Off?","server":"144427d5.6c9f18","halt_if":"on","entity_id":"light.kitchen_can_lights","x":740,"y":260,"wires":[["72f53a69.cee574"]]},{"id":"4e25ca96.6ca544","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"On","server":"144427d5.6c9f18","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.kitchen_can_lights\"}","mergecontext":"","x":950,"y":320,"wires":[[]]},{"id":"a7d89183.b3723","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Off","server":"144427d5.6c9f18","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.kitchen_can_lights\"}","mergecontext":"","x":950,"y":380,"wires":[[]]},{"id":"8417a2fb.440b1","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Switch Flipped On","server":"144427d5.6c9f18","entityidfilter":"light.kitchen_can_lights","entityidfiltertype":"exact","haltifstate":"off","x":190,"y":360,"wires":[["2bb25d6d.4a14a2"]]},{"id":"5ca008f9.ed8408","type":"time-range-switch","z":"eee3c0c3.7c7bd","name":"After 6AM","lat":"","lon":"","startTime":"06:00","endTime":"23:00","startOffset":"","endOffset":"","x":400,"y":280,"wires":[["fde46ed4.d372f","2bb25d6d.4a14a2"],[]]},{"id":"2bb25d6d.4a14a2","type":"stoptimer","z":"eee3c0c3.7c7bd","duration":"5","units":"Minute","payloadtype":"bool","payloadval":"true","name":"5 Minutes","x":740,"y":320,"wires":[[],["eaa62203.5eb83"]]},{"id":"2f7566a7.1942ba","type":"comment","z":"eee3c0c3.7c7bd","name":"Kitchen Can Lights","info":"","x":170,"y":240,"wires":[]},{"id":"eaa62203.5eb83","type":"traffic","z":"eee3c0c3.7c7bd","name":"Traffic Light","property_allow":"payload","filter_allow":"off","ignore_case_allow":false,"negate_allow":false,"send_allow":false,"property_stop":"payload","filter_stop":"on","ignore_case_stop":false,"negate_stop":false,"send_stop":false,"default_start":true,"differ":false,"x":750,"y":380,"wires":[["a7d89183.b3723"]]},{"id":"6007cb34.ee1bb4","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Switch Flipped On","server":"144427d5.6c9f18","entityidfilter":"light.pantry_led","entityidfiltertype":"exact","haltifstate":"on","x":170,"y":540,"wires":[["5615982.498e668"]]},{"id":"7cc803f5.dd82fc","type":"comment","z":"eee3c0c3.7c7bd","name":"Pantry Shelf LED","info":"","x":160,"y":480,"wires":[]},{"id":"5615982.498e668","type":"stoptimer","z":"eee3c0c3.7c7bd","duration":"5","units":"Minute","payloadtype":"bool","payloadval":"true","name":"5 Minutes","x":420,"y":540,"wires":[[],["48b1fc0f.620214"]]},{"id":"48b1fc0f.620214","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Turn Off Pantry Light","server":"144427d5.6c9f18","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.pantry_led\"}","mergecontext":"","x":680,"y":600,"wires":[[]]},{"id":"ff4c2084.d29e4","type":"server-state-changed","z":"38894af.7ca61b6","name":"Smoke Detected (HASS)","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.smoke_detectors","entityidfiltertype":"exact","haltifstate":"1","x":170,"y":120,"wires":[["4cdd2835.d7e4e8"]]},{"id":"7fb24f45.2a33d","type":"function","z":"38894af.7ca61b6","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"SMOKE DETECTED!\",\n            message: \"Touch to call the Fire Department.\",\n            data: {\n                url: 'tel://555-555-5555',\n                push: {\n                    badge: 911,\n                    sound: \"US-EN-Alexa-Smoke-Detected-Generic.wav\"\n                }\n            }\n        }\n    }\n};","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["5e9d1b86.e677f4"]]},{"id":"4938af0a.ee187","type":"rpi-gpio in","z":"38894af.7ca61b6","name":"Smoke Detector GPIO","pin":"26","intype":"down","debounce":"25","read":false,"x":160,"y":180,"wires":[["4cdd2835.d7e4e8"]]},{"id":"4cdd2835.d7e4e8","type":"throttle","z":"38894af.7ca61b6","name":"Rate Limit","throttleType":"time","timeLimit":"10","timeLimitType":"seconds","countLimit":"1","blockSize":0,"locked":false,"x":440,"y":180,"wires":[["7fb24f45.2a33d"]]},{"id":"a76898ba.169aa8","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":240,"wires":[["4cdd2835.d7e4e8"]]},{"id":"8cccfa11.2a8788","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Pantry Door Opened","server":"d63c16d9.2702d8","entityidfilter":"binary_sensor.pantry_door","entityidfiltertype":"exact","haltifstate":"on","x":170,"y":660,"wires":[["461ee655.9b46c8"]]},{"id":"da6bf586.7c3cf8","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Turn On Pantry Light","server":"144427d5.6c9f18","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.pantry_led\", \"white_value\": 255, \"rgb_color\": [255,255,255], \"transition\": 10}","mergecontext":"","x":680,"y":660,"wires":[[]]},{"id":"a906d294.95b98","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Pantry Door Closed","server":"d63c16d9.2702d8","entityidfilter":"binary_sensor.pantry_door","entityidfiltertype":"exact","haltifstate":"off","x":170,"y":600,"wires":[["48b1fc0f.620214"]]},{"id":"461ee655.9b46c8","type":"delay","z":"eee3c0c3.7c7bd","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":420,"y":660,"wires":[["da6bf586.7c3cf8"]]},{"id":"578277e2.7ff628","type":"comment","z":"eee3c0c3.7c7bd","name":"Office LED","info":"","x":140,"y":1000,"wires":[]},{"id":"74478849.dae958","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Motion On","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.pantry_motion","entityidfiltertype":"exact","haltifstate":"off","x":170,"y":1060,"wires":[["47161a35.c47574","896b0e0a.46232"]]},{"id":"896b0e0a.46232","type":"stoptimer","z":"eee3c0c3.7c7bd","duration":"5","units":"Minute","payloadtype":"bool","payloadval":"true","name":"5 Minutes","x":400,"y":1100,"wires":[[],["ef5dfb7d.116be8"]]},{"id":"47161a35.c47574","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"On","server":"144427d5.6c9f18","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.office_led\", \"white_value\": 255, \"rgb_color\": [0,0,255], \"transition\": 10}","mergecontext":"","x":610,"y":1060,"wires":[[]]},{"id":"ef5dfb7d.116be8","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Off","server":"144427d5.6c9f18","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.office_led\"}","mergecontext":"","x":610,"y":1100,"wires":[[]]},{"id":"d5e90594.b099b8","type":"Unifi","z":"cb6f2b8f.2124b8","name":"Get Unifi Site Stats","ip":"192.168.1.9","port":8443,"site":"default","command":"1","x":450,"y":140,"wires":[["28d7951a.afb56a"]]},{"id":"decad0fb.3b576","type":"inject","z":"cb6f2b8f.2124b8","name":"Guest Check Every 15 Minutes","topic":"","payload":"","payloadType":"date","repeat":"900","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":140,"wires":[["d5e90594.b099b8"]]},{"id":"e62ce7c1.471048","type":"comment","z":"cb6f2b8f.2124b8","name":"Guest Presence Detection","info":"","x":150,"y":100,"wires":[]},{"id":"a96c033f.d25b3","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Guest Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\": \"input_boolean.guest_mode\"}","mergecontext":"","x":900,"y":140,"wires":[["28b8b629.5b9bea"]]},{"id":"21e8b9b3.0eada6","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Guest Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\": \"input_boolean.guest_mode\"}","mergecontext":"","x":900,"y":180,"wires":[["d7481ded.88ee8"]]},{"id":"28d7951a.afb56a","type":"switch","z":"cb6f2b8f.2124b8","name":"hasGuest","property":"payload[0].health[0].num_guest","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":680,"y":160,"wires":[["a96c033f.d25b3"],["52977ef2.02df6","21e8b9b3.0eada6"]]},{"id":"b24a295d.c02f98","type":"comment","z":"38894af.7ca61b6","name":"Smoke Detection","info":"","x":140,"y":80,"wires":[]},{"id":"a8664bea.540808","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Away Mode","info":"","x":120,"y":380,"wires":[]},{"id":"bca95b60.f579d8","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"All Devices","server":"144427d5.6c9f18","entityidfilter":"group.all_devices","entityidfiltertype":"exact","haltifstate":"","x":100,"y":420,"wires":[["fe0b26e5.e10088"]]},{"id":"d0d1c9a1.de7e88","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Away Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\":\"input_boolean.away_mode\"}","mergecontext":"","x":590,"y":440,"wires":[["3878fffd.a7903"]]},{"id":"c3993b0a.7bb2a8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Away Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\":\"input_boolean.away_mode\"}","mergecontext":"","x":600,"y":480,"wires":[["1f97a1fa.e6e93e"]]},{"id":"fe0b26e5.e10088","type":"switch","z":"cb6f2b8f.2124b8","name":"home/not_home","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"not_home","vt":"str"},{"t":"eq","v":"home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":420,"wires":[["d0d1c9a1.de7e88"],["c3993b0a.7bb2a8"]]},{"id":"ce766641.c85848","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","x":130,"y":360,"wires":[["235f5706.9f8788"]]},{"id":"d0151dc8.e8bb","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"DOOR OPENED WHILE AWAY!\",\n            message: msg.doorName + ' is ' + msg.payload + '.',\n        }\n    }\n};","outputs":1,"noerr":0,"x":610,"y":360,"wires":[["ce926406.6f9738"]]},{"id":"6887db2b.5d43f4","type":"comment","z":"38894af.7ca61b6","name":"Door/Gate Opened While Away","info":"","x":190,"y":320,"wires":[]},{"id":"72f53a69.cee574","type":"api-current-state","z":"eee3c0c3.7c7bd","name":"Halt If Away","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"entity_id":"input_boolean.away_mode","x":930,"y":260,"wires":[["4e25ca96.6ca544"]]},{"id":"235f5706.9f8788","type":"switch","z":"38894af.7ca61b6","name":"Halt If Home","property":"away_mode","propertyType":"global","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":350,"y":360,"wires":[["e18b65fc.e57fd8"]]},{"id":"1f97a1fa.e6e93e","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('away_mode', false);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":480,"wires":[[]]},{"id":"3878fffd.a7903","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('away_mode', true);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":440,"wires":[[]]},{"id":"8bbef984.6ef738","type":"server-events","z":"2061740e.e5207c","name":"All Events","server":"144427d5.6c9f18","x":100,"y":180,"wires":[["362d50fe.dbbed","d669aebc.62cfc"]]},{"id":"362d50fe.dbbed","type":"switch","z":"2061740e.e5207c","name":"Doorbird Motion Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_motion","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":160,"wires":[["be835949.460b78"]]},{"id":"ed45b12d.e4937","type":"comment","z":"2061740e.e5207c","name":"Doorbird Automations","info":"","x":140,"y":100,"wires":[]},{"id":"be835949.460b78","type":"time-range-switch","z":"2061740e.e5207c","name":"isNight","lat":"35.67","lon":"-88.82","startTime":"sunset","endTime":"nightEnd","startOffset":0,"endOffset":0,"x":550,"y":180,"wires":[["9922dd52.4b8be"],[]]},{"id":"37b11c64.75dec4","type":"api-call-service","z":"2061740e.e5207c","name":"Turn On Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_on","data":"{\"entity_id\": \"switch.back_porch_light\"}","mergecontext":"","x":820,"y":180,"wires":[[]]},{"id":"209ca413.76181c","type":"function","z":"2061740e.e5207c","name":"Light Mapper","func":"var map = {\n    doorbird_back_door_motion: \"switch.back_porch_light\",\n    doorbird_back_door_doorbell: \"switch.back_porch_light\",\n    // doorbird_front_door_motion: \"switch.front_porch_light\",\n    doorbird_front_door_doorbell: \"switch.front_porch_light\",\n    // doorbird_side_entry_motion: \"switch.side_entry_porch_light\",\n    doorbird_side_entry_doorbell: \"switch.side_entry_porch_light\",\n}\n\nmsg.data = {\n    entity_id: map[msg.event_type]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":120,"wires":[[]]},{"id":"a74366eb.d64108","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Get Away Mode","server":"144427d5.6c9f18","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"input_boolean.away_mode","x":340,"y":320,"wires":[["2d8a0b4b.5de844"]]},{"id":"b81d0c02.18ac4","type":"inject","z":"cb6f2b8f.2124b8","name":"Startup Trigger","topic":"on","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"5","x":120,"y":320,"wires":[["a74366eb.d64108"]]},{"id":"2c3cd45e.e56eec","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Away Mode on Start","info":"","x":150,"y":280,"wires":[]},{"id":"1e484dd6.47e5e2","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode on Start","info":"","x":150,"y":680,"wires":[]},{"id":"36691f72.d39a6","type":"inject","z":"cb6f2b8f.2124b8","name":"Startup Trigger","topic":"on","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"5","x":120,"y":720,"wires":[["6170f9fa.a46ca8"]]},{"id":"6170f9fa.a46ca8","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Get Bed Status","server":"144427d5.6c9f18","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"sensor.bed_either","x":460,"y":620,"wires":[["de244c23.ff033"]]},{"id":"e357f040.cbf8b","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('sleep_mode', true);\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":780,"wires":[[]]},{"id":"5999ad4.be98354","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Bed Occupancy","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_both","entityidfiltertype":"exact","haltifstate":"","x":120,"y":820,"wires":[["de244c23.ff033"]]},{"id":"de244c23.ff033","type":"switch","z":"cb6f2b8f.2124b8","name":"isOccupied?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Occupied","vt":"str"},{"t":"eq","v":"Unoccupied","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":430,"y":820,"wires":[["f2a167c9.c302d8"],["f9aadbef.28b4b8"]]},{"id":"49b9a993.3c8bc8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Sleep Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\":\"input_boolean.sleep_mode\"}","mergecontext":"","x":830,"y":780,"wires":[["e357f040.cbf8b"]]},{"id":"f9aadbef.28b4b8","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Sleep Mode","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\":\"input_boolean.sleep_mode\"}","mergecontext":"","x":640,"y":860,"wires":[["1f3c6634.f6ef4a"]]},{"id":"1f3c6634.f6ef4a","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('sleep_mode', false);\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":860,"wires":[[]]},{"id":"f2a167c9.c302d8","type":"time-range-switch","z":"cb6f2b8f.2124b8","name":"isBedtime?","lat":"","lon":"","startTime":"22:00","endTime":"7:00","startOffset":0,"endOffset":0,"x":610,"y":780,"wires":[["49b9a993.3c8bc8"],[]]},{"id":"9cbc497d.174bc8","type":"schedex","z":"cb6f2b8f.2124b8","name":"Bedtime Trigger","suspended":false,"lat":"","lon":"","ontime":"22:00","ontopic":"","onpayload":"","onoffset":0,"onrandomoffset":0,"offtime":"goldenHour","offtopic":"","offpayload":"","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"sun":true,"x":120,"y":620,"wires":[["6170f9fa.a46ca8"]]},{"id":"cb69900c.75a75","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode at Bedtime","info":"","x":160,"y":580,"wires":[]},{"id":"ef6b11b5.09a0c","type":"comment","z":"cb6f2b8f.2124b8","name":"Set Sleep Mode on Occupancy","info":"","x":170,"y":780,"wires":[]},{"id":"1ffc80e8.bd10cf","type":"comment","z":"eee3c0c3.7c7bd","name":"Inside Lights @ Bedtime","info":"","x":180,"y":760,"wires":[]},{"id":"bfd530b2.f283a","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Sleep Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"off","x":170,"y":800,"wires":[["d26e85b.c424b78","59814c5a.871804"]]},{"id":"604733f.ffb9ecc","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Group - Night Lights Off","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_off","data":"{\"entity_id\": \"group.lights_night_off\"}","mergecontext":"","x":710,"y":800,"wires":[[]]},{"id":"a5c6da26.a437e8","type":"server-state-changed","z":"38894af.7ca61b6","name":"Sleep Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"off","x":150,"y":1020,"wires":[["928ecd6a.39312"]]},{"id":"46fe19a8.293148","type":"comment","z":"38894af.7ca61b6","name":"Lock All Doors on Sleep Mode Enable","info":"","x":210,"y":980,"wires":[]},{"id":"e9cddfe6.fa704","type":"comment","z":"38894af.7ca61b6","name":"Lock All Doors on Away Mode Enable","info":"","x":210,"y":1360,"wires":[]},{"id":"35ddcdcd.f3e962","type":"server-state-changed","z":"38894af.7ca61b6","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"substring","haltifstate":"off","x":150,"y":1400,"wires":[["9dada5c9.04f6f8"]]},{"id":"36ec47a.7ed4bb8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"substring","haltifstate":"off","x":170,"y":140,"wires":[["25b30fb4.e5f2b"]]},{"id":"25b30fb4.e5f2b","type":"stoptimer","z":"30c7e5fd.18228a","duration":"2","units":"Hour","payloadtype":"num","payloadval":"0","name":"Delay 2h","x":600,"y":140,"wires":[["d15821ae.44ebd"],[]]},{"id":"879bca82.99f6f8","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Away Mode Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"substring","haltifstate":"on","x":180,"y":200,"wires":[["3194a548.bd2f1a","e70c9ec7.f71ee"]]},{"id":"3194a548.bd2f1a","type":"change","z":"30c7e5fd.18228a","name":"Stop Timer","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":180,"wires":[["25b30fb4.e5f2b"]]},{"id":"d15821ae.44ebd","type":"api-call-service","z":"30c7e5fd.18228a","name":"Set Ecobee Away","server":"144427d5.6c9f18","service_domain":"climate","service":"set_away_mode","data":"{\"entity_id\": \"climate.laundry\", \"away_mode\": true}","mergecontext":"","x":790,"y":140,"wires":[["ea54b02e.6a60a"]]},{"id":"ea54b02e.6a60a","type":"function","z":"30c7e5fd.18228a","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"Ecobee Away Mode Enabled\",\n            message: \"Save that $$$!\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":1010,"y":140,"wires":[["7e577921.85b078"]]},{"id":"3b2f81e8.6beb3e","type":"comment","z":"30c7e5fd.18228a","name":"Enable Ecobee Away Mode","info":"","x":200,"y":100,"wires":[]},{"id":"e70c9ec7.f71ee","type":"api-call-service","z":"30c7e5fd.18228a","name":"Set Ecobee Home","server":"144427d5.6c9f18","service_domain":"climate","service":"set_away_mode","data":"{\"entity_id\": \"climate.laundry, climate.master, climate.upstairs\", \"away_mode\": false}","mergecontext":"","x":430,"y":240,"wires":[[]]},{"id":"9922dd52.4b8be","type":"api-current-state","z":"2061740e.e5207c","name":"Sleep Mode Active","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"entity_id":"input_boolean.sleep_mode","x":610,"y":120,"wires":[["209ca413.76181c"]]},{"id":"d26e85b.c424b78","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Stair Light On","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_on","data":"{\"entity_id\": \"switch.stair_light\"}","mergecontext":"","x":440,"y":840,"wires":[[]]},{"id":"ab9721bc.57dc","type":"api-call-service","z":"eee3c0c3.7c7bd","name":"Stair Light Off","server":"144427d5.6c9f18","service_domain":"homeassistant","service":"turn_off","data":"{\"entity_id\": \"switch.stair_light\"}","mergecontext":"","x":440,"y":880,"wires":[[]]},{"id":"7390a90b.295908","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Sleep Mode Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"substring","haltifstate":"on","x":180,"y":880,"wires":[["ab9721bc.57dc"]]},{"id":"2d8a0b4b.5de844","type":"switch","z":"cb6f2b8f.2124b8","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":320,"wires":[["3878fffd.a7903"],["1f97a1fa.e6e93e"]]},{"id":"4c43add1.d859b4","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":540,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"2a8e78a8.3a6a48","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"var notificationMessage = 'The ' + msg.doorName + ' has been left open.';\n\nif(msg.payload === 'restored') {\n    notificationMessage = 'The ' + msg.doorName + ' has been closed.';\n}\n\nreturn {\n    payload: {\n        data: {\n            title: \"Door Activity Notification\",\n            message: notificationMessage,\n        }\n    }\n};","outputs":1,"noerr":0,"x":1070,"y":600,"wires":[["f2b70656.597f28"]]},{"id":"5e4eb376.2ae7dc","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Closed","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Open","x":130,"y":640,"wires":[["ba818cf8.be274"]]},{"id":"fea89e0d.500b8","type":"comment","z":"38894af.7ca61b6","name":"Notify If Door/Gate Open > 1m","info":"","x":190,"y":520,"wires":[]},{"id":"ba818cf8.be274","type":"change","z":"38894af.7ca61b6","name":"Stop Timer","rules":[{"t":"set","p":"payload","pt":"msg","to":"STOP","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":680,"wires":[["27fb2179.a7237e"]]},{"id":"27fb2179.a7237e","type":"switch","z":"38894af.7ca61b6","name":"Door Router","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"sensor.front_door_state","vt":"str"},{"t":"eq","v":"sensor.back_door_state","vt":"str"},{"t":"eq","v":"sensor.side_door_state","vt":"str"},{"t":"eq","v":"sensor.north_gate_state","vt":"str"},{"t":"eq","v":"sensor.south_gate_state","vt":"str"}],"checkall":"false","repair":false,"outputs":5,"x":570,"y":620,"wires":[["4c43add1.d859b4"],["e6f4f6d4.3f84b8"],["6a93c010.4eedd"],["481e307a.623bc"],["3f6afe29.11be52"]]},{"id":"e6f4f6d4.3f84b8","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":580,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"6a93c010.4eedd","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":620,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"3cac9dc5.f192f2","type":"link out","z":"38894af.7ca61b6","name":"Utility - Repeat Door Timer","links":["ef97a7a2.bd3d68"],"x":975,"y":660,"wires":[]},{"id":"ef97a7a2.bd3d68","type":"link in","z":"38894af.7ca61b6","name":"Utility - Repeat Door Timer","links":["3cac9dc5.f192f2"],"x":395,"y":720,"wires":[["27fb2179.a7237e"]]},{"id":"53322bd0.9ade94","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":560,"wires":[["2a8e78a8.3a6a48"]]},{"id":"98de7b37.97b938","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Away Mode Enabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"exact","haltifstate":"off","x":130,"y":940,"wires":[["a699be25.15cc9","1679136a.a861ed"]]},{"id":"cf3e3ab9.88a658","type":"comment","z":"cb6f2b8f.2124b8","name":"Notify on Away Mode Enable","info":"","x":160,"y":900,"wires":[]},{"id":"38ab4a04.31f836","type":"function","z":"cb6f2b8f.2124b8","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Away Mode Active\",\n            message: \"You will be notified of any unusual activity.\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":630,"y":940,"wires":[["51f9861c.fb07a8"]]},{"id":"b38d6099.4e13d","type":"inject","z":"cb6f2b8f.2124b8","name":"Test Notification","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":380,"y":1000,"wires":[["38ab4a04.31f836"]]},{"id":"a699be25.15cc9","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Halt If Enabled","server":"144427d5.6c9f18","halt_if":"on","override_topic":false,"override_payload":false,"entity_id":"input_boolean.away_mode","x":380,"y":940,"wires":[["38ab4a04.31f836"]]},{"id":"259dc6d8.29a85a","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Matt","links":["33e0d52f.80feea","51f9861c.fb07a8","5e9d1b86.e677f4","ce926406.6f9738","f087f08a.0264e","f2b70656.597f28","7e577921.85b078","495277d1.51d858","d62da390.c14cc","fb45bc1d.a0ecb"],"x":175,"y":260,"wires":[["5a78366b.a02858"]]},{"id":"3ba4aeb7.ee1e12","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Alydia","links":["ce926406.6f9738","5e9d1b86.e677f4","f087f08a.0264e"],"x":175,"y":300,"wires":[["c781ecd5.f4ab4"]]},{"id":"23f8792a.fb2586","type":"bigssh","z":"2061740e.e5207c","name":"Show Front Door Cam on Macbook Pro","commandLine":"/Applications/VLC.app/Contents/MacOS/VLC \"rtsp://ggzrba0002:tyTS5Agm2v@10.7.7.9:554/mpeg/media.amp\"","commandArgs":"","minError":1,"minWarning":1,"noStdin":true,"format":"ascii","payloadIsArg":false,"myssh":"c5701dd5.a9cea","x":440,"y":680,"wires":[["efa18ebd.07aa2"],["efa18ebd.07aa2"],["efa18ebd.07aa2"]]},{"id":"b2f468d8.6189f8","type":"inject","z":"2061740e.e5207c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":680,"wires":[["23f8792a.fb2586"]]},{"id":"efa18ebd.07aa2","type":"debug","z":"2061740e.e5207c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":760,"y":700,"wires":[]},{"id":"51f9861c.fb07a8","type":"link out","z":"cb6f2b8f.2124b8","name":"Away Mode Enabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":775,"y":940,"wires":[]},{"id":"ce926406.6f9738","type":"link out","z":"38894af.7ca61b6","name":"Door Opened While Away","links":["259dc6d8.29a85a","3ba4aeb7.ee1e12","58dfbc1f.ec9674"],"x":755,"y":360,"wires":[]},{"id":"59814c5a.871804","type":"switch","z":"eee3c0c3.7c7bd","name":"Halt if Guests","property":"sleep_mode","propertyType":"global","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":800,"wires":[["604733f.ffb9ecc"]]},{"id":"33e0d52f.80feea","type":"link out","z":"cb6f2b8f.2124b8","name":"Guest Mode Disabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1075,"y":220,"wires":[]},{"id":"c03ce9cb.bd9d28","type":"function","z":"cb6f2b8f.2124b8","name":"Set Message","func":"return {\n    payload: {\n        data: {\n            title: \"Guest Mode Disabled\",\n            message: \"All guest devices have disconnected from network.\"\n        }\n    }\n};","outputs":1,"noerr":0,"x":930,"y":220,"wires":[["33e0d52f.80feea"]]},{"id":"f2b70656.597f28","type":"link out","z":"38894af.7ca61b6","name":"Door Left Open","links":["259dc6d8.29a85a","26219430.1853ec","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8"],"x":1215,"y":600,"wires":[]},{"id":"1c3c0a96.8b9275","type":"server-state-changed","z":"eee3c0c3.7c7bd","name":"Kitchen Motion Off","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.pantry_motion","entityidfiltertype":"exact","haltifstate":"on","x":170,"y":1140,"wires":[["896b0e0a.46232"]]},{"id":"5a78366b.a02858","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Matt","server":"144427d5.6c9f18","service_domain":"notify","service":"ios_matts_iphone","data":"","mergecontext":"","x":570,"y":260,"wires":[[]]},{"id":"c781ecd5.f4ab4","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Alydia","server":"144427d5.6c9f18","service_domain":"notify","service":"ios_alydias_iphone","data":"{\"title\":\"Matt says...\", \"message\":\"I love you!\"}","mergecontext":"","x":570,"y":300,"wires":[[]]},{"id":"d88ae7ad.72c5b8","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Master Bedroom","links":["9a22ad6f.2b621","9fc4d89a.e1ae38","64f06d3a.c9e534","562a6302.2c4fac","5e9d1b86.e677f4","f2b70656.597f28","fd535219.99971","f087f08a.0264e","495277d1.51d858"],"x":175,"y":400,"wires":[["50853688.ade838"]]},{"id":"5da984d6.acb4bc","type":"api-call-service","z":"90be6c3f.6407","name":"Alexa TTS - Master Bedroom","server":"144427d5.6c9f18","service_domain":"notify","service":"master_bedroom","data":"","mergecontext":"","x":880,"y":400,"wires":[[]]},{"id":"5e9d1b86.e677f4","type":"link out","z":"38894af.7ca61b6","name":"Smoke Detected","links":["259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","5c44608f.94f4c","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8"],"x":895,"y":180,"wires":[]},{"id":"9dada5c9.04f6f8","type":"api-call-service","z":"38894af.7ca61b6","name":"Lock All Doors","server":"144427d5.6c9f18","service_domain":"lock","service":"lock","data":"{\"entity_id\": \"lock.front_door, lock.back_door, lock.garage_entry, lock.side_entry\"}","mergecontext":"","x":420,"y":1400,"wires":[[]]},{"id":"48b0a994.cdacc8","type":"api-call-service","z":"90be6c3f.6407","name":"Alexa TTS - Matt's Office","server":"144427d5.6c9f18","service_domain":"notify","service":"office","data":"","mergecontext":"","x":570,"y":480,"wires":[[]]},{"id":"3c513bc.a5aa8c4","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Matt's Office","links":["495277d1.51d858","5e9d1b86.e677f4","5ff8b930.afc738","f087f08a.0264e","f2b70656.597f28","fd535219.99971"],"x":175,"y":480,"wires":[["151a7d7a.b23d73"]]},{"id":"da1c8d91.ec08b","type":"comment","z":"38894af.7ca61b6","name":"Doorbell Notifications","info":"","x":160,"y":1480,"wires":[]},{"id":"f69a6ad1.9ab428","type":"server-events","z":"38894af.7ca61b6","name":"All Events","server":"144427d5.6c9f18","x":120,"y":1560,"wires":[["fad883e.4f9208"]]},{"id":"fad883e.4f9208","type":"switch","z":"38894af.7ca61b6","name":"Doorbird Doorbell Events","property":"event_type","propertyType":"msg","rules":[{"t":"regex","v":"doorbird_.*_button","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":350,"y":1560,"wires":[["1ef8149b.76ac7b","c5826772.8ebcb8"]]},{"id":"1ef8149b.76ac7b","type":"function","z":"38894af.7ca61b6","name":"Doorbell Identifier","func":"var map = {\n    doorbird_back_door_button: \"back door\",\n    doorbird_front_door_button: \"front door\",\n    doorbird_side_entry_button: \"side door\",\n}\n\nmsg.data = {\n    door_name: map[msg.event_type]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":1560,"wires":[["55feffde.8c42f"]]},{"id":"55feffde.8c42f","type":"function","z":"38894af.7ca61b6","name":"Set Message","func":"doorbellMessages = [\n    'The ' + msg.data.door_name + ' bell has rung.',\n    'Somebody is at the ' + msg.data.door_name,\n    'Somebody requires attention at the ' + msg.data.door_name,\n    'The doorbell has been pressed at the ' + msg.data.door_name\n]\n\nreturn {\n    payload: {\n        data: {\n            message: doorbellMessages[Math.floor(Math.random()*doorbellMessages.length)],\n        }\n    }\n};","outputs":1,"noerr":0,"x":810,"y":1560,"wires":[["fd535219.99971"]]},{"id":"fd535219.99971","type":"link out","z":"38894af.7ca61b6","name":"Doorbell Notifications","links":["26219430.1853ec","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8"],"x":935,"y":1560,"wires":[]},{"id":"1bda4f1a.f1c511","type":"api-call-service","z":"90be6c3f.6407","name":"Alexa TTS - Playroom","server":"144427d5.6c9f18","service_domain":"notify","service":"playroom","data":"","mergecontext":"","x":860,"y":580,"wires":[[]]},{"id":"26219430.1853ec","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Playroom","links":["5ff8b930.afc738","5e9d1b86.e677f4","f2b70656.597f28","fd535219.99971","f087f08a.0264e"],"x":175,"y":580,"wires":[["eefe7058.f2e04"]]},{"id":"704a126f.c1e7bc","type":"inject","z":"90be6c3f.6407","name":"Send Test Message","topic":"","payload":"{\"data\":{\"title\":\"Title Here\",\"message\":\"This is another test.\"}}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":250,"y":80,"wires":[["48b0a994.cdacc8"]]},{"id":"18ef1a18.f12fe6","type":"function","z":"38894af.7ca61b6","name":"Set Sleep Routine Fired","func":"global.set('sleep_routine_fired', true);\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1060,"wires":[[]]},{"id":"d354f7f.00c8d08","type":"server-state-changed","z":"38894af.7ca61b6","name":"Exterior Door Unlocked","server":"144427d5.6c9f18","entityidfilter":"group.exterior_locks","entityidfiltertype":"exact","haltifstate":"locked","x":160,"y":1220,"wires":[["326c2add.6e3806"]]},{"id":"326c2add.6e3806","type":"function","z":"38894af.7ca61b6","name":"Reset Sleep Routine","func":"global.set('sleep_routine_fired', false);\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":1220,"wires":[[]]},{"id":"928ecd6a.39312","type":"switch","z":"38894af.7ca61b6","name":"Halt If Routine Already Executed","property":"sleep_routine_fired","propertyType":"global","rules":[{"t":"false"}],"checkall":"false","repair":false,"outputs":1,"x":410,"y":1020,"wires":[["6049fc74.846f74","18ef1a18.f12fe6"]]},{"id":"7957925.104696c","type":"inject","z":"38894af.7ca61b6","name":"Reset Sleep Routine","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1180,"wires":[["326c2add.6e3806"]]},{"id":"b3ed595e.befc58","type":"comment","z":"38894af.7ca61b6","name":"Reset Sleep Routine","info":"Daily reset allows sleep routine to fire \nagain each night.\n\nResetting on exterior door unlock means \nthe sleep routine will fire again when \ngetting back in bed if a door is unlocked\nafter bedtime.  This should ensure that \ndoors are secured while sleeping.\n\n","x":150,"y":1140,"wires":[]},{"id":"40650875.ee89e8","type":"server-state-changed","z":"38894af.7ca61b6","name":"Both Get Out of Bed","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_either","entityidfiltertype":"exact","haltifstate":"Occupied","x":170,"y":1260,"wires":[["326c2add.6e3806"]]},{"id":"3ce6d3cd.af215c","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","x":350,"y":580,"wires":[["27fb2179.a7237e"]]},{"id":"8bfc1912.cc2258","type":"server-state-changed","z":"38894af.7ca61b6","name":"Door Opened","server":"144427d5.6c9f18","entityidfilter":"door_state","entityidfiltertype":"substring","haltifstate":"Closed","x":130,"y":880,"wires":[["1ff8323a.8d739e"]]},{"id":"6c5d3ea3.f4f51","type":"comment","z":"38894af.7ca61b6","name":"Door Opened While Sleeping","info":"","x":180,"y":820,"wires":[]},{"id":"1ff8323a.8d739e","type":"switch","z":"38894af.7ca61b6","name":"Halt If Sleep Mode Disabled","property":"sleep_mode","propertyType":"global","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":400,"y":860,"wires":[["203d968b.3947ea","e17cd0fc.ec09b"]]},{"id":"203d968b.3947ea","type":"switch","z":"38894af.7ca61b6","name":"Halt If Guest Mode Enabled","property":"guest_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"false","repair":false,"outputs":1,"x":400,"y":900,"wires":[["8d8206b1.6ffa18"]]},{"id":"8d8206b1.6ffa18","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.topic = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":860,"wires":[["fcaa231a.8b616"]]},{"id":"fcaa231a.8b616","type":"template","z":"38894af.7ca61b6","name":"Set Message","field":"message","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Wake up. The {{topic}} has been opened.","output":"str","x":690,"y":900,"wires":[["e09ea359.04e5f"]]},{"id":"e09ea359.04e5f","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"DOOR STILL OPEN!\",\n            message: msg.message,\n        }\n    }\n};","outputs":1,"noerr":0,"x":990,"y":880,"wires":[["9fc4d89a.e1ae38","1751f37c.107a7d"]]},{"id":"9fc4d89a.e1ae38","type":"link out","z":"38894af.7ca61b6","name":"Door Opened While Sleeping","links":["d88ae7ad.72c5b8"],"x":1435,"y":880,"wires":[]},{"id":"12e1ad7d.3633e3","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":800,"wires":[["c672fc66.53c1c"]]},{"id":"c672fc66.53c1c","type":"function","z":"38894af.7ca61b6","name":"Setup Test Notification","func":"return {\n    \"payload\": \"open\",\n    \"topic\": \"sensor.front_door_state\"\n}","outputs":1,"noerr":0,"x":720,"y":800,"wires":[["8d8206b1.6ffa18"]]},{"id":"8dbee0f6.087c","type":"delay","z":"38894af.7ca61b6","name":"Delay 4s","pauseType":"delay","timeout":"4","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1240,"y":840,"wires":[["9fc4d89a.e1ae38","1751f37c.107a7d"]]},{"id":"1751f37c.107a7d","type":"repeat","z":"38894af.7ca61b6","name":"Repeat Notification","repetitions":"4","elseOutput":false,"outputs":1,"x":1210,"y":780,"wires":[["8dbee0f6.087c"]]},{"id":"4ebb31f7.552a2","type":"api-call-service","z":"90be6c3f.6407","name":"Alexa TTS - Kitchen","server":"144427d5.6c9f18","service_domain":"notify","service":"kitchen","data":"","mergecontext":"","x":560,"y":660,"wires":[[]]},{"id":"b5c2d8b0.9a59d8","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Kitchen","links":["5ff8b930.afc738","8644bb39.a50948","5e9d1b86.e677f4","f2b70656.597f28","fd535219.99971","f087f08a.0264e","495277d1.51d858"],"x":175,"y":660,"wires":[["a0a1fab7.33b2c8"]]},{"id":"c8f1ecf8.47595","type":"server-state-changed","z":"38894af.7ca61b6","name":"Water Leak Sensor","server":"144427d5.6c9f18","entityidfilter":"binary_sensor.*leak*","entityidfiltertype":"regex","haltifstate":"","x":150,"y":1760,"wires":[["744bfc94.bf9cb4"]]},{"id":"744bfc94.bf9cb4","type":"switch","z":"38894af.7ca61b6","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":1820,"wires":[["fb2e3c5e.c248"],["5fda46a6.5fbcc8"]]},{"id":"5fda46a6.5fbcc8","type":"change","z":"38894af.7ca61b6","name":"Reset Delay","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1880,"wires":[["b90ef3c2.e2a1"]]},{"id":"fb2e3c5e.c248","type":"function","z":"38894af.7ca61b6","name":"Leak Sensor Locator","func":"var map = {\n    \"binary_sensor.kitchen_leak_sensor\": \"Kitchen\",\n    \"binary_sensor.master_bath_leak_sensor\": \"Master Bathroom\"\n}\n\nmsg.data = {\n    sensor_location: map[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1780,"wires":[["e99dbcd0.6a0e9"]]},{"id":"b90ef3c2.e2a1","type":"delay","z":"38894af.7ca61b6","name":"Delay 60s","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":740,"y":1880,"wires":[["f087f08a.0264e","b2055264.6e15c"]]},{"id":"e99dbcd0.6a0e9","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: 'LEAK DETECTED!',\n            message: \"A leak has been detected in the \" + msg.data.sensor_location,\n        }\n    }\n};","outputs":1,"noerr":0,"x":750,"y":1780,"wires":[["f087f08a.0264e","b2055264.6e15c"]]},{"id":"f087f08a.0264e","type":"link out","z":"38894af.7ca61b6","name":"Leak Detected","links":["19b33134.c89dff","259dc6d8.29a85a","26219430.1853ec","3ba4aeb7.ee1e12","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8"],"x":975,"y":1780,"wires":[]},{"id":"b2055264.6e15c","type":"repeat","z":"38894af.7ca61b6","name":"Repeat Until Stopped","repetitions":"100000","elseOutput":false,"outputs":1,"x":740,"y":1820,"wires":[["b90ef3c2.e2a1"]]},{"id":"b14d8b5.771eb78","type":"comment","z":"38894af.7ca61b6","name":"Water Leak Notifications","info":"","x":170,"y":1680,"wires":[]},{"id":"4254c077.173be","type":"function","z":"b55ab74c.698a88","name":"Set Warning Message","func":"var bedtimeMessages = [\n    'Bedtime is in ' + msg.payload,\n    msg.payload + ' until bedtime.',\n    'Twinkle twinkle little star, bedtime is not that far.',\n    'Bedtime quickly approaches. T-minus ' + msg.payload + ' and counting.',\n    'Time to go potty and get ready for bed. ' + msg.payload + ' until bedtime',\n    'Start getting ready for bed.'\n    ]\n\nreturn {\n    payload: {\n        data: {\n            message: bedtimeMessages[Math.floor(Math.random()*bedtimeMessages.length)]\n        }\n    }\n};","outputs":1,"noerr":0,"x":520,"y":280,"wires":[["5ff8b930.afc738"]]},{"id":"5ff8b930.afc738","type":"link out","z":"b55ab74c.698a88","name":"Bedtime Notifications","links":["26219430.1853ec","3c513bc.a5aa8c4","58dfbc1f.ec9674","5c44608f.94f4c","66e43dcb.363604","b5c2d8b0.9a59d8"],"x":695,"y":420,"wires":[]},{"id":"bf307d39.22105","type":"inject","z":"b55ab74c.698a88","name":"Send 5m Notification","topic":"","payload":"5 minutes","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":100,"wires":[["7f5cdfae.6742f"]]},{"id":"41102c60.d84be4","type":"schedex","z":"b55ab74c.698a88","name":"Weekday - 15 Minute Warning","suspended":false,"lat":"","lon":"","ontime":"20:15","ontopic":"","onpayload":"15 minutes","onoffset":"-15","onrandomoffset":0,"offtime":"20:01","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":false,"sat":false,"sun":true,"x":190,"y":280,"wires":[["7f5cdfae.6742f"]]},{"id":"2602ade9.0c7a92","type":"inject","z":"b55ab74c.698a88","name":"Test Notification","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":580,"wires":[["60adf1c5.97065"]]},{"id":"7ebcb89e.6bbf08","type":"schedex","z":"b55ab74c.698a88","name":"Weekday - Bedtime","suspended":false,"lat":"","lon":"","ontime":"20:15","ontopic":"","onpayload":"","onoffset":"0","onrandomoffset":0,"offtime":"20:16","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":false,"sat":false,"sun":true,"x":230,"y":640,"wires":[["60adf1c5.97065"]]},{"id":"a20fcb6f.79b368","type":"function","z":"b55ab74c.698a88","name":"Set Bedtime Message","func":"var bedtimeMessages = [\n    // 'Ya\\'ll better get yo aaass in the bed!'\n    'It is now bedtime.',\n    '1, 2, 3, it is time to sleep!',\n    'Time to go to sleepytown.',\n    'Guess what time it is. Bedtime.',\n    'Time to get in the bed.',\n    'Bedtime.',\n    'The time has come. It is time to sleep.'\n    ]\n\nreturn {\n    payload: {\n        data: {\n            message: bedtimeMessages[Math.floor(Math.random()*bedtimeMessages.length)]\n        }\n    }\n};","outputs":1,"noerr":0,"x":540,"y":680,"wires":[["5ff8b930.afc738"]]},{"id":"48b0def5.daad6","type":"comment","z":"b55ab74c.698a88","name":"Bedtime Alerts","info":"","x":140,"y":60,"wires":[]},{"id":"68104e6e.7deb4","type":"schedex","z":"b55ab74c.698a88","name":"Weekend - 15 Minute Warning","suspended":false,"lat":"","lon":"","ontime":"20:30","ontopic":"","onpayload":"15 minutes","onoffset":"","onrandomoffset":0,"offtime":"20:31","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":false,"tue":false,"wed":false,"thu":false,"fri":true,"sat":true,"sun":false,"x":190,"y":440,"wires":[["7f5cdfae.6742f"]]},{"id":"132aab07.6dc3d5","type":"schedex","z":"b55ab74c.698a88","name":"Weekend - Bedtime","suspended":false,"lat":"","lon":"","ontime":"20:45","ontopic":"","onpayload":"","onoffset":"0","onrandomoffset":0,"offtime":"20:46","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":false,"tue":false,"wed":false,"thu":false,"fri":true,"sat":true,"sun":false,"x":220,"y":700,"wires":[["60adf1c5.97065"]]},{"id":"34b777c3.70f908","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":1520,"wires":[["b30ba49.231ce58"]]},{"id":"b30ba49.231ce58","type":"function","z":"38894af.7ca61b6","name":"Test Doorbell","func":"msg.event_type = 'doorbird_front_door_button'\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1520,"wires":[["1ef8149b.76ac7b"]]},{"id":"4fd96716.7cdc18","type":"api-call-service","z":"90be6c3f.6407","name":"Alexa TTS - Girl's Room","server":"144427d5.6c9f18","service_domain":"notify","service":"girls_room","data":"","mergecontext":"","x":570,"y":720,"wires":[[]]},{"id":"5c44608f.94f4c","type":"link in","z":"90be6c3f.6407","name":"Alexa TTS - Girl's Room","links":["5ff8b930.afc738","5e9d1b86.e677f4"],"x":175,"y":720,"wires":[["e912df97.1a477"]]},{"id":"7f5cdfae.6742f","type":"switch","z":"b55ab74c.698a88","name":"Block Off Message","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":240,"wires":[["4254c077.173be"]]},{"id":"60adf1c5.97065","type":"switch","z":"b55ab74c.698a88","name":"Block Off Message","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":640,"wires":[["a20fcb6f.79b368"]]},{"id":"f65133f3.e5e14","type":"inject","z":"38894af.7ca61b6","name":"Send Test Notification","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1720,"wires":[["108b40b8.6c91ef"]]},{"id":"108b40b8.6c91ef","type":"function","z":"38894af.7ca61b6","name":"Setup Test Notification","func":"return {\n    \"payload\": \"on\",\n    \"topic\": \"binary_sensor.master_bath_leak_sensor\"\n}","outputs":1,"noerr":0,"x":400,"y":1720,"wires":[["fb2e3c5e.c248"]]},{"id":"821ebb4c.7ccd38","type":"inject","z":"38894af.7ca61b6","name":"Stop Notification Loop","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1880,"wires":[["5fda46a6.5fbcc8"]]},{"id":"50853688.ade838","type":"switch","z":"90be6c3f.6407","name":"Halt If Away","property":"away_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":400,"wires":[["b159a61.0c29c58"]]},{"id":"151a7d7a.b23d73","type":"switch","z":"90be6c3f.6407","name":"Halt If Away","property":"away_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":480,"wires":[["48b0a994.cdacc8"]]},{"id":"eefe7058.f2e04","type":"switch","z":"90be6c3f.6407","name":"Halt If Away","property":"away_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":580,"wires":[["88f43e4a.06933"]]},{"id":"a0a1fab7.33b2c8","type":"switch","z":"90be6c3f.6407","name":"Halt If Away","property":"away_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":660,"wires":[["4ebb31f7.552a2"]]},{"id":"e912df97.1a477","type":"switch","z":"90be6c3f.6407","name":"Halt If Away","property":"away_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":720,"wires":[["4fd96716.7cdc18"]]},{"id":"1679136a.a861ed","type":"debug","z":"cb6f2b8f.2124b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":320,"y":1080,"wires":[]},{"id":"f9949ea.3e53b6","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Away Mode Toggled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.away_mode","entityidfiltertype":"exact","haltifstate":"","x":130,"y":500,"wires":[["df4f125c.8e5da"]]},{"id":"df4f125c.8e5da","type":"switch","z":"cb6f2b8f.2124b8","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":500,"wires":[["d0d1c9a1.de7e88"],["c3993b0a.7bb2a8"]]},{"id":"5e48cb98.0d30f4","type":"api-call-service","z":"90be6c3f.6407","name":"WebOS - Playroom TV","server":"144427d5.6c9f18","service_domain":"notify","service":"playroom_tv","data":"","mergecontext":"","x":560,"y":180,"wires":[[]]},{"id":"66e43dcb.363604","type":"link in","z":"90be6c3f.6407","name":"WebOS - Playroom TV","links":["5e9d1b86.e677f4","5ff8b930.afc738","f087f08a.0264e","f2b70656.597f28","fd535219.99971","495277d1.51d858","d62da390.c14cc"],"x":175,"y":180,"wires":[["5e48cb98.0d30f4"]]},{"id":"c5826772.8ebcb8","type":"debug","z":"38894af.7ca61b6","name":"Doorbell Events","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":450,"y":1620,"wires":[]},{"id":"c691f098.a2ad3","type":"comment","z":"cb6f2b8f.2124b8","name":"Fan On When Bed Occupied","info":"","x":160,"y":1160,"wires":[]},{"id":"fc914128.6525c","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Bed Occupied","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_either","entityidfiltertype":"exact","haltifstate":"","x":110,"y":1200,"wires":[["272464bd.eb17bc"]]},{"id":"fb33e213.a1032","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Fan On","server":"144427d5.6c9f18","service_domain":"fan","service":"set_speed","data":"{\"entity_id\": \"fan.master_bedroom_fan_level\", \"speed\":\"high\"}","mergecontext":"","x":480,"y":1200,"wires":[[]]},{"id":"272464bd.eb17bc","type":"switch","z":"cb6f2b8f.2124b8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Occupied","vt":"str"},{"t":"eq","v":"Unoccupied","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":1200,"wires":[["fb33e213.a1032"],["4edff025.e9534"]]},{"id":"4edff025.e9534","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Fan Off","server":"144427d5.6c9f18","service_domain":"fan","service":"turn_off","data":"{\"entity_id\": \"fan.master_bedroom_fan_level\"}","mergecontext":"","x":480,"y":1240,"wires":[[]]},{"id":"a6b8de31.02fb5","type":"schedex","z":"b55ab74c.698a88","name":"Weekday - 10 Minute Warning","suspended":false,"lat":"","lon":"","ontime":"20:15","ontopic":"","onpayload":"10 minutes","onoffset":"-10","onrandomoffset":0,"offtime":"20:01","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":false,"sat":false,"sun":true,"x":190,"y":320,"wires":[["7f5cdfae.6742f"]]},{"id":"a00557ec.05f7b8","type":"schedex","z":"b55ab74c.698a88","name":"Weekday - 5 Minute Warning","suspended":false,"lat":"","lon":"","ontime":"20:15","ontopic":"","onpayload":"5 minutes","onoffset":"-5","onrandomoffset":0,"offtime":"20:01","offtopic":"","offpayload":"off","offoffset":0,"offrandomoffset":0,"mon":true,"tue":true,"wed":true,"thu":true,"fri":false,"sat":false,"sun":true,"x":200,"y":360,"wires":[["7f5cdfae.6742f"]]},{"id":"8feb21dc.83c88","type":"inject","z":"b55ab74c.698a88","name":"Send 10m Notification","topic":"","payload":"10 minutes","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":140,"wires":[["7f5cdfae.6742f"]]},{"id":"a457c08e.2f5d7","type":"inject","z":"b55ab74c.698a88","name":"Send 15m Notification","topic":"","payload":"15 minutes","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":180,"wires":[["7f5cdfae.6742f"]]},{"id":"b10cd235.4e338","type":"api-call-service","z":"90be6c3f.6407","name":"Push Notification - Matt Browser","server":"144427d5.6c9f18","service_domain":"notify","service":"browser_push","data":"","mergecontext":"","x":600,"y":220,"wires":[[]]},{"id":"eb4a90c8.9c286","type":"mqtt in","z":"2061740e.e5207c","name":"All MQTT","topic":"media/#","qos":"2","broker":"1f84a57d.10775b","x":120,"y":860,"wires":[["24d70e68.65b4d2"]]},{"id":"24d70e68.65b4d2","type":"debug","z":"2061740e.e5207c","name":"MQTT Messages","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":310,"y":860,"wires":[]},{"id":"2d1abd58.41aef2","type":"comment","z":"47267ef8.fca6f","name":"Master Bedroom Lights Off On Media Start","info":"","x":260,"y":140,"wires":[]},{"id":"5dd403a2.c90a5c","type":"server-state-changed","z":"47267ef8.fca6f","name":"Master Bedroom Media State","server":"144427d5.6c9f18","entityidfilter":"media_player.master_bedroom_tv_chromecast","entityidfiltertype":"exact","haltifstate":"","x":220,"y":200,"wires":[["716735dc.665acc"]]},{"id":"716735dc.665acc","type":"switch","z":"47267ef8.fca6f","name":"State Router","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":500,"y":200,"wires":[["9a965b9f.858768"]]},{"id":"8002ffa.6b70b","type":"api-call-service","z":"47267ef8.fca6f","name":"Turn Off Lights","server":"144427d5.6c9f18","service_domain":"switch","service":"turn_off","data":"{\"entity_id\": \"switch.master_bedroom_light\"}","mergecontext":"","x":960,"y":200,"wires":[[]]},{"id":"9a965b9f.858768","type":"api-current-state","z":"47267ef8.fca6f","name":"Halt If Lights Off","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"entity_id":"switch.master_bedroom_light","x":720,"y":200,"wires":[["8002ffa.6b70b"]]},{"id":"80420cd7.0f748","type":"server-state-changed","z":"47267ef8.fca6f","name":"Bed Unoccupied","server":"144427d5.6c9f18","entityidfilter":"sensor.bed_both","entityidfiltertype":"exact","haltifstate":"Occupied","x":180,"y":380,"wires":[["3269d216.98a64e"]]},{"id":"c7e9e280.455c2","type":"comment","z":"47267ef8.fca6f","name":"Pause Media On Bed Unoccupied","info":"","x":240,"y":320,"wires":[]},{"id":"3269d216.98a64e","type":"api-call-service","z":"47267ef8.fca6f","name":"Pause Playback","server":"144427d5.6c9f18","service_domain":"media_player","service":"media_pause","data":"{\"entity_id\": \"media_player.master_bedroom_tv_chromecast\"}","mergecontext":"","x":480,"y":380,"wires":[[]]},{"id":"3de70af1.74dee6","type":"subflow:8a8037b6.4cd318","z":"90be6c3f.6407","name":"","x":580,"y":600,"wires":[["1bda4f1a.f1c511"]]},{"id":"88f43e4a.06933","type":"change","z":"90be6c3f.6407","name":"Select Media Player","rules":[{"t":"set","p":"data","pt":"msg","to":"{\"entity_id\":\"media_player.playroom_tv\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":560,"wires":[["3de70af1.74dee6"]]},{"id":"b159a61.0c29c58","type":"change","z":"90be6c3f.6407","name":"Select Media Player","rules":[{"t":"set","p":"data","pt":"msg","to":"{\"entity_id\":\"media_player.master_bedroom_tv_chromecast\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":380,"wires":[["72af5c4e.b1b644"]]},{"id":"72af5c4e.b1b644","type":"subflow:8a8037b6.4cd318","z":"90be6c3f.6407","x":580,"y":420,"wires":[["5da984d6.acb4bc"]]},{"id":"58dfbc1f.ec9674","type":"link in","z":"90be6c3f.6407","name":"Push Notification - Matt Browser","links":["33e0d52f.80feea","51f9861c.fb07a8","5e9d1b86.e677f4","5ff8b930.afc738","9a22ad6f.2b621","ce926406.6f9738","f087f08a.0264e","f2b70656.597f28","fd535219.99971","7e577921.85b078","64f06d3a.c9e534","562a6302.2c4fac","495277d1.51d858","d62da390.c14cc","fb45bc1d.a0ecb"],"x":175,"y":220,"wires":[["b10cd235.4e338"]]},{"id":"52977ef2.02df6","type":"switch","z":"cb6f2b8f.2124b8","name":"Halt If Not Enabled","property":"guest_mode","propertyType":"global","rules":[{"t":"eq","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":710,"y":220,"wires":[["c03ce9cb.bd9d28"]]},{"id":"fe8a2860.cb7c18","type":"api-call-service","z":"8a8037b6.4cd318","name":"Set Media Player Volume","server":"144427d5.6c9f18","service_domain":"media_player","service":"volume_set","data":"{\"volume_level\":0.075,\"entity_id\":\"media_player.playroom_tv\"}","mergecontext":"","x":1110,"y":280,"wires":[[]]},{"id":"bb392bb8.d861b8","type":"delay","z":"8a8037b6.4cd318","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":340,"wires":[["fe8a2860.cb7c18"]]},{"id":"955d8757.0e1f28","type":"api-current-state","z":"8a8037b6.4cd318","name":"Get Current Volume","server":"144427d5.6c9f18","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"{\"entity_id\": \"\"}","x":450,"y":340,"wires":[["14e04453.08f7dc","7b492e98.307a6"]]},{"id":"14e04453.08f7dc","type":"function","z":"8a8037b6.4cd318","name":"Calculate Ducked Level","func":"var newmsg = {\n    payload: {\n        data: {\n            volume_level: Math.round((msg.data.attributes.volume_level / 2) * 100) / 100,\n            entity_id: msg.topic\n        }\n    }\n}\n\nreturn newmsg;\n\n","outputs":1,"noerr":0,"x":730,"y":280,"wires":[["fe8a2860.cb7c18"]]},{"id":"7b492e98.307a6","type":"function","z":"8a8037b6.4cd318","name":"Original Level","func":"var newmsg = {\n    payload: {\n        data: {\n            volume_level: msg.data.attributes.volume_level,\n            entity_id: msg.topic\n        }\n    }\n}\n\nreturn newmsg;","outputs":1,"noerr":0,"x":700,"y":340,"wires":[["bb392bb8.d861b8"]]},{"id":"733ca8f5.3d5bb8","type":"change","z":"8a8037b6.4cd318","name":"Transformer","rules":[{"t":"set","p":"payload","pt":"msg","to":"data","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":230,"y":340,"wires":[["955d8757.0e1f28"]]},{"id":"7e577921.85b078","type":"link out","z":"30c7e5fd.18228a","name":"","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1195,"y":140,"wires":[]},{"id":"a3ac2d3b.2c0f9","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Opened","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","haltifstate":"Closed","x":130,"y":400,"wires":[["235f5706.9f8788","f70858b5.5dbb38"]]},{"id":"1af46f8.fc92591","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Opened","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","haltifstate":"Closed","x":350,"y":620,"wires":[["27fb2179.a7237e"]]},{"id":"7559f0fd.8e122","type":"server-state-changed","z":"38894af.7ca61b6","name":"Gate Closed","server":"144427d5.6c9f18","entityidfilter":"gate_state","entityidfiltertype":"substring","haltifstate":"Open","x":130,"y":680,"wires":[["ba818cf8.be274"]]},{"id":"481e307a.623bc","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":660,"wires":[["3cac9dc5.f192f2","53322bd0.9ade94"],[]]},{"id":"3f6afe29.11be52","type":"stoptimer","z":"38894af.7ca61b6","duration":"1","units":"Minute","payloadtype":"num","payloadval":"0","name":"1m Timer","x":760,"y":700,"wires":[["53322bd0.9ade94","3cac9dc5.f192f2"],[]]},{"id":"a19da4bf.c32108","type":"switch","z":"38894af.7ca61b6","name":"Unlocked Doors Found","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"All doors are locked.  Good night.","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":710,"y":1060,"wires":[["2d0655d0.300cda","326c2add.6e3806"]]},{"id":"6049fc74.846f74","type":"api-render-template","z":"38894af.7ca61b6","name":"Door Lock Status Message","server":"144427d5.6c9f18","template":"{% if is_state(\"lock.front_door\", \"locked\") and\n      is_state(\"lock.back_door\", \"locked\") and\n      is_state(\"lock.side_entry\", \"locked\") and\n      is_state(\"lock.garage_entry\", \"locked\") -%}\nAll doors are locked.  Good night.\n  \n{%- else -%} \n    {% set unlockedCount = 0 %}\n  \n  {%- if is_state(\"lock.front_door\", \"unlocked\") -%}\nThe front door is unlocked.\n    {% set unlockedCount = unlockedCount + 1 %}\n  {%- endif %}\n\n  {%- if is_state(\"lock.back_door\", \"unlocked\") -%}\nThe back door is unlocked.\n    {% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n\n  {%- if is_state(\"lock.garage_entry\", \"unlocked\") -%}\nThe garage door is unlocked.\n    {% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n\n  {%- if is_state(\"lock.side_entry\", \"unlocked\") -%}\nThe side entry door is unlocked.\n    {% set unlockedCount = unlockedCount + 1 %}\n\n  {%- endif %}\n  \n  {% if unlockedCount > 1 -%}\nAttempting to secure all doors now.\n  {%- else -%}\nAttempting to secure it now.\n  {%- endif %}\n  \n{%- endif %}","x":700,"y":1020,"wires":[["a19da4bf.c32108","2d8a718d.93454e"]]},{"id":"88fe746f.c586b8","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"// switch (msg.topic) {\n//     case ''\n// }\n\nreturn {\n    payload: {\n        data: {\n            message: msg.payload,\n        }\n    }\n};","outputs":1,"noerr":0,"x":1030,"y":1100,"wires":[["562a6302.2c4fac"]]},{"id":"2d0655d0.300cda","type":"api-call-service","z":"38894af.7ca61b6","name":"Lock All Doors","server":"144427d5.6c9f18","service_domain":"lock","service":"lock","data":"{\"entity_id\": \"lock.front_door, lock.back_door, lock.garage_entry, lock.side_entry\"}","mergecontext":"","x":740,"y":1100,"wires":[["12647560.d49ceb"]]},{"id":"12647560.d49ceb","type":"delay","z":"38894af.7ca61b6","name":"Delay","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":770,"y":1140,"wires":[["f3f50736.7dd2a8"]]},{"id":"eacd1413.2dac18","type":"api-render-template","z":"38894af.7ca61b6","name":"Door Lock Status Message","server":"144427d5.6c9f18","template":"{% if is_state(\"lock.front_door\", \"locked\") and\n      is_state(\"lock.back_door\", \"locked\") and\n      is_state(\"lock.side_entry\", \"locked\") and\n      is_state(\"lock.garage_entry\", \"locked\") -%}\n  I was able to secure all doors. Good night.\n{%- else -%} \n\n  {%- if is_state(\"lock.front_door\", \"unlocked\") -%}\n    I was unable to lock the front door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.back_door\", \"unlocked\") -%}\n    I was unable to lock the back door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.garage_entry\", \"unlocked\") -%}\n    I was unable to lock the garage door.\n  {%- endif %}\n\n  {%- if is_state(\"lock.side_entry\", \"unlocked\") -%}\n    I was unable to lock the side entry door.\n  {%- endif %}\n  \n  Please double check the door to make sure it is secure.\n  \n{%- endif %}","x":1060,"y":1020,"wires":[["2d8a718d.93454e"]]},{"id":"562a6302.2c4fac","type":"link out","z":"38894af.7ca61b6","name":"Door Lock Status @ Sleep Mode Enabled","links":["58dfbc1f.ec9674","d88ae7ad.72c5b8"],"x":1235,"y":1100,"wires":[]},{"id":"2d8a718d.93454e","type":"string","z":"38894af.7ca61b6","name":"Strip Newlines","methods":[{"name":"strip","params":[{"type":"str","value":"\\n"}]}],"prop":"payload","propout":"payload","object":"msg","objectout":"msg","x":1020,"y":1060,"wires":[["88fe746f.c586b8"]]},{"id":"f3f50736.7dd2a8","type":"function","z":"38894af.7ca61b6","name":"Clear Template","func":"\nreturn {};","outputs":1,"noerr":0,"x":1020,"y":980,"wires":[["eacd1413.2dac18"]]},{"id":"8458fde1.e55c2","type":"inject","z":"38894af.7ca61b6","name":"Test Notification","topic":"sensor.north_gate_state","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":740,"y":500,"wires":[["53322bd0.9ade94"]]},{"id":"415944b6.2ede6c","type":"server-state-changed","z":"76250bd8.6dba94","name":"Alydia Location Request","server":"144427d5.6c9f18","entityidfilter":"input_boolean.alexa_alydia_location","entityidfiltertype":"exact","haltifstate":"off","x":180,"y":280,"wires":[["6925313d.1bbb7"]]},{"id":"6e95caf5.aec004","type":"debug","z":"76250bd8.6dba94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":750,"y":320,"wires":[]},{"id":"1934d9bb.5fe796","type":"server-state-changed","z":"76250bd8.6dba94","name":"Reset Alexa Handler Input","server":"144427d5.6c9f18","entityidfilter":"input_boolean.alexa_","entityidfiltertype":"substring","haltifstate":"off","x":190,"y":140,"wires":[["1acdb776.78bf49"]]},{"id":"1acdb776.78bf49","type":"api-call-service","z":"76250bd8.6dba94","name":"Reset Alexa Input","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"","mergecontext":"","x":470,"y":140,"wires":[[]]},{"id":"660b5707.cac9f8","type":"comment","z":"76250bd8.6dba94","name":"Reset Trigger for All Flows","info":"Immediately turns off the boolean input from\nHome Assistant when triggered since action is\nonly taken when switched on.","x":190,"y":100,"wires":[]},{"id":"6925313d.1bbb7","type":"api-current-state","z":"76250bd8.6dba94","name":"Get Location","server":"144427d5.6c9f18","halt_if":"","override_topic":true,"override_payload":true,"entity_id":"device_tracker.alydia_iphone","x":510,"y":320,"wires":[["cb344841.50c7c8","6e95caf5.aec004"]]},{"id":"40a2b85e.5e36a8","type":"inject","z":"76250bd8.6dba94","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":520,"wires":[["35e2f45c.ce993c"]]},{"id":"8fcb92f1.1606c","type":"debug","z":"76250bd8.6dba94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":730,"y":520,"wires":[]},{"id":"b024b06.1a4dd5","type":"google geocoding","z":"76250bd8.6dba94","name":"Get Location","geocodeBy":"coordinates","address":"","lat":"","lon":"","googleAPI":"c7a2b80.eefc248","bounds":"","language":"","region":"","components":"","x":530,"y":400,"wires":[["8fcb92f1.1606c"]]},{"id":"cb344841.50c7c8","type":"change","z":"76250bd8.6dba94","name":"Transform Payload","rules":[{"t":"set","p":"location.lat","pt":"msg","to":"data.attributes.latitude","tot":"msg"},{"t":"set","p":"location.lon","pt":"msg","to":"data.attributes.longitude","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":360,"wires":[["b024b06.1a4dd5"]]},{"id":"35e2f45c.ce993c","type":"google directions","z":"76250bd8.6dba94","name":"Alydia Commute","googleAPI":"c7a2b80.eefc248","origin":"16 Starlight Cove, Jackson, TN","destination":"601 Skyline, Jackson, TN","mode":"driving","waypoints":"","alternatives":true,"avoid":"","language":"","units":"","region":"","departure_time":"","arrival_time":"","transit_mode":"","transit_routing_preferences":"","x":510,"y":520,"wires":[["8fcb92f1.1606c"]]},{"id":"495277d1.51d858","type":"link out","z":"38894af.7ca61b6","name":"Gate Notifications","links":["259dc6d8.29a85a","3c513bc.a5aa8c4","58dfbc1f.ec9674","66e43dcb.363604","b5c2d8b0.9a59d8","d88ae7ad.72c5b8"],"x":755,"y":440,"wires":[]},{"id":"63e6c9e.2c38738","type":"function","z":"38894af.7ca61b6","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Gate Opened\",\n            message: msg.doorName + ' has been opened.',\n        }\n    }\n};","outputs":1,"noerr":0,"x":610,"y":440,"wires":[["495277d1.51d858"]]},{"id":"e18b65fc.e57fd8","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":320,"wires":[["d0151dc8.e8bb"]]},{"id":"f70858b5.5dbb38","type":"function","z":"38894af.7ca61b6","name":"Door Namer","func":"var doorNames = {\n    'sensor.front_door_state': 'Front Door',\n    'sensor.back_door_state': 'Back Door',\n    'sensor.side_door_state': 'Side Door',\n    'sensor.south_gate_state': 'South Gate',\n    'sensor.north_gate_state': 'North Gate'\n}\n\nif(doorNames.hasOwnProperty(msg.topic)) {\n    msg.doorName = doorNames[msg.topic]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":400,"wires":[["63e6c9e.2c38738"]]},{"id":"3354f114.5ef42e","type":"stoptimer","z":"2061740e.e5207c","duration":"5","units":"Second","payloadtype":"num","payloadval":"0","name":"1m Timer","x":440,"y":320,"wires":[["9540818b.086f3"],["c1dfa2f0.f1286"]]},{"id":"83567b24.054138","type":"inject","z":"2061740e.e5207c","name":"Stop Timer","topic":"STOP","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":320,"wires":[["3354f114.5ef42e"]]},{"id":"88f6636a.9eb14","type":"inject","z":"2061740e.e5207c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":380,"wires":[["3354f114.5ef42e"]]},{"id":"9540818b.086f3","type":"debug","z":"2061740e.e5207c","name":"Primary","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":620,"y":320,"wires":[]},{"id":"c1dfa2f0.f1286","type":"debug","z":"2061740e.e5207c","name":"Secondary","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":630,"y":380,"wires":[]},{"id":"b7483f4b.2adac","type":"exec","z":"90be6c3f.6407","command":"/home/homeassistant/.homeassistant/ha-alexa-tts/alexa_remote_control.sh -a;","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":true,"name":"Verify Alexa Auth","x":450,"y":920,"wires":[["4b1c07a.dddaff8"],["4b1c07a.dddaff8"],["3d584059.d1633","4b1c07a.dddaff8"]]},{"id":"b55b409b.98b61","type":"inject","z":"90be6c3f.6407","name":"Trigger","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"*/30 8-19 * * *","once":true,"onceDelay":0.1,"x":240,"y":920,"wires":[["b7483f4b.2adac"]]},{"id":"3d584059.d1633","type":"switch","z":"90be6c3f.6407","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":920,"wires":[["457a29d1.b52a48"]]},{"id":"457a29d1.b52a48","type":"function","z":"90be6c3f.6407","name":"Build Notification","func":"return {\n    payload: {\n        data: {\n            title: \"Alexa Requires Attention\",\n            message: \"There was an error listing Alexa devices.  TTS notifications may not work.\",\n        }\n    }\n};","outputs":1,"noerr":0,"x":850,"y":920,"wires":[["d62da390.c14cc"]]},{"id":"d62da390.c14cc","type":"link out","z":"90be6c3f.6407","name":"Alexa Auth Notifications","links":["259dc6d8.29a85a","58dfbc1f.ec9674","66e43dcb.363604"],"x":1015,"y":920,"wires":[]},{"id":"490c4db9.f33e64","type":"comment","z":"90be6c3f.6407","name":"Verify Alexa TTS Is Working","info":"","x":280,"y":880,"wires":[]},{"id":"e17cd0fc.ec09b","type":"debug","z":"38894af.7ca61b6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":600,"y":960,"wires":[]},{"id":"14bddbf6.45d814","type":"server-state-changed","z":"cb6f2b8f.2124b8","name":"Away Mode Toggled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.guest_mode","entityidfiltertype":"exact","haltifstate":"","x":450,"y":80,"wires":[["f922cc98.e6869"]]},{"id":"f922cc98.e6869","type":"switch","z":"cb6f2b8f.2124b8","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":950,"y":80,"wires":[["28b8b629.5b9bea"],["d7481ded.88ee8"]]},{"id":"28b8b629.5b9bea","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('guest_mode', true);\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":80,"wires":[[]]},{"id":"d7481ded.88ee8","type":"function","z":"cb6f2b8f.2124b8","name":"Set Global","func":"global.set('guest_mode', false);\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":120,"wires":[[]]},{"id":"e6e01a43.bfc978","type":"debug","z":"2061740e.e5207c","name":"All Events","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":380,"y":220,"wires":[]},{"id":"d669aebc.62cfc","type":"switch","z":"2061740e.e5207c","name":"","property":"event_type","propertyType":"msg","rules":[{"t":"eq","v":"test_event","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":240,"y":220,"wires":[["e6e01a43.bfc978"]]},{"id":"a7624a49.06c6e8","type":"influxdb in","z":"2061740e.e5207c","influxdb":"bbf0dd11.686ad","name":"","query":"select * from measurements","rawOutput":false,"precision":"","retentionPolicy":"","x":440,"y":520,"wires":[["1cdef36b.892a3d"]]},{"id":"8c1b81b5.9d25d","type":"inject","z":"2061740e.e5207c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":520,"wires":[["a7624a49.06c6e8"]]},{"id":"1cdef36b.892a3d","type":"debug","z":"2061740e.e5207c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":540,"wires":[]},{"id":"3d25b766.82cee8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1080},\"end\":{\"dow\":1,\"mod\":1095}},{\"start\":{\"dow\":1,\"mod\":1275},\"end\":{\"dow\":1,\"mod\":1290}},{\"start\":{\"dow\":2,\"mod\":1095},\"end\":{\"dow\":2,\"mod\":1110}},{\"start\":{\"dow\":4,\"mod\":1080},\"end\":{\"dow\":4,\"mod\":1095}},{\"start\":{\"dow\":3,\"mod\":1215},\"end\":{\"dow\":3,\"mod\":1230}},{\"start\":{\"dow\":4,\"mod\":1110},\"end\":{\"dow\":4,\"mod\":1125}},{\"start\":{\"dow\":3,\"mod\":1125},\"end\":{\"dow\":3,\"mod\":1155}},{\"start\":{\"dow\":1,\"mod\":1125},\"end\":{\"dow\":1,\"mod\":1170}},{\"start\":{\"dow\":1,\"mod\":1230},\"end\":{\"dow\":1,\"mod\":1245}},{\"start\":{\"dow\":1,\"mod\":1335},\"end\":{\"dow\":1,\"mod\":1365}},{\"start\":{\"dow\":2,\"mod\":1170},\"end\":{\"dow\":2,\"mod\":1200}},{\"start\":{\"dow\":4,\"mod\":1260},\"end\":{\"dow\":4,\"mod\":1275}},{\"start\":{\"dow\":4,\"mod\":1335},\"end\":{\"dow\":4,\"mod\":1350}},{\"start\":{\"dow\":5,\"mod\":1170},\"end\":{\"dow\":5,\"mod\":1200}},{\"start\":{\"dow\":5,\"mod\":1260},\"end\":{\"dow\":5,\"mod\":1275}},{\"start\":{\"dow\":5,\"mod\":1305},\"end\":{\"dow\":5,\"mod\":1320}},{\"start\":{\"dow\":6,\"mod\":1200},\"end\":{\"dow\":6,\"mod\":1215}},{\"start\":{\"dow\":2,\"mod\":1290},\"end\":{\"dow\":2,\"mod\":1305}},{\"start\":{\"dow\":0,\"mod\":1275},\"end\":{\"dow\":0,\"mod\":1290}},{\"start\":{\"dow\":0,\"mod\":1215},\"end\":{\"dow\":0,\"mod\":1230}},{\"start\":{\"dow\":0,\"mod\":1155},\"end\":{\"dow\":0,\"mod\":1185}},{\"start\":{\"dow\":6,\"mod\":1365},\"end\":{\"dow\":6,\"mod\":1380}},{\"start\":{\"dow\":0,\"mod\":1335},\"end\":{\"dow\":0,\"mod\":1350}}]","topic":"light.kitchen_can_lights","name":"Kitchen Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":470,"y":140,"wires":[["9bb5757.d056d88"]]},{"id":"4b1c07a.dddaff8","type":"debug","z":"90be6c3f.6407","name":"Alexa Command Verification","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":690,"y":1000,"wires":[]},{"id":"c9f72f6.4fa52d","type":"api-call-service","z":"97047d3e.e8278","name":"Light Service","server":"144427d5.6c9f18","service_domain":"","service":"","data":"","mergecontext":"","x":1730,"y":300,"wires":[[]]},{"id":"458a451b.4b1efc","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":2,\"mod\":1350},\"end\":{\"dow\":2,\"mod\":1365}},{\"start\":{\"dow\":2,\"mod\":1380},\"end\":{\"dow\":3,\"mod\":0}},{\"start\":{\"dow\":1,\"mod\":1335},\"end\":{\"dow\":2,\"mod\":0}},{\"start\":{\"dow\":3,\"mod\":1365},\"end\":{\"dow\":4,\"mod\":0}},{\"start\":{\"dow\":4,\"mod\":1335},\"end\":{\"dow\":5,\"mod\":0}},{\"start\":{\"dow\":6,\"mod\":1335},\"end\":{\"dow\":0,\"mod\":0}},{\"start\":{\"dow\":0,\"mod\":1320},\"end\":{\"dow\":1,\"mod\":0}},{\"start\":{\"dow\":5,\"mod\":1320},\"end\":{\"dow\":5,\"mod\":1335}},{\"start\":{\"dow\":5,\"mod\":1350},\"end\":{\"dow\":6,\"mod\":0}},{\"start\":{\"dow\":1,\"mod\":0},\"end\":{\"dow\":1,\"mod\":405}},{\"start\":{\"dow\":2,\"mod\":0},\"end\":{\"dow\":2,\"mod\":405}},{\"start\":{\"dow\":3,\"mod\":0},\"end\":{\"dow\":3,\"mod\":390}},{\"start\":{\"dow\":4,\"mod\":0},\"end\":{\"dow\":4,\"mod\":405}},{\"start\":{\"dow\":5,\"mod\":0},\"end\":{\"dow\":5,\"mod\":420}},{\"start\":{\"dow\":6,\"mod\":0},\"end\":{\"dow\":6,\"mod\":420}},{\"start\":{\"dow\":0,\"mod\":0},\"end\":{\"dow\":0,\"mod\":405}}]","topic":"switch.stair_light","name":"Stair Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":480,"y":200,"wires":[["9bb5757.d056d88"]]},{"id":"9bb5757.d056d88","type":"function","z":"97047d3e.e8278","name":"Build Service Payload","func":"if(msg.payload == 'ON') {\n    var service = 'turn_on';\n} else {\n    var service = 'turn_off';\n}\n\nvar domain = msg.topic.split('.')[0];\n\nreturn { \n        payload:{\n            domain: domain,\n            service: service,\n            data: {\n                entity_id: msg.topic\n            }\n        }\n    };","outputs":1,"noerr":0,"x":800,"y":260,"wires":[["e4410f0c.79f2f"]]},{"id":"88870d79.b0355","type":"inject","z":"97047d3e.e8278","name":"On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":200,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"ffbdb800.cbb2b8","type":"inject","z":"97047d3e.e8278","name":"Off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":240,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"b3976b49.6c3848","type":"inject","z":"97047d3e.e8278","name":"Auto","topic":"","payload":"auto","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":280,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"e37dd587.8c1ba8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1230},\"end\":{\"dow\":1,\"mod\":1290}},{\"start\":{\"dow\":1,\"mod\":1305},\"end\":{\"dow\":1,\"mod\":1335}},{\"start\":{\"dow\":2,\"mod\":1275},\"end\":{\"dow\":2,\"mod\":1320}},{\"start\":{\"dow\":3,\"mod\":1260},\"end\":{\"dow\":3,\"mod\":1305}},{\"start\":{\"dow\":3,\"mod\":1320},\"end\":{\"dow\":3,\"mod\":1335}},{\"start\":{\"dow\":4,\"mod\":1260},\"end\":{\"dow\":4,\"mod\":1275}},{\"start\":{\"dow\":4,\"mod\":1335},\"end\":{\"dow\":4,\"mod\":1365}},{\"start\":{\"dow\":5,\"mod\":1275},\"end\":{\"dow\":5,\"mod\":1320}},{\"start\":{\"dow\":6,\"mod\":1260},\"end\":{\"dow\":6,\"mod\":1335}},{\"start\":{\"dow\":0,\"mod\":1275},\"end\":{\"dow\":0,\"mod\":1290}},{\"start\":{\"dow\":0,\"mod\":1320},\"end\":{\"dow\":0,\"mod\":1350}}]","topic":"switch.master_bedroom_light","name":"Bedroom Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":490,"y":260,"wires":[["9bb5757.d056d88"]]},{"id":"dbefdafa.3f9cf8","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1095},\"end\":{\"dow\":1,\"mod\":1245}},{\"start\":{\"dow\":2,\"mod\":1125},\"end\":{\"dow\":2,\"mod\":1260}},{\"start\":{\"dow\":3,\"mod\":1095},\"end\":{\"dow\":3,\"mod\":1230}},{\"start\":{\"dow\":4,\"mod\":1080},\"end\":{\"dow\":4,\"mod\":1260}},{\"start\":{\"dow\":6,\"mod\":1095},\"end\":{\"dow\":6,\"mod\":1260}},{\"start\":{\"dow\":0,\"mod\":1155},\"end\":{\"dow\":0,\"mod\":1230}},{\"start\":{\"dow\":5,\"mod\":1110},\"end\":{\"dow\":5,\"mod\":1245}}]","topic":"switch.playroom_can_lights","name":"Playroom Light Schedule","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":490,"y":320,"wires":[["9bb5757.d056d88"]]},{"id":"38d09349.53b57c","type":"light-scheduler","z":"97047d3e.e8278","settings":"9dba4206.297ed","events":"[{\"start\":{\"dow\":1,\"mod\":1140},\"end\":{\"dow\":1,\"mod\":1155}},{\"start\":{\"dow\":3,\"mod\":1170},\"end\":{\"dow\":3,\"mod\":1200}},{\"start\":{\"dow\":4,\"mod\":1125},\"end\":{\"dow\":4,\"mod\":1140}},{\"start\":{\"dow\":6,\"mod\":1215},\"end\":{\"dow\":6,\"mod\":1245}}]","topic":"light.living_room_chandelier","name":"Living Room Can Lights","onPayload":"ON","onPayloadType":"str","offPayload":"OFF","offPayloadType":"str","onlyWhenDark":true,"sunElevationThreshold":6,"sunShowElevationInStatus":false,"outputfreq":"output.statechange.startup","x":490,"y":380,"wires":[["9bb5757.d056d88"]]},{"id":"5943794e.0d5bf8","type":"inject","z":"97047d3e.e8278","name":"Stop","topic":"","payload":"stop","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"0.5","x":190,"y":320,"wires":[["3d25b766.82cee8","458a451b.4b1efc","e37dd587.8c1ba8","dbefdafa.3f9cf8","38d09349.53b57c"]]},{"id":"b78e0fc9.3e897","type":"api-current-state","z":"97047d3e.e8278","name":"Halt If Not Extended Away","server":"144427d5.6c9f18","halt_if":"off","override_topic":false,"override_payload":false,"entity_id":"input_boolean.extended_away_mode","x":980,"y":360,"wires":[["ecac5170.bfe1e"]],"icon":"node-red/alert.png"},{"id":"c7403459.3e5a18","type":"comment","z":"cb6f2b8f.2124b8","name":"Extended Away Mode","info":"","x":120,"y":1340,"wires":[]},{"id":"96c5b3f6.7f2d9","type":"mqtt in","z":"cb6f2b8f.2124b8","name":"Owntracks Location Update","topic":"owntracks/+/iphone","qos":"2","broker":"1f84a57d.10775b","x":140,"y":1400,"wires":[["6b7cfac6.419554"]]},{"id":"8674d28e.fc59b","type":"geofence","z":"cb6f2b8f.2124b8","name":"Extended Away Boundary","mode":"circle","inside":"both","rad":255254.7395282678,"points":[],"centre":{"latitude":35.712510430860604,"longitude":-88.83750915527344},"x":390,"y":1440,"wires":[["29515c43.e6c2e4","1e105fe6.a2415"]]},{"id":"4335ef50.9a556","type":"json","z":"cb6f2b8f.2124b8","name":"","property":"payload","action":"","pretty":false,"x":190,"y":1440,"wires":[["8674d28e.fc59b"]]},{"id":"29515c43.e6c2e4","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Both Outside Boundary","rules":[{"t":"false","propertyType":"msg","property":"location.inarea","topic":"owntracks/alydia/iphone"},{"t":"false","propertyType":"msg","property":"location.inarea","topic":"owntracks/matt/iphone"}],"outputTopic":"enable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":670,"y":1380,"wires":[["ece3614.ea4e0a","749067ba.5fbb88"]]},{"id":"1e105fe6.a2415","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Both Inside Boundary","rules":[{"t":"true","propertyType":"msg","property":"location.inarea","topic":"owntracks/alydia/iphone"},{"t":"true","propertyType":"msg","property":"location.inarea","topic":"owntracks/matt/iphone"}],"outputTopic":"disable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":660,"y":1500,"wires":[["75ab2411.56dd7c","50eb3ecc.3739"]]},{"id":"fb45bc1d.a0ecb","type":"link out","z":"cb6f2b8f.2124b8","name":"Extended Away Mode Enabled","links":["259dc6d8.29a85a","58dfbc1f.ec9674"],"x":1375,"y":1440,"wires":[]},{"id":"7a4afce1.eceb54","type":"function","z":"cb6f2b8f.2124b8","name":"Build Notification","func":"if (msg.topic == 'enable_extended_away') {\n    msg = {\n        payload: {\n            data: {\n                title: \"Extended Away Mode Active\",\n                message: \"Enjoy your trip!\"\n            }\n        }\n    }\n}\n\nif (msg.topic == 'disable_extended_away') {\n        msg = {\n        payload: {\n            data: {\n                title: \"Extended Away Mode Disabled\",\n                message: \"Welcome Back!\"\n            }\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":1440,"wires":[["fb45bc1d.a0ecb"]]},{"id":"6b7cfac6.419554","type":"delay","z":"cb6f2b8f.2124b8","name":"Startup Delay","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":1400,"wires":[["4335ef50.9a556"]]},{"id":"ad4b446b.4c9a48","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Disable Extended Away","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_off","data":"{\"entity_id\": \"input_boolean.extended_away_mode\"}","mergecontext":"","x":1250,"y":1500,"wires":[[]]},{"id":"75ab2411.56dd7c","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Extended Away Enabled","rules":[{"t":"eq","v":"on","vt":"str","propertyType":"msg","property":"payload","topic":"input_boolean.extended_away_mode"}],"outputTopic":"disable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":970,"y":1500,"wires":[["ad4b446b.4c9a48","7a4afce1.eceb54"]]},{"id":"b70c233a.4f3e1","type":"server-state-changed","z":"30c7e5fd.18228a","name":"Extended Away Disabled","server":"144427d5.6c9f18","entityidfilter":"input_boolean.extended_away_mode","entityidfiltertype":"exact","haltifstate":"on","x":190,"y":280,"wires":[["e70c9ec7.f71ee"]]},{"id":"ece3614.ea4e0a","type":"and-gate","z":"cb6f2b8f.2124b8","name":"Extended Away Disabled","rules":[{"t":"eq","v":"off","vt":"str","propertyType":"msg","property":"payload","topic":"input_boolean.extended_away_mode"}],"outputTopic":"enable_extended_away","gateType":"and","emitOnlyIfTrue":true,"x":970,"y":1380,"wires":[["7a4afce1.eceb54","7f050cdc.10b3d4"]]},{"id":"7f050cdc.10b3d4","type":"api-call-service","z":"cb6f2b8f.2124b8","name":"Enable Extended Away","server":"144427d5.6c9f18","service_domain":"input_boolean","service":"turn_on","data":"{\"entity_id\": \"input_boolean.extended_away_mode\"}","mergecontext":"","x":1250,"y":1380,"wires":[[]]},{"id":"f6fe513a.1dd42","type":"debug","z":"97047d3e.e8278","name":"Light Service Debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1520,"y":360,"wires":[]},{"id":"e4410f0c.79f2f","type":"delay","z":"97047d3e.e8278","name":"Startup Delay","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":300,"wires":[["b78e0fc9.3e897","3c1e70cc.56031"]]},{"id":"749067ba.5fbb88","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Extended Away Current State","server":"144427d5.6c9f18","halt_if":"on","override_topic":true,"override_payload":true,"entity_id":"input_boolean.extended_away_mode","x":690,"y":1320,"wires":[["ece3614.ea4e0a","1d3d9563.e1ef3b"]]},{"id":"50eb3ecc.3739","type":"api-current-state","z":"cb6f2b8f.2124b8","name":"Extended Away Current State","server":"144427d5.6c9f18","halt_if":"off","override_topic":true,"override_payload":true,"entity_id":"input_boolean.extended_away_mode","x":690,"y":1560,"wires":[["75ab2411.56dd7c"]]},{"id":"1d3d9563.e1ef3b","type":"debug","z":"cb6f2b8f.2124b8","name":"Away State","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":970,"y":1440,"wires":[]},{"id":"ecac5170.bfe1e","type":"and-gate","z":"97047d3e.e8278","name":"Halt If Extended Away Disabled","rules":[{"t":"eq","v":"on","vt":"str","propertyType":"msg","property":"payload","topic":"input_boolean.extended_away_mode"}],"outputTopic":"","gateType":"and","emitOnlyIfTrue":true,"x":1290,"y":300,"wires":[["f6fe513a.1dd42","5623456b.fc134c"]]},{"id":"3c1e70cc.56031","type":"delay","z":"97047d3e.e8278","name":"Randomize","pauseType":"random","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"300","randomUnits":"seconds","drop":false,"x":1030,"y":300,"wires":[["ecac5170.bfe1e"]]},{"id":"5623456b.fc134c","type":"switch","z":"97047d3e.e8278","name":"Discard Strings","property":"payload","propertyType":"msg","rules":[{"t":"istype","v":"object","vt":"object"}],"checkall":"true","repair":false,"outputs":1,"x":1540,"y":300,"wires":[["c9f72f6.4fa52d"]]}]